
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../xv6lab-baremetal/">
      
      
        <link rel="next" href="../xv6lab-contextswitch/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Week 4 - 陷入与中断 Trap & Interrupts - 操作系统实验文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-header__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            操作系统实验文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Week 4 - 陷入与中断 Trap & Interrupts
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../env/" class="md-tabs__link">
          
  
  实验环境搭建

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab1/" class="md-tabs__link">
          
  
  每周实验

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../laben/lab2/" class="md-tabs__link">
          
  
  Weekly Lab Material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qrh/nav/" class="md-tabs__link">
          
  
  快速参考手册

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-nav__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    操作系统实验文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    实验环境搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            实验环境搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux VM 搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Linux VM 搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/windows-vmware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + VMware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/wsl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + WSL (不推荐)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS + VMware
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    手动环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    验证环境
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    每周实验
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            每周实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 1 - Linux基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C 语言基础及Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - 裸机程序 Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#exceptional-control-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptional Control Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exceptions-traps-and-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptions, Traps, and Interrupts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#csr-mstatussstatus" class="md-nav__link">
    <span class="md-ellipsis">
      CSR: mstatus/sstatus
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trap" class="md-nav__link">
    <span class="md-ellipsis">
      Trap 相关寄存器：
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trap 相关寄存器：">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stvec" class="md-nav__link">
    <span class="md-ellipsis">
      stvec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scause" class="md-nav__link">
    <span class="md-ellipsis">
      scause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sie-sip" class="md-nav__link">
    <span class="md-ellipsis">
      sie &amp; sip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sepc" class="md-nav__link">
    <span class="md-ellipsis">
      sepc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stval" class="md-nav__link">
    <span class="md-ellipsis">
      stval
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      硬件处理流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="硬件处理流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trap_1" class="md-nav__link">
    <span class="md-ellipsis">
      进入 Trap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sret" class="md-nav__link">
    <span class="md-ellipsis">
      sret
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interrupt" class="md-nav__link">
    <span class="md-ellipsis">
      什么时候能处理 Interrupt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trap-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Trap Handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trap Handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      中断向量
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interrupt_1" class="md-nav__link">
    <span class="md-ellipsis">
      Interrupt
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interrupt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      时钟中断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plic-platform-level-interrupt-controller" class="md-nav__link">
    <span class="md-ellipsis">
      PLIC (Platform-Level Interrupt Controller)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PLIC (Platform-Level Interrupt Controller)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plic" class="md-nav__link">
    <span class="md-ellipsis">
      PLIC 结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-mapped-register" class="md-nav__link">
    <span class="md-ellipsis">
      Memory-Mapped Register
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#claim-complete" class="md-nav__link">
    <span class="md-ellipsis">
      Claim &amp; Complete
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - 上下文切换 Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - 内核页表 Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - 用户空间 Userspace
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Weekly Lab Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Weekly Lab Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C language basic & Makefile
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    快速参考手册
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            快速参考手册
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/nav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/vf2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VisionFive2 板子教程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/ssh-vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH & VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#exceptional-control-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptional Control Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exceptions-traps-and-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptions, Traps, and Interrupts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#csr-mstatussstatus" class="md-nav__link">
    <span class="md-ellipsis">
      CSR: mstatus/sstatus
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trap" class="md-nav__link">
    <span class="md-ellipsis">
      Trap 相关寄存器：
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trap 相关寄存器：">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stvec" class="md-nav__link">
    <span class="md-ellipsis">
      stvec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scause" class="md-nav__link">
    <span class="md-ellipsis">
      scause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sie-sip" class="md-nav__link">
    <span class="md-ellipsis">
      sie &amp; sip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sepc" class="md-nav__link">
    <span class="md-ellipsis">
      sepc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stval" class="md-nav__link">
    <span class="md-ellipsis">
      stval
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      硬件处理流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="硬件处理流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trap_1" class="md-nav__link">
    <span class="md-ellipsis">
      进入 Trap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sret" class="md-nav__link">
    <span class="md-ellipsis">
      sret
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interrupt" class="md-nav__link">
    <span class="md-ellipsis">
      什么时候能处理 Interrupt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trap-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Trap Handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trap Handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      中断向量
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interrupt_1" class="md-nav__link">
    <span class="md-ellipsis">
      Interrupt
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interrupt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      时钟中断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plic-platform-level-interrupt-controller" class="md-nav__link">
    <span class="md-ellipsis">
      PLIC (Platform-Level Interrupt Controller)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PLIC (Platform-Level Interrupt Controller)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plic" class="md-nav__link">
    <span class="md-ellipsis">
      PLIC 结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-mapped-register" class="md-nav__link">
    <span class="md-ellipsis">
      Memory-Mapped Register
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#claim-complete" class="md-nav__link">
    <span class="md-ellipsis">
      Claim &amp; Complete
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="_1">中断 &amp; 异常处理<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<div class="admonition info">
<p class="admonition-title">推荐阅读</p>
<p>CSAPP, Chapter 8, Exceptional Control Flow.</p>
<p><a href="https://csapp.cs.cmu.edu/2e/ch8-preview.pdf">https://csapp.cs.cmu.edu/2e/ch8-preview.pdf</a></p>
</div>
<h2 id="exceptional-control-flow">Exceptional Control Flow<a class="headerlink" href="#exceptional-control-flow" title="Permanent link">&para;</a></h2>
<p>在正常的程序运行状态下，控制流 (可以认为是 pc 指针的序列) 是按照程序所预定的顺序一步步执行的。但是，操作系统不可避免地需要处理一些在“预定之外的”情况，例如程序出错、或者外部状态有所改变，比如有数据包抵达网卡、用户敲击键盘等事件。现代操作系统通过改变控制流来处理这些事件，我们将这种控制流称为 Exceptional Control Flow (异常控制流)。</p>
<h2 id="exceptions-traps-and-interrupts">Exceptions, Traps, and Interrupts<a class="headerlink" href="#exceptions-traps-and-interrupts" title="Permanent link">&para;</a></h2>
<p>在 RISC-V 体系架构中，我们将 Exception (异常)、Trap (陷阱) 和 Interrupt (中断) 定义如下：</p>
<ul>
<li>Exception: 一种不寻常的情况，出现在指令执行的时刻。</li>
<li>Interrupt: 一种外部的事件，与当前 RISC-V 核心指令执行是异步的。</li>
<li>Trap: 一种同步的、由于异常导致的控制流转移。我们可以将 Trap 认为是对 Exception 和 Interrupt 的处理行为。</li>
</ul>
<div class="admonition info">
<p class="admonition-title">什么是同步/异步 (Synchronous / Asynchronous)</p>
<p>回想在数字逻辑课程上实现的单周期 RISC-V CPU，我们有时钟信号 clk，每(n)个时钟周期执行一条指令。</p>
<p>同步的异常是由于指令执行时产生的，所以异常的产生是与 clk 对齐的；而异步的异常则完全与当前指令、clk无关。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/sync-async.png" /></p>
</div>
<p>所以，很显然为什么 Trap 所指的控制流转移是“同步”的：我们起码需要等待时钟周期来临才能进行控制流转移。</p>
<p>We use the term <strong>exception</strong> to refer to an unusual condition occurring at run time associated with an instruction in the current RISC-V thread.
We use the term <strong>trap</strong> to refer to the synchronous transfer of control to a trap handler caused by an exceptional condition occurring within a RISC-V thread.
Trap handlers usually execute in a more privileged environment.</p>
<p>We use the term <strong>interrupt</strong> to refer to an external event that occurs asynchronously to the current RISC-V thread.
When an interrupt that must be serviced occurs, some instruction is selected to receive an interrupt exception and subsequently experiences a trap.</p>
<p>Source: riscv-spec-v2.1.pdf, Section 1.3 "Exceptions, Traps, and Interrupts".</p>
<div class="admonition info">
<p class="admonition-title">RISC-V 与 x86 的不同：</p>
<p>在不同的教材中，我们对 Exception (异常)、Trap (陷阱) 和 Interrupt (中断) 有着类似的定义，例如 CSAPP 参照 x86 模型描述了如下四种类型的控制流中断：主要区别在于异常控制流产生是否同步与指令流、以及跳转至异常控制流后时候会返回到原来程序的控制流。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/csapp-definition.png" /></p>
<p>例如，x86 中的异常类型： Page Fault (缺页异常)，Machine Check (Abort) (内存或硬件错误)。</p>
<p>但是，在 RISC-V 模型下，上述的返回行为均是可以通过软件模拟的，所以在 RISC-V 硬件模型上，导致控制流改变的原因只有两种：异常 (Exception) 和中断 (Interrupt)。</p>
</div>
<h2 id="csr-mstatussstatus">CSR: mstatus/sstatus<a class="headerlink" href="#csr-mstatussstatus" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">CSR</p>
<p>如果你不清楚 CSR 是什么，请参照：<a href="../../qrh/csr/">QRH - CSR</a></p>
</div>
<p>mstatus/sstatus: Machine/Supervisor Status Register. 该寄存器保存着 RISC-V 核心的控制状态，sstaus 实际上是 mstatus 的一个 Restricted View.</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/mstatus.png" /></p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/sstatus.png" /></p>
<p>由于 RISC-V 的手册对 CSR 寄存器每个 Field 的定义实在是太难找，我们在此处提供一个用于快速查找的表：</p>
<table>
<thead>
<tr>
<th style="text-align: right;">Field</th>
<th style="text-align: left;">全称 (猜的)</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">SPP</td>
<td style="text-align: left;">Supervisor Previous Privilege</td>
<td>进入 Supervisor mode 前，Hart 所处的特权级。</td>
</tr>
<tr>
<td style="text-align: right;">SIE</td>
<td style="text-align: left;">Supervisor Interrupt Enabled</td>
<td>Supervisor 下，中断启用标志位。</td>
</tr>
<tr>
<td style="text-align: right;">SPIE</td>
<td style="text-align: left;">Supervisor Previous Interrupt Enabled</td>
<td>进入 Supervisor 前的中断启用状态。</td>
</tr>
<tr>
<td style="text-align: right;">SUM</td>
<td style="text-align: left;">Supervisor User-Memory</td>
<td>允许 Supervisor 模式下访问带 U-bit 的页面</td>
</tr>
</tbody>
</table>
<p>其他我们目前用不到的：</p>
<table>
<thead>
<tr>
<th style="text-align: right;">Field</th>
<th style="text-align: left;">全称 (猜的)</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">FS/VS/XS</td>
<td style="text-align: left;">Float-Point Status / Vector Status / user-eXtension Status</td>
<td>浮点模块/向量模块/用户自定义模块的状态，表示是否需要在中断处理器中保存它们</td>
</tr>
<tr>
<td style="text-align: right;">SD</td>
<td style="text-align: left;">Status Dirty</td>
<td>FS/VS/XS 是否有 Dirty</td>
</tr>
<tr>
<td style="text-align: right;">MBE/SBE/UBE</td>
<td style="text-align: left;">Machine/Supervisor/User Big-Endianess</td>
<td>Machine / Supervisor / User 模式下是否使用大端序进行非取值的访存</td>
</tr>
<tr>
<td style="text-align: right;">SXL/UXL</td>
<td style="text-align: left;">Supervisor/User XLEN</td>
<td>Supervisor/User 使用 32 位/64 位。</td>
</tr>
<tr>
<td style="text-align: right;">MPRV</td>
<td style="text-align: left;">Modify PRiVilege</td>
<td></td>
</tr>
<tr>
<td style="text-align: right;">MXR</td>
<td style="text-align: left;">Make eXecutable Readable</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="trap">Trap 相关寄存器：<a class="headerlink" href="#trap" title="Permanent link">&para;</a></h2>
<p>我们首先列举一下在 Trap 处理流程中用到的寄存器：</p>
<ul>
<li>stvec : Supervisor Trap Vector Base Address Register</li>
<li>存储中断处理函数地址。一般称之“中断向量”，我们会在后续讲解。</li>
<li>sip : Supervisor Interrupt Pending</li>
<li>表示有哪些中断等待处理</li>
<li>sie : Supervisor Interrupt Enabled</li>
<li>表示可以处理那些中断</li>
<li>注意不要与 sstatus.SIE 搞混。</li>
<li>sepc: Supervisor Exception Program Counter</li>
<li>发生中断时的 PC 指针</li>
<li>scause: Supervisor Cause</li>
<li>发生中断的原因</li>
<li>stval: Supervisor Trap Value</li>
<li>发生中断的额外信息</li>
</ul>
<h3 id="stvec">stvec<a class="headerlink" href="#stvec" title="Permanent link">&para;</a></h3>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/stvec.png" /></p>
<h3 id="scause">scause<a class="headerlink" href="#scause" title="Permanent link">&para;</a></h3>
<p>When a trap is taken into S-mode, scause is written with a code indicating the event that caused the trap.</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/scause.png" /></p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/scause-table.png" /></p>
<h3 id="sie-sip">sie &amp; sip<a class="headerlink" href="#sie-sip" title="Permanent link">&para;</a></h3>
<p>The sip register is an 64-bit read/write register containing information on pending interrupts,
while sie is the corresponding 64-bit read/write register containing interrupt enable bits.</p>
<p>Interrupt cause number i (as reported in CSR scause, Section 4.1.8) corresponds with bit i in both sip and sie. Bits 15:0 are allocated to standard interrupt causes only, while bits 16 and above are designated for platform or custom use.</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/sipsie.png" /></p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/sie-standard-def.png" /></p>
<h3 id="sepc">sepc<a class="headerlink" href="#sepc" title="Permanent link">&para;</a></h3>
<p>When a trap is taken into S-mode, sepc is written with the virtual address of the instruction that <strong>was interrupted or that encountered the exception</strong>.</p>
<h3 id="stval">stval<a class="headerlink" href="#stval" title="Permanent link">&para;</a></h3>
<p>When a trap is taken into S-mode, stval is written with exception-specific information to assist software in handling the trap.</p>
<p>If stval is written with a nonzero value when a breakpoint, address-misaligned, access-fault, or page-fault exception occurs on an instruction fetch, load, or store, then stval will contain the faulting virtual address.</p>
<h2 id="_2">硬件处理流程<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="trap_1">进入 Trap<a class="headerlink" href="#trap_1" title="Permanent link">&para;</a></h3>
<p><strong>当一个 Exception 发生时，或者 Hart 准备好处理 Interrupt 时，</strong> Trap 发生，CPU 在硬件电路上完成以下几件事情：</p>
<ol>
<li>scause &lt;= {1b'Is_Interrupt, 63b'Cause}</li>
<li>stavl &lt;= Trap_Value</li>
<li>sepc &lt;= pc</li>
<li>sstatus.SPP &lt;= Current_Privilege_Level</li>
<li>sstatus.SPIE &lt;= sstatus.SIE</li>
<li>sstatus.SIE &lt;= 0</li>
<li>pc &lt;= stvec</li>
</ol>
<p>用中文：设置 <code>scause</code> 与 <code>stval</code>，保存 PC 到 <code>spec</code>，保存当前特权级(U/S)到 <code>sstatus.SPP</code>，保存当前中断状态到 <code>sstatus.SPIE</code>，将中断关闭 <code>sstatus.SIE = 0</code>，跳转到 <code>stvec</code>。</p>
<h3 id="sret">sret<a class="headerlink" href="#sret" title="Permanent link">&para;</a></h3>
<p>RISC-V 使用 <code>sret</code> 指令从 Supervisor 的 Trap 中退出，该指令会执行以下步骤：</p>
<ol>
<li>sstauts.SIE &lt;= sstatus.SPIE</li>
<li>Current_Privilege_Level &lt;= sstauts.SPP</li>
<li>pc &lt;= epc</li>
</ol>
<p>用中文：还原 <code>sstatus.SIE</code> 为 <code>sstatus.SPIE</code>，将特权级(U/S)设置为 <code>sstauts.SPP</code>，将 PC 设置为 <code>sepc</code>。</p>
<p>实际上 sret 就是 Trap 时三步保存的逆步骤：还原 <code>SIE</code>、特权级和 PC 寄存器。</p>
<h3 id="interrupt">什么时候能处理 Interrupt<a class="headerlink" href="#interrupt" title="Permanent link">&para;</a></h3>
<p>RISC-V 定义了三种标准的中断：Software Interrupt, Timer Interrupt 和 External Interrupt，对应 scause 中的 Exception Code 1, 5, 9, 对应 sip/sie 中的第 1, 5, 9 bit.</p>
<!-- 中断源会拉高 Hart 的 sip 中的 bit，Hart 会判断当前能否进入中断。 -->

<p>进入中断的条件：</p>
<ul>
<li>(当前运行在 S 模式，且 <code>sstatus.SIE</code> == 1) 或者 当前运行在 U 模式。</li>
<li>中断类型 bit i 在 <code>sie</code> 和 <code>sip</code> 中均为 1.</li>
</ul>
<blockquote>
<p>An interrupt i will trap to S-mode if both of the following are true:</p>
<p>(a) either the current privilege mode is S and the SIE bit in the sstatus register is set, or the current privilege mode has less privilege than S-mode; and</p>
<p>(b) bit i is set in both sip and sie.</p>
</blockquote>
<p>当 Software/Timer/External Interrupt 到达 CPU 时，<code>sip</code> 中对应的 bit 会被拉高，然后 CPU 会按照如上条件进行检查，如果符合条件，则会进入 Trap。</p>
<h2 id="trap-handler">Trap Handler<a class="headerlink" href="#trap-handler" title="Permanent link">&para;</a></h2>
<h3 id="_3">中断向量<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>stvec 规定中断向量入口一定是对齐到 4 bytes (即最后两 bit 为 0)；同时，用这两位表示两种模式：</p>
<ol>
<li>Direct 模式：所有 Trap 的入口均为 pc &lt;= BASE</li>
<li>Vectored 模式：对于异步的中断，pc &lt;= BASE + 4 * cause</li>
</ol>
<p>在我们的代码中，我们使用 Direct 模式。</p>
<p>我们在 <code>entry.S</code> 中定义了适用于S mode 的中断向量入口点 <code>kernel_trap_entry</code> ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">kernel_trap_entry</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nl">kernel_trap_entry:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="c1">// we store all registers in the stack</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-0</span><span class="no">x100</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x00</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x08</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">0xf0</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">0xf8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="nf">mv</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="w">   </span><span class="c1">// make a0 point to the ktrapframe structure</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">kernel_trap</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="c1">// restore all registers</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="c1">//ld x0, 0x00(sp) // do not write to x0</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x08</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">0xf0</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">0xf8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">    </span><span class="c1">// restore stack</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0x100</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">    </span><span class="c1">// return from trap</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">    </span><span class="nf">sret</span>
</code></pre></div>
<p>入口点在栈上申请 0x100 bytes 的空间，并保存所有通用寄存器到栈上，此时，栈上形成了结构体 <code>struct ktrapframe</code>，用于快速索引栈上保存的寄存器。然后，将 <code>a0</code> 设置为 <code>sp</code>，调用 <code>kernel_trap</code> ，进入 C 代码继续处理 Trap。</p>
<p>由于 RISC-V 使用 a0 作为传递第一个参数的寄存器，a0 此时指向栈上的 <code>struct ktrapframe</code> 结构体，<code>kernel_trap</code> 函数可以直接将第一个参数设为 <code>struct ktrapframe* ktf</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kernel_trap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ktrapframe</span><span class="w"> </span><span class="o">*</span><span class="n">ktf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">intr_get</span><span class="p">());</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">r_sstatus</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SSTATUS_SPP</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kerneltrap: not from supervisor mode&quot;</span><span class="p">);</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">inkernel_trap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">        </span><span class="n">print_sysregs</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">        </span><span class="n">print_ktrapframe</span><span class="p">(</span><span class="n">ktf</span><span class="p">);</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;nested kerneltrap&quot;</span><span class="p">);</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">inkernel_trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">cause</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">r_scause</span><span class="p">();</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">exception_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SCAUSE_EXCEPTION_CODE_MASK</span><span class="p">;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SCAUSE_INTERRUPT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">exception_code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">SupervisorTimer</span><span class="p">:</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">                </span><span class="n">tracef</span><span class="p">(</span><span class="s">&quot;kernel timer interrupt&quot;</span><span class="p">);</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">                </span><span class="n">set_next_timer</span><span class="p">();</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">                </span><span class="c1">// we never preempt kernel threads.</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">free</span><span class="p">;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">SupervisorExternal</span><span class="p">:</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">                </span><span class="n">tracef</span><span class="p">(</span><span class="s">&quot;s-external interrupt from kerneltrap!&quot;</span><span class="p">);</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="w">                </span><span class="n">plic_handle</span><span class="p">();</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">free</span><span class="p">;</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="w">            </span><span class="k">default</span><span class="o">:</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">                </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kerneltrap entered with unhandled interrupt. %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="p">);</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="w">    </span><span class="n">print_sysregs</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="w">    </span><span class="n">print_ktrapframe</span><span class="p">(</span><span class="n">ktf</span><span class="p">);</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;trap from kernel&quot;</span><span class="p">);</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="nl">free</span><span class="p">:</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">intr_get</span><span class="p">());</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="w">    </span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">inkernel_trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="p">}</span>
</code></pre></div>
<p>在进入 <code>kernel_trap</code> 时，CPU 的中断位 <code>sstatus.SIE</code> 应该是保持关闭的，并且 Previous Privilege 应该是 Supervisor 模式。</p>
<p>然后，我们读取 <code>scause</code> 寄存器判断 Trap 是因为中断还是异常陷入的，并且我们处理时钟中断和 PLIC 管理的外部中断，对于其他预期之外的行为，我们可以打印栈上保存的 <code>ktramframe</code> 结构体帮助调试，并使用 <code>panic</code> 宏中断 CPU 执行。</p>
<p>最后，我们从 <code>kernel_trap</code> 离开。</p>
<p>从 C 语言环境退出后，我们从栈上恢复所有通用寄存器，恢复栈空间，然后使用 <code>sret</code> 退出 Trap。</p>
<p>下图展示了 进入 Trap，构造 ktrapframe，然后恢复并sret过程的栈结构：</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/trap-stacklayout.png" /></p>
<div class="admonition questions">
<p class="admonition-title">Lab TODO: </p>
<p>修改 <code>main.c</code>，在启动流程中加入 <code>asm volatile("ebreak")</code>，并在 <code>kernel_trap</code> 中处理该异常，并将 s0 寄存器的值改为 0x114514，使之后的 <code>printf</code> 输出该寄存器的值。</p>
</div>
<h2 id="interrupt_1">Interrupt<a class="headerlink" href="#interrupt_1" title="Permanent link">&para;</a></h2>
<p>RISC-V spec 定义了每个 Hart 有三个标准的中断：时钟中断、软件中断和外部中断。</p>
<h3 id="_4">时钟中断<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>时钟中断可以理解为每隔一段时间执行一次的程序。即每隔一段时间，会固定触发一次的中断。在时钟中断的处理时，我们可以完成进程调度等操作。</p>
<p>RISC-V 平台提供了一个实时的时间计数器: <code>mtime</code> 寄存器，该寄存器以恒定的频率增长，并且在所有核心之间共享。另外，RISC-V 对每个核心提供了一个 <code>mtimecmp</code> 寄存器，每当 <code>mtime &gt;= mtimecmp</code> 时，该核心就会拉高时钟中断的 <code>sip.STIP</code> bit，如果核心满足进入中断 Trap 的条件，则会进入时钟中断。</p>
<p>SBI 提供了一个 SBI call：<code>SBI_SET_TIMER</code> 允许 Supervisor 软件设置 <code>mtimecmp</code> 寄存器。在已知 mtime 寄存器的增长频率后，我们可以计算 10ms 后 mtime 会增长多少，并设置 mtimecmp 为该值，我们即可在 10ms 后收到一次时钟中断。在每次进入时钟中断时，我们再次计算下次的 mtimecmp，即可实现每 10ms 收到一次时间中断。</p>
<p>时钟部分的代码位于 <code>timer.c</code>。</p>
<p>在初始化时钟中断时，我们通过 SBI call <code>SET_TIMER</code> 设置 <code>mtimecmp</code>，并在 <code>sie</code> 中启用时钟中断 <code>SIE_STIE</code>。</p>
<p>在 <code>kernel_trap</code> 中处理时钟中断时，我们计算下一次的 <code>mtimecmp</code>，并再次 SBI call <code>SET_TIMER</code>，循环往复。</p>
<div class="admonition question">
<p class="admonition-title">Lab 实验</p>
<p>请你将 <code>TICKS_PER_SEC</code> 宏修改为 1，<code>make run</code> 后观察每次触发时钟中断时的 cycle 读数。</p>
<p>注释掉 <code>trap.c</code> 中 <code>kernel_trap</code> 调用 <code>set_next_timer</code>，并再次 <code>make run</code> 观察每次触发时钟中断时的 cycle 读数。</p>
<p>请解释你的发现。</p>
</div>
<h3 id="plic-platform-level-interrupt-controller">PLIC (Platform-Level Interrupt Controller)<a class="headerlink" href="#plic-platform-level-interrupt-controller" title="Permanent link">&para;</a></h3>
<p>PLIC 是 RISC-V 平台上用于管理外部中断的 IP 核，每个 RISC-V 平台拥有多个核心 (Hart)，而每个平台一般只有一个 PLIC。</p>
<p>Specification: <a href="https://github.com/riscv/riscv-plic-spec/blob/master/riscv-plic.adoc">https://github.com/riscv/riscv-plic-spec/blob/master/riscv-plic.adoc</a></p>
<h4 id="plic">PLIC 结构<a class="headerlink" href="#plic" title="Permanent link">&para;</a></h4>
<p>PLIC 管理 1~1023 个中断源，每个中断源拥有一个优先级 Priority 。PLIC 将能够接收中断的对象 (Interrupt Targets) 称为 Hart Context (where a hart context is a given privilege mode on a given hart)，每个 Context 对应着一个 Hart 和一个特权级别。由于目前 RISC-V 没有规定 User-Mode Interrupt，（例如 RISC-V privilege spec 只规定了 mie/mip 和 sie/sip，对应着 Machine Mode 和 Supervisor Mode 的中断），我们可以认为每个核心拥有两个 Context。</p>
<p>PLIC 能够管理 0~15871 个 Context，能设置每个中断源是否允许路由至某个 Context (Enabled Bit)，每个 Context 能接收的 Priority Threshold。</p>
<p>PLIC 会拉起 Hart 的 mip.MEIP/sip.SEIP bit，而该 hart 是否进入 Interrupt 的 Trap 由上述 <code>进入中断的条件</code> 决定。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/plic-structure.png" /></p>
<h4 id="memory-mapped-register">Memory-Mapped Register<a class="headerlink" href="#memory-mapped-register" title="Permanent link">&para;</a></h4>
<p>PLIC 使用 Memory-Mapped Register 向系统暴露管理接口。对于每个寄存器 (消歧义：此处的寄存器不是特指 RISC-V 核心的 x0 - x31 General Purpose Registers)，我们使用偏移量来定位每个寄存器。通常，这种 IP 核有着固定的基地址，在 QEMU 上，这个地址是 <code>0x0c00_0000</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>gef &gt; monitor info mtree
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    000000000c000000-000000000c5fffff (prio 0, i/o): riscv.sifive.plic
</code></pre></div>
<p>例如，Specification 中的 Memory Map 规定，<code>base + 0x4 * i</code> 是第 i 个中断源的</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>base + 0x000000: Reserved (interrupt source 0 does not exist)
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>base + 0x000004: Interrupt source 1 priority
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>base + 0x000008: Interrupt source 2 priority
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>...
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>base + 0x000FFC: Interrupt source 1023 priority
</code></pre></div>
<p>在 <code>plicinit</code> 中，我们向 <code>base + 10*4 = 1</code> 设置 UART0 (10号中断) 的 Interrupt Priority 为 1，在 <code>plicinithart</code> 中，我们将该 Hart 的 S-mode Context 允许来自 10 号中断、并设置 Priority Threshold 为 0，最后，启用该核心的 <code>sie.SEIE</code> 位，表示该核心允许 Supervisor-Mode External Interrupt。</p>
<div class="admonition question">
<p class="admonition-title">Lab 练习</p>
<p>请对照 PLIC Specification 中的 Memory Map 解释 <code>plic.c</code> 中对所有 PLIC 的 Memory-Mapped Register 的访问，并解释它们的意义。</p>
</div>
<h4 id="claim-complete">Claim &amp; Complete<a class="headerlink" href="#claim-complete" title="Permanent link">&para;</a></h4>
<p>在 Hart 因为 External Interrupt 陷入 Trap 后，Hart 需要向 PLIC 申请处理该中断。在处理完成后，Hart 还需要向 PLIC 申明该中断处理完毕。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/PLICInterruptFlow.jpg" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-copyright">
    <div class="md-copyright__highlight">
        commit: 
        <a href="https://github.com/yuk1i/os-next-docs/commit/96812674, 2025-03-03 11:21:06+08:00" target="_blank" rel="noopener">
            96812674, 2025-03-03 11:21:06+08:00
        </a>
    </div>
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>