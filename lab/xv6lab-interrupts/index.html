
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../xv6lab-baremetal/">
      
      
        <link rel="next" href="../xv6lab-contextswitch/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Week 4 - 陷入与中断 Trap & Interrupts - 操作系统实验文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#trap-exception-and-interrupt" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-header__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            操作系统实验文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Week 4 - 陷入与中断 Trap & Interrupts
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../env/" class="md-tabs__link">
          
  
  实验环境搭建

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab1/" class="md-tabs__link">
          
  
  每周实验

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../laben/lab2/" class="md-tabs__link">
          
  
  Weekly Lab Material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qrh/nav/" class="md-tabs__link">
          
  
  快速参考手册

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-nav__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    操作系统实验文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    实验环境搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            实验环境搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux VM 搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Linux VM 搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/windows-vmware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + VMware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/wsl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + WSL (不推荐)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS + VMware
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    手动环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    验证环境
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    每周实验
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            每周实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 1 - Linux基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C 语言基础及Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - 裸机程序 Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      实验目的
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exceptional-control-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptional Control Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exceptions-traps-and-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptions, Traps, and Interrupts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#csr-mstatussstatus" class="md-nav__link">
    <span class="md-ellipsis">
      CSR: mstatus/sstatus
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trap" class="md-nav__link">
    <span class="md-ellipsis">
      Trap 相关寄存器：
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trap 相关寄存器：">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stvec" class="md-nav__link">
    <span class="md-ellipsis">
      stvec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scause" class="md-nav__link">
    <span class="md-ellipsis">
      scause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sie-sip" class="md-nav__link">
    <span class="md-ellipsis">
      sie &amp; sip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sepc" class="md-nav__link">
    <span class="md-ellipsis">
      sepc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stval" class="md-nav__link">
    <span class="md-ellipsis">
      stval
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cpu-trap" class="md-nav__link">
    <span class="md-ellipsis">
      CPU 如何处理 Trap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CPU 如何处理 Trap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-trap" class="md-nav__link">
    <span class="md-ellipsis">
      1. 进入 Trap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-trap" class="md-nav__link">
    <span class="md-ellipsis">
      2. Trap 处理程序
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-trap-sret" class="md-nav__link">
    <span class="md-ellipsis">
      3. Trap处理返回 sret
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      代码解读
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 实验报告
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interrupt" class="md-nav__link">
    <span class="md-ellipsis">
      Interrupt
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interrupt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interrupt_1" class="md-nav__link">
    <span class="md-ellipsis">
      什么时候能处理 Interrupt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      时钟中断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      外部中断
    </span>
  </a>
  
    <nav class="md-nav" aria-label="外部中断">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plic" class="md-nav__link">
    <span class="md-ellipsis">
      PLIC 结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-mapped-register" class="md-nav__link">
    <span class="md-ellipsis">
      Memory-Mapped Register
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#claim-complete" class="md-nav__link">
    <span class="md-ellipsis">
      Claim &amp; Complete
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      串口中断
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - 上下文切换 Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - 内核页表 Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - 用户空间 Userspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 8 - 进程 Process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-pagefault/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 9 - 缺页异常 Page Fault
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Weekly Lab Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Weekly Lab Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C language basic & Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - Trap & Interrupt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - Userspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-userprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 8 - User Process
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    快速参考手册
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            快速参考手册
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/nav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/vf2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VisionFive2 板子教程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/ssh-vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH & VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      实验目的
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exceptional-control-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptional Control Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exceptions-traps-and-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptions, Traps, and Interrupts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#csr-mstatussstatus" class="md-nav__link">
    <span class="md-ellipsis">
      CSR: mstatus/sstatus
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trap" class="md-nav__link">
    <span class="md-ellipsis">
      Trap 相关寄存器：
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trap 相关寄存器：">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stvec" class="md-nav__link">
    <span class="md-ellipsis">
      stvec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scause" class="md-nav__link">
    <span class="md-ellipsis">
      scause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sie-sip" class="md-nav__link">
    <span class="md-ellipsis">
      sie &amp; sip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sepc" class="md-nav__link">
    <span class="md-ellipsis">
      sepc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stval" class="md-nav__link">
    <span class="md-ellipsis">
      stval
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cpu-trap" class="md-nav__link">
    <span class="md-ellipsis">
      CPU 如何处理 Trap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CPU 如何处理 Trap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-trap" class="md-nav__link">
    <span class="md-ellipsis">
      1. 进入 Trap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-trap" class="md-nav__link">
    <span class="md-ellipsis">
      2. Trap 处理程序
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-trap-sret" class="md-nav__link">
    <span class="md-ellipsis">
      3. Trap处理返回 sret
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      代码解读
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 实验报告
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interrupt" class="md-nav__link">
    <span class="md-ellipsis">
      Interrupt
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interrupt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interrupt_1" class="md-nav__link">
    <span class="md-ellipsis">
      什么时候能处理 Interrupt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      时钟中断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      外部中断
    </span>
  </a>
  
    <nav class="md-nav" aria-label="外部中断">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plic" class="md-nav__link">
    <span class="md-ellipsis">
      PLIC 结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-mapped-register" class="md-nav__link">
    <span class="md-ellipsis">
      Memory-Mapped Register
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#claim-complete" class="md-nav__link">
    <span class="md-ellipsis">
      Claim &amp; Complete
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      串口中断
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="trap-exception-and-interrupt">Trap, Exception and Interrupt<a class="headerlink" href="#trap-exception-and-interrupt" title="Permanent link">&para;</a></h1>
<h2 id="_1">实验目的<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ol>
<li>了解异常控制流</li>
<li>了解 RISC-V 架构是如何支持 CPU 中断的</li>
<li>掌握 Trap 处理流程</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">xv6-lab2 代码分支</p>
<p><a href="https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab2">https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab2</a></p>
<p>使用命令 <code>git clone https://github.com/yuk1i/SUSTech-OS-2025 -b xv6-lab2 xv6lab2</code> 下载 xv6-lab2 代码。</p>
<p>使用 <code>make run</code> 运行本次 Lab 的内核，你将会看到一次 Kernel Panic。</p>
</div>
<div class="admonition info">
<p class="admonition-title">推荐阅读</p>
<p>CSAPP, Chapter 8, Exceptional Control Flow.</p>
<p><a href="https://csapp.cs.cmu.edu/2e/ch8-preview.pdf">https://csapp.cs.cmu.edu/2e/ch8-preview.pdf</a></p>
</div>
<h2 id="exceptional-control-flow">Exceptional Control Flow<a class="headerlink" href="#exceptional-control-flow" title="Permanent link">&para;</a></h2>
<p>在正常的程序运行状态下，控制流 (可以认为是 pc 指针的序列) 是按照程序所预定的顺序一步步执行的。但是，操作系统不可避免地需要处理一些在“预定之外的”情况，例如程序出错、或者外部状态有所改变，比如有数据包抵达网卡、用户敲击键盘等事件。现代操作系统通过改变控制流来处理这些事件，我们将这种控制流称为 Exceptional Control Flow (异常控制流)。</p>
<h2 id="exceptions-traps-and-interrupts">Exceptions, Traps, and Interrupts<a class="headerlink" href="#exceptions-traps-and-interrupts" title="Permanent link">&para;</a></h2>
<p>在 RISC-V 体系架构中，我们将 Exception (异常)、 Interrupt (中断)和 Trap (陷阱，陷入) 定义如下：</p>
<ul>
<li>Exception: 一种不寻常的情况，出现在指令执行的时刻。</li>
<li>Interrupt: 一种外部的事件，与当前 RISC-V 核心指令执行是异步的。</li>
<li>Trap: 一种同步的、由于异常或中断导致的控制流转移。<strong>我们可以将 Trap 认为是对 Exception 和 Interrupt 的处理行为。</strong></li>
</ul>
<div class="admonition info">
<p class="admonition-title">什么是同步/异步 (Synchronous / Asynchronous)</p>
<p>回想在数字逻辑课程上实现的单周期 RISC-V CPU，我们有时钟信号 clk (clock)，每(n)个时钟周期执行一条指令。</p>
<p>同步的异常是由于指令执行时产生的，所以异常的产生是与 clk 对齐的；而异步的异常则完全与当前指令、clk无关。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/sync-async.png" /></p>
</div>
<p>所以，很显然为什么 Trap 所指的控制流转移是“同步”的：我们起码需要等待时钟周期来临才能进行控制流转移。</p>
<p>We use the term <strong>exception</strong> to refer to an unusual condition occurring at run time associated with an instruction in the current RISC-V thread.
We use the term <strong>trap</strong> to refer to the synchronous transfer of control to a trap handler caused by an exceptional condition occurring within a RISC-V thread.
Trap handlers usually execute in a more privileged environment.</p>
<p>We use the term <strong>interrupt</strong> to refer to an external event that occurs asynchronously to the current RISC-V thread.
When an interrupt that must be serviced occurs, some instruction is selected to receive an interrupt exception and subsequently experiences a trap.</p>
<p>Source: riscv-spec-v2.1.pdf, Section 1.3 "Exceptions, Traps, and Interrupts".</p>
<div class="admonition info">
<p class="admonition-title">RISC-V 与 x86 的不同：</p>
<p>在不同的教材中，我们对 Exception (异常)、Trap (陷阱) 和 Interrupt (中断) 有着类似的定义，例如 CSAPP 参照 x86 模型描述了如下四种类型的控制流中断：主要区别在于异常控制流产生是否与指令流同步、以及跳转至异常控制流后是否会返回到原来程序的控制流。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/csapp-definition.png" /></p>
<p>例如，x86 中的异常类型： Page Fault (缺页异常)，Machine Check (Abort) (内存或硬件错误)。</p>
<p>但是，在 RISC-V 模型下，上述的返回行为均是可以通过软件模拟的，所以在 RISC-V 硬件模型上，导致控制流改变的原因只有两种：异常 (Exception) 和中断 (Interrupt)。而导致控制流改变的结果就是进入 Trap。</p>
<p>Note: RISC-V 硬件层面有一种极其精简的设计语言：只要软件能处理的事情，硬件一概不管。</p>
</div>
<h2 id="csr-mstatussstatus">CSR: mstatus/sstatus<a class="headerlink" href="#csr-mstatussstatus" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">CSR</p>
<p>如果你不清楚 CSR 是什么，请重新阅读上一节 Lab 课的课件。</p>
<p>你可能会对 CSR Field 定义中的 WPRI, WLRL, WARL 等关键字感到迷惑，请查阅 riscv-privilege.pdf, Section 2.3 CSR Field Specifications。你可以直接认为，由这些关键字定义的 Bit Fields 是我们不需要关心、修改的字段。</p>
</div>
<p>mstatus/sstatus: Machine/Supervisor Status Register. 该寄存器保存着 RISC-V 核心的控制状态，sstatus 实际上是 mstatus 的一个 Restricted View.</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/mstatus.png" /></p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/sstatus.png" /></p>
<p>由于 RISC-V 的手册对 CSR 寄存器每个 Field 的定义实在是太难找，我们在此处提供一个用于快速查找的表：</p>
<table>
<thead>
<tr>
<th style="text-align: right;">Field</th>
<th style="text-align: left;">全称 (猜的)</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">SPP</td>
<td style="text-align: left;">Supervisor Previous Privilege</td>
<td>进入 Supervisor mode 前，Hart 所处的特权级。</td>
</tr>
<tr>
<td style="text-align: right;">SIE</td>
<td style="text-align: left;">Supervisor Interrupt Enabled</td>
<td>Supervisor 下，中断启用标志位。</td>
</tr>
<tr>
<td style="text-align: right;">SPIE</td>
<td style="text-align: left;">Supervisor Previous Interrupt Enabled</td>
<td>进入 Supervisor 前的中断启用状态。</td>
</tr>
<tr>
<td style="text-align: right;">SUM</td>
<td style="text-align: left;">Supervisor User-Memory</td>
<td>允许 Supervisor 模式下访问带 U-bit 的页面</td>
</tr>
</tbody>
</table>
<p>其他我们目前用不到的在此不做解释。</p>
<h2 id="trap">Trap 相关寄存器：<a class="headerlink" href="#trap" title="Permanent link">&para;</a></h2>
<p>我们首先列举一下在 Trap 处理流程中用到的寄存器：</p>
<ul>
<li>stvec : Supervisor Trap Vector Base Address Register<ul>
<li>存储 Trap 处理函数地址。一般称之“中断向量”，我们会在后续讲解。</li>
</ul>
</li>
<li>sip : Supervisor Interrupt Pending<ul>
<li>表示有哪些中断等待处理</li>
</ul>
</li>
<li>sie : Supervisor Interrupt Enabled<ul>
<li>表示可以处理那些中断</li>
<li>注意不要与 sstatus.SIE 搞混。</li>
</ul>
</li>
<li>sepc: Supervisor Exception Program Counter<ul>
<li>发生中断时的 PC 指针</li>
</ul>
</li>
<li>scause: Supervisor Cause<ul>
<li>发生中断的原因</li>
</ul>
</li>
<li>stval: Supervisor Trap Value<ul>
<li>发生中断的额外信息</li>
</ul>
</li>
</ul>
<h3 id="stvec">stvec<a class="headerlink" href="#stvec" title="Permanent link">&para;</a></h3>
<p>在异常或中断产生后，应该有个 <strong>Trap 处理程序</strong> 来处理这些异常和中断。<code>stvec</code>(Supervisor Trap Vector Base Address Register)即是所谓的<code>Trap向量表基址</code>。
向量表的作用就是把不同种类的 Trap 映射到对应的 Trap 处理程序。
如果只有一个处理程序，那么可以让<code>stvec</code>直接指向那个处理程序的地址。</p>
<div class="admonition note">
<p class="admonition-title">stvec</p>
<p>stvec 规定 Trap 处理函数入口一定是对齐到 4 bytes (即最后两 bit 为 0)；同时，用这最后两位表示两种模式：</p>
<ol>
<li>Direct 模式：所有 Trap 的入口均为 pc &lt;= BASE</li>
<li>Vectored 模式：对于异步的中断，pc &lt;= BASE + 4 * cause</li>
</ol>
<p>在我们的代码中，我们使用 Direct 模式。</p>
</div>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/stvec.png" /></p>
<h3 id="scause">scause<a class="headerlink" href="#scause" title="Permanent link">&para;</a></h3>
<p>当一个陷阱（trap）被捕获并进入 S 模式（Supervisor Mode）时，<code>scause</code> 寄存器会被写入一个代码，该代码指示导致陷阱的事件。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/scause.png" /></p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/scause-table.png" /></p>
<h3 id="sie-sip">sie &amp; sip<a class="headerlink" href="#sie-sip" title="Permanent link">&para;</a></h3>
<p><code>sip</code> 寄存器是一个 64 位的读写寄存器，用于存储有关挂起中断的信息，而 <code>sie</code> 则是相应的 64 位读写寄存器，包含中断使能位。</p>
<p>中断原因编号 <code>i</code>（如 CSR <code>scause</code> 中所示）对应于 <code>sip</code> 和 <code>sie</code> 寄存器中的第 <code>i</code> 位。
第 15:0 位仅分配给标准中断原因，而第 16 位及以上的位则保留给平台或自定义用途。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/sipsie.png" /></p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/sie-standard-def.png" /></p>
<h3 id="sepc">sepc<a class="headerlink" href="#sepc" title="Permanent link">&para;</a></h3>
<p>当一个 Trap 被捕获并进入 S 模式（Supervisor Mode）时，
<code>sepc</code> 寄存器会被写入 <strong>被中断或遇到异常</strong> 的指令的虚拟地址。</p>
<h3 id="stval">stval<a class="headerlink" href="#stval" title="Permanent link">&para;</a></h3>
<p>当一个 Trap 被捕获并进入 S 模式（Supervisor Mode）时，
<code>stval</code> 寄存器会被写入与异常相关的特定信息，以协助软件处理该陷阱。</p>
<p>在取指、加载或存储操作中发生断点、地址不对齐、访问错误或页错误异常时，
<code>stval</code> 会被写入一个非零值，并且 <code>stval</code> 将包含导致异常的虚拟地址。</p>
<h2 id="cpu-trap">CPU 如何处理 Trap<a class="headerlink" href="#cpu-trap" title="Permanent link">&para;</a></h2>
<p>Trap处理过程可以分为三个主要部分：</p>
<ol>
<li>进入Trap</li>
<li>Trap处理程序</li>
<li>Trap处理返回 </li>
</ol>
<h3 id="1-trap">1. 进入 Trap<a class="headerlink" href="#1-trap" title="Permanent link">&para;</a></h3>
<p><strong>当一个 Exception 发生时，或者 Hart 准备好处理 Interrupt 时，</strong> Trap 发生，CPU 在硬件电路上完成以下几件事情：</p>
<ol>
<li>scause &lt;= {1b'Is_Interrupt, 63b'Cause}</li>
<li>stval &lt;= Trap_Value</li>
<li>sepc &lt;= pc</li>
<li>sstatus.SPP &lt;= Current_Privilege_Level</li>
<li>sstatus.SPIE &lt;= sstatus.SIE</li>
<li>sstatus.SIE &lt;= 0</li>
<li>pc &lt;= stvec</li>
</ol>
<p>即设置 <code>scause</code> 与 <code>stval</code> =&gt; 保存 PC 到 <code>spec</code> =&gt; 保存当前特权级(U/S)到 <code>sstatus.SPP</code> =&gt; 保存当前中断状态到 <code>sstatus.SPIE</code> =&gt; 将中断关闭 <code>sstatus.SIE = 0</code>，防止在 Trap 处理函数中遇到中断 =&gt; 跳转到 <code>stvec</code></p>
<h3 id="2-trap">2. Trap 处理程序<a class="headerlink" href="#2-trap" title="Permanent link">&para;</a></h3>
<p><code>stvec</code> 中存储了 Trap 处理程序的地址，当CPU记录完导致Trap的异常或中断的相关信息后，<code>pc</code> 会指向 <code>stvec</code> 中存储的地址，从而执行相应的 <code>Trap</code> 处理程序.
<code>Trap</code> 处理程序会根据寄存器中存储的异常或中断的相关信息，采用不同的软件行为进行相应的处理。</p>
<h3 id="3-trap-sret">3. Trap处理返回 <code>sret</code><a class="headerlink" href="#3-trap-sret" title="Permanent link">&para;</a></h3>
<p>RISC-V 使用 <code>sret</code> 指令从 Supervisor 的 Trap 中退出，该指令会执行以下步骤：</p>
<ol>
<li>sstauts.SIE &lt;= sstatus.SPIE</li>
<li>Current_Privilege_Level &lt;= sstauts.SPP</li>
<li>pc &lt;= epc</li>
</ol>
<p>即还原 <code>sstatus.SIE</code> 为 <code>sstatus.SPIE</code> =&gt; 将特权级(U/S)设置为 <code>sstauts.SPP</code> =&gt; 将 PC 设置为 <code>sepc</code></p>
<p>实际上 sret 就是 Trap 时三步保存的逆步骤：还原 <code>SIE</code>、特权级和 PC 寄存器。</p>
<h2 id="_2">代码解读<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>在操作系统启动之后，我们将对 <code>stvec</code> 寄存器的值进行初始化，将它指向 <code>kernel_trap_entry</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">//trap.c</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">set_kerneltrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">((</span><span class="n">uint64</span><span class="p">)</span><span class="n">kernel_trap_entry</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="n">w_stvec</span><span class="p">((</span><span class="n">uint64</span><span class="p">)</span><span class="n">kernel_trap_entry</span><span class="p">);</span><span class="w">  </span><span class="c1">// DIRECT</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">}</span>
</code></pre></div>
<p>接着，当 Trap 发生后，CPU在做完相应信息的存储后，跳转到 <code>stvec</code> 指向的 <code>kernel_trap_entry</code> 方法开始执行，它是适用于 S mode 的中断向量入口点。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">kernel_trap_entry</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nl">kernel_trap_entry:</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="c1">// we store all registers in the stack</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-0</span><span class="no">x100</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x00</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x08</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">0xf0</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">0xf8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="c1">// ...</span>
</code></pre></div>
<p>入口点会在栈上申请 0x100 bytes 的空间，并保存所有通用寄存器到栈上。
此时，栈上保存了 32 个寄存器，每个占用空间 8 bytes，总共占用 0x100 bytes，从低地址到高地址分别是从 x0 到 x31。
我们定义一个结构体 <code>struct ktrapframe</code>，并使它的内存布局和此时栈上的寄存器布局一致。
这样的话，我们在 C 语言中就可以直接对一个 <code>struct ktrapframe*</code> 的指针进行解引用，来访问到此时在栈上保存的所有 GPR。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">ktrapframe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">x0</span><span class="p">;</span><span class="w">  </span><span class="c1">// x0</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">ra</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">gp</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">tp</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">t0</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">t1</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">t2</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s0</span><span class="p">;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">a0</span><span class="p">;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">a1</span><span class="p">;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">a2</span><span class="p">;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">a3</span><span class="p">;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">a4</span><span class="p">;</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">a5</span><span class="p">;</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">a6</span><span class="p">;</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">a7</span><span class="p">;</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s2</span><span class="p">;</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s3</span><span class="p">;</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s4</span><span class="p">;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s5</span><span class="p">;</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s6</span><span class="p">;</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s7</span><span class="p">;</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s8</span><span class="p">;</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s9</span><span class="p">;</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s10</span><span class="p">;</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s11</span><span class="p">;</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">t3</span><span class="p">;</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">t4</span><span class="p">;</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">t5</span><span class="p">;</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">t6</span><span class="p">;</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">    </span><span class="c1">// 32 * 8 bytes = 256 (0x100) bytes</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="p">};</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">栈</p>
<p>在一进入 Trap Handler 时，我们可以假定之前的程序是在执行 C 代码，以及它拥有一个合法的栈。</p>
<p>我们当然希望 Trap 处理函数能是 C 语言写的，而这也需要一个合法的栈空间。 
<strong>所以，我们可以直接借用原来正在执行的程序所用的栈空间</strong> ，只要我们确保 sp 指针能被复原即可。</p>
<p>额外的，C 语言编译器在使用栈时，借多少空间就会还多少空间。
所以我们只需要保证我们在汇编层面对栈的操作是平衡的，就可以直接使用现有的栈进行上下文的保存，剩下的就可以放心地交给编译器了。</p>
</div>
<div class="admonition note">
<p class="admonition-title">上下文 (Context)</p>
<p>Trap 的处理需要“放下当前的事情但之后还能回来接着之前往下做”，对于CPU来说，实际上只需要把原先的寄存器保存下来，做完其他事情把寄存器恢复回来就可以了。</p>
<p>在刚刚进入 Trap 处理函数时，31 个 GPR（General Purpose Register，通用寄存器） x1-x31 均是原来的程序正在使用中的寄存器。Trap Handler 需要保证在控制流回到原先的程序后， GPR 应该与产生 Trap 前一致。所以，我们需要一些内存空间来保存这些寄存器，并在从 Trap 中返回时恢复它们原来的值。我们可以将这些寄存器称为原先程序的 <strong>Context (上下文)</strong> 。</p>
<p>因此，我们使用汇编实现上下文切换(context switch)机制，这包含两步：</p>
<ul>
<li>保存CPU的寄存器（上下文）到内存中（栈上）</li>
<li>从内存中（栈上）恢复CPU的寄存器</li>
</ul>
</div>
<p>接着，我们将 <code>a0</code> 设置为 <code>sp</code>，调用 <code>kernel_trap</code> ，进入 C 代码继续处理 Trap。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">kernel_trap_entry</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nl">kernel_trap_entry:</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="nf">mv</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="w">   </span><span class="c1">// make a0 point to the ktrapframe structure</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">kernel_trap</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="c1">// ...</span>
</code></pre></div>
<p>由于 RISC-V 使用 a0 作为传递第一个参数的寄存器，a0 此时指向栈上的 <code>struct ktrapframe</code> 结构体，所以 <code>kernel_trap</code> 函数的第一个参数的值即为a0的值 <code>struct ktrapframe* ktf</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kernel_trap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ktrapframe</span><span class="w"> </span><span class="o">*</span><span class="n">ktf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">intr_get</span><span class="p">());</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">r_sstatus</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SSTATUS_SPP</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kerneltrap: not from supervisor mode&quot;</span><span class="p">);</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_scause</span><span class="p">();</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">exception_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SCAUSE_EXCEPTION_CODE_MASK</span><span class="p">;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SCAUSE_INTERRUPT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">        </span><span class="c1">// handle interrupt</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">exception_code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">SupervisorTimer</span><span class="p">:</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">                </span><span class="n">debugf</span><span class="p">(</span><span class="s">&quot;s-timer interrupt, cycle: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r_time</span><span class="p">());</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">                </span><span class="n">set_next_timer</span><span class="p">();</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">SupervisorExternal</span><span class="p">:</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">                </span><span class="n">debugf</span><span class="p">(</span><span class="s">&quot;s-external interrupt.&quot;</span><span class="p">);</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">                </span><span class="n">plic_handle</span><span class="p">();</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">            </span><span class="k">default</span><span class="o">:</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="w">                </span><span class="n">errorf</span><span class="p">(</span><span class="s">&quot;unhandled interrupt: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="p">);</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">kernel_panic</span><span class="p">;</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="w">        </span><span class="c1">// kernel exception, unexpected.</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">kernel_panic</span><span class="p">;</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">intr_get</span><span class="p">());</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="nl">kernel_panic</span><span class="p">:</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="w">    </span><span class="n">panicked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="w">    </span><span class="n">errorf</span><span class="p">(</span><span class="s">&quot;=========== Kernel Panic ===========&quot;</span><span class="p">);</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="w">    </span><span class="n">print_sysregs</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="w">    </span><span class="n">print_ktrapframe</span><span class="p">(</span><span class="n">ktf</span><span class="p">);</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kernel panic&quot;</span><span class="p">);</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="p">}</span>
</code></pre></div>
<p>在进入 <code>kernel_trap</code> 时，CPU 的中断位 <code>sstatus.SIE</code> 应该是保持关闭的，并且 Previous Privilege 应该是 Supervisor 模式，我们使用 assert（断言）来确保代码是按照预期执行的。</p>
<div class="admonition info">
<p class="admonition-title">为什么我们要写 assert</p>
<p>断言（Assertions）在操作系统开发中是一个非常重要的调试和错误检测工具。
断言可以帮助开发者在程序执行的早期阶段捕获可能的逻辑错误。
通过在代码中插入断言，我们可以立即检测到不符合预期的状态或条件，而不是等到程序崩溃或产生不可预测的行为后，再来猜测问题可能出在哪里。</p>
<p>换句话说，如果我们在某个点上能探测到程序的运行状态偏离了我们的预期，那我们就可以让它尽量崩溃在第一现场，以提供更加有效的调试信息。</p>
</div>
<p>然后，我们读取 <code>scause</code> 寄存器判断 Trap 是因为中断还是异常陷入的，并且我们处理时钟中断和 PLIC 管理的外部中断，对于其他预期之外的 Trap 原因，我们可以打印栈上保存的 <code>ktramframe</code> 结构体帮助调试，并使用 <code>panic</code> 宏表示内核遇到了不可恢复的错误并停机。</p>
<p>最后，我们从 <code>kernel_trap</code> 离开，回到 <code>kernel_trap_entry</code> 继续执行。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">kernel_trap_entry</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nl">kernel_trap_entry:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">kernel_trap</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="c1">// restore all registers</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="c1">//ld x0, 0x00(sp) // do not write to x0</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x08</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="mi">0xf0</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">x31</span><span class="p">,</span><span class="w"> </span><span class="mi">0xf8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="c1">// restore stack</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0x100</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">    </span><span class="c1">// return from trap</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">    </span><span class="nf">sret</span>
</code></pre></div>
<p>从 C 语言环境退出后，我们从栈上恢复所有通用寄存器，恢复栈空间，然后使用 <code>sret</code> 退出 Trap。</p>
<p>sret 将把 <code>sepc</code> 的值还原至 PC 寄存器</p>
<p>下图展示了 进入 Trap，构造 ktrapframe，然后恢复并 sret 过程的栈结构：</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/trap-stacklayout.png" /></p>
<h2 id="lab">Lab 实验报告<a class="headerlink" href="#lab" title="Permanent link">&para;</a></h2>
<div class="admonition question">
<p class="admonition-title">Question 1</p>
<p>结合本周的实验内容。通过 gdb 调试器打印出上一周实验代码运行到 main 函数时 <code>stvec</code> 的值。并结合这个值进一步解释为何读取 CSR mvendorid的值失败后会操作系统的表现是无限重启。</p>
<p>你可能需要用到gdb指令 <code>b main</code> (在 main 函数入口打断点), <code>c</code> (continue, 继续执行) 和 <code>print $stvec</code> 。</p>
</div>
<div class="admonition question">
<p class="admonition-title">Question 2</p>
<p>在 <code>main.c</code> 中， <code>ebreak</code> 指令会主动触发一次异常。使用 <code>make run</code> 运行内核，你将会看到 <code>Kernel Panic</code>，以及它打印的一些 CSR.</p>
<p>对照 RISC-V 特权级手册 Section <code>4.1.1 Supervisor Status Register (sstatus)</code>，查阅 Kernel Panic 日志中打印的 CSR，请你从 sstatus 的值中提取的 SIE, SPIE, SPP 三个 bit 的值，并解释其意思。</p>
<p>对照 scause 中关于 Interrupt/Exception Code 的描述， <strong>写下当前 scause 的意思</strong> 。</p>
<p>接着，在 <code>trap.c</code> 中的 <code>kernel_trap</code> 函数中，修改 else 分支，使 <code>ebreak</code> 造成的异常不要进入 <code>kernel_panic</code> 标签，而是退出 <code>kernel_trap</code> 处理函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SCAUSE_INTERRUPT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="c1">// handle interrupt</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exception_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">        </span><span class="n">debugf</span><span class="p">(</span><span class="s">&quot;breakpoint&quot;</span><span class="p">);</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">        </span><span class="c1">// kernel exception, unexpected.</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">kernel_panic</span><span class="p">;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="p">}</span>
</code></pre></div>
<p>写下 ? 处应该填什么。使用 <code>make run</code> 运行内核，你观察到了什么？并解释运行结果。</p>
</div>
<div class="admonition question">
<p class="admonition-title">Question 3</p>
<p>RISC-V 特权级手册，Section <code>3.3.1 Environment Call and Breakpoint</code> 解释 <code>ecall</code> 和 <code>ebreak</code> 指令如下：</p>
<blockquote>
<p>ECALL and EBREAK cause the receiving privilege mode’s epc register to be set to the address of
the ECALL or EBREAK instruction itself, not the address of the following instruction. As ECALL
and EBREAK cause synchronous exceptions, they are not considered to retire, and should not
increment the minstret CSR.</p>
</blockquote>
<p>请你在 <code>debugf("breakpoint");</code> 后面加一条代码，实现在退出 Trap 后能执行后续的指令，而不是重复执行 <code>ebreak</code>。</p>
<p>Note: 你可以在 <code>build/kernel.asm</code> 里面查阅整个内核镜像的反汇编结果，即每个地址上是什么指令。</p>
<p>Note2: 你可以使用在 <code>riscv.h</code> 头文件中定义的函数 <code>w_sepc()</code> 和 <code>r_sepc()</code> 读写 <code>sepc</code> 寄存器。</p>
</div>
<h2 id="interrupt">Interrupt<a class="headerlink" href="#interrupt" title="Permanent link">&para;</a></h2>
<p>RISC-V 规范定义了每个 Hart 的 M/S mode 各有三种标准的中断：时钟中断 (Timer)、软件中断 (Software) 和外部中断 (External)。</p>
<h3 id="interrupt_1">什么时候能处理 Interrupt<a class="headerlink" href="#interrupt_1" title="Permanent link">&para;</a></h3>
<p>RISC-V 定义了三种标准的中断：Software Interrupt, Timer Interrupt 和 External Interrupt，对应 scause 中的 Exception Code 1, 5, 9， 对应 sip/sie 中的第 1, 5, 9 bit。</p>
<!-- 中断源会拉高 Hart 的 sip 中的 bit，Hart 会判断当前能否进入中断。 -->

<p>当 Interrupt 到来时，RISC-V 核心会检测当前是否能够处理中断，即是否能进入 Trap：</p>
<ul>
<li>(当前运行在 S 模式，且 <code>sstatus.SIE</code> == 1) 或者 当前运行在 U 模式。</li>
<li>中断类型 bit i 在 <code>sie</code> 和 <code>sip</code> 中均为 1.</li>
</ul>
<blockquote>
<p>An interrupt i will trap to S-mode if both of the following are true:</p>
<p>(a) either the current privilege mode is S and the SIE bit in the sstatus register is set, or the current privilege mode has less privilege than S-mode; and</p>
<p>(b) bit i is set in both sip and sie.</p>
</blockquote>
<p>当 Software/Timer/External Interrupt 到达 CPU 时，<code>sip</code> 中对应的 bit 会被拉高，然后 CPU 会按照如上条件进行检查，如果符合条件，则会进入 Trap。</p>
<h3 id="_3">时钟中断<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>时钟中断可以理解为每隔一段时间执行一次的程序。即每隔一段时间，会固定触发一次的中断。在时钟中断的处理时，我们可以完成进程调度等操作。</p>
<p>RISC-V 平台提供了一个实时的时间计数器: <code>time</code> 寄存器，该寄存器以恒定的频率增长，并且在所有核心之间共享。另外，RISC-V 对每个核心的提供了一个 <code>timecmp</code> 寄存器，每当 <code>time &gt;= timecmp</code> 时，该核心就会拉高时钟中断的 <code>sip.STIP</code> bit，如果核心满足进入中断 Trap 的条件，则会进入 Trap 。</p>
<p>SBI 提供了一个 SBI call：<code>SBI_SET_TIMER</code> 允许 Supervisor 软件设置 <code>timecmp</code> 寄存器。在已知 time 寄存器的增长频率后，我们可以计算一定时间 (如 10ms) 内 time 会增长多少，并设置 timecmp 为该值，我们即可在 10ms 后收到一次时钟中断。在每次进入时钟中断时，我们再次计算并设置下次的 timecmp，由此实现每 10ms 收到一次时间中断。</p>
<p>时钟部分的代码位于 <code>timer.c</code>。</p>
<p>在初始化时钟中断时，我们通过 SBI call <code>SET_TIMER</code> 设置 <code>timecmp</code>，并在 <code>sie</code> 中启用时钟中断 <code>SIE_STIE</code>。</p>
<p>在 <code>kernel_trap</code> 中处理时钟中断时，我们计算下一次的 <code>timecmp</code>，并再次 SBI call <code>SET_TIMER</code>，循环往复。</p>
<div class="admonition question">
<p class="admonition-title">Lab 实验报告 - Question 4</p>
<p>将 <code>main.c</code> 中的 <code>asm volatile("ebreak" ::: "s11");</code> 一行代码注释掉，并将 <code>intr_on()</code> 取消注释。</p>
<p>使用 <code>make run</code> 后观察每次触发时钟中断时的 cycle 读数。</p>
<p>注释掉 <code>trap.c</code> 中 <code>kernel_trap</code> 调用 <code>set_next_timer()</code>，并再次 <code>make run</code> 观察每次触发时钟中断时的 cycle 读数。</p>
<p>请解释现象和为什么会这样。</p>
</div>
<div class="admonition info">
<p class="admonition-title">mtimecmp 和 stimecmp</p>
<p>实际上，标准的 RISC-V 特权级手册只定义了 M-mode 的 <code>mtimecmp</code> 寄存器。S mode 的软件需要使用 SBI call 设置时钟中断，这实际上是通过 OpenSBI 设置 <code>mtimecmp</code> ，并在 <code>mtvec</code> 中将 <code>STIP</code> 置 1 来实现为 S mode 设置时钟中断的。这也体现了 RISC-V 硬件设计上能不管就不管的原则，以及 M mode 通过 emulate 来为上层软件模拟行为。</p>
<p>实际上，特权级切换是一个相当耗时的操作，为了改进 Supervisor 时间中断的性能，RISC-V 规定了 Sstc 扩展，创建了 <code>stimecmp</code> CSR，允许 Supervisor 直接设置其时钟中断计数器。</p>
<p>我们可以在 QEMU 的 CPU flags 中将 Sstc 扩展禁用掉（<code>-cpu rv64,sstc=off</code>），来观察 OpenSBI 在没有 Sstc 时的行为。我们可以直接使用命令 <code>qemu-system-riscv64 -nographic -machine virt -cpu rv64,svadu=off,sstc=off -m 512 -kernel build/kernel  -S -gdb tcp::3333</code> 来启动一个带调试器的 qemu。</p>
<p>挂载 GDB 后，我们是用 <code>c</code> (continue) 命令继续执行，当 QEMU 输出出现 <code>kernel_trap: s-timer interrupt</code> 时，在 GDB 终端中按 Ctrl-C 中断执行，使用<code>print $mtvec</code> 得到 M mode 的中断向量地址，并使用 <code>b *0x800004f0</code> 在中断向量上打断点。</p>
<p>使用 <code>c</code> 继续执行，在命中 <code>0x800004f0</code> 的断点时，我们使用 <code>print $mcause</code> 查询 M mode 的 Trap 原因。</p>
<p>我们应该会看到，在没有 <code>Sstc</code> 时，mcause 会有两个值 <code>0x8000000000000007</code> 和 <code>0x9</code>，分别对应着 M-mode Timer Interrupt 和来自 S-mode 的 <code>ecall</code>。如果有 <code>Sstc</code> 扩展，我们会发现 <code>mcause</code> 只会有 <code>0x9</code> 一种值。这种情况下，使用 SBI_SET_TIMER 时，OpenSBI 会直接设置 <code>stimecmp</code> 寄存器，避免了 S mode 的时钟中断通过 OpenSBI 路由。</p>
</div>
<h3 id="_4">外部中断<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>我们之前描述中断与 Trap 时，我们说的是 "当 Interrupt 到来时，RISC-V 核心..."。所以，外部中断是如何来到每个核心的？</p>
<p>PLIC (Platform-Level Interrupt Controller) 是 RISC-V 平台上用于管理外部中断的 IP 核，每个 RISC-V 平台拥有多个核心 (Hart)，而每个平台一般只有一个 PLIC。</p>
<p>简而言之，每个外设均会向 PLIC 通报自己有中断需要处理，而每个设备的中断均有一个中断号，PLIC 会根据预先配置的规则，将该中断路由 (Routing) 给某(些)核心处理，并拉起该核心的 mip.MEIP/sip.SEIP 以请求中断核心。</p>
<p>核心需要向 PLIC 声明 (Claim) 自己来负责处理这个中断，并在处理完毕后声明自己完成了这个中断的处理 (Complete)。</p>
<p>Specification: <a href="https://github.com/riscv/riscv-plic-spec/blob/master/riscv-plic.adoc">https://github.com/riscv/riscv-plic-spec/blob/master/riscv-plic.adoc</a></p>
<div class="admonition info">
<p class="admonition-title">AMD64 和 Aarch64</p>
<p>x86 (IA32)，x86-64 (AMD64) 和 ARM 平台上也有类似的全局中断处理器：<a href="https://wiki.osdev.org/8259_PIC">PIC</a>, <a href="https://wiki.osdev.org/APIC">APIC</a>, <a href="https://developer.arm.com/documentation/198123/0302/What-is-a-Generic-Interrupt-Controller-">GIC</a></p>
</div>
<h4 id="plic">PLIC 结构<a class="headerlink" href="#plic" title="Permanent link">&para;</a></h4>
<p>PLIC 可以管理 1~1023 个中断源，每个中断源拥有一个优先级 Priority 。PLIC 将能够接收中断的对象 (Interrupt Targets) 称为 Hart Context (where a hart context is a given privilege mode on a given hart)，每个 Context 可以视为一个二元组 (Hart ID, Privilege Level) 对应着一个 Hart 和一个特权级别。由于目前 RISC-V 没有规定 User-Mode Interrupt，（RISC-V privilege spec 只规定了 mie/mip 和 sie/sip，对应着 Machine Mode 和 Supervisor Mode 的中断），我们可以认为每个核心拥有两个 Context，分别对应着该 Hart 的 M mode 和 S mode 的外部中断。</p>
<p>PLIC 能够管理 0~15871 个 Context，能设置每个中断源是否允许路由至某个 Context (Enabled Bit)，每个 Context 能接收的 Priority Threshold。</p>
<p>PLIC 会拉起 Hart 的 mip.MEIP/sip.SEIP bit，而该 hart 是否进入 Interrupt 的 Trap 由上述 <code>进入中断的条件</code> 决定。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/plic-structure.png" /></p>
<h4 id="memory-mapped-register">Memory-Mapped Register<a class="headerlink" href="#memory-mapped-register" title="Permanent link">&para;</a></h4>
<p>PLIC 使用 Memory-Mapped Register 向系统暴露管理接口。对于每个寄存器，我们使用偏移量来定位每个寄存器。通常，这种 IP 核有着固定的基地址，在 QEMU 上，对于 PLIC 这个基地址是 <code>0x0c00_0000</code>。</p>
<div class="admonition info">
<p class="admonition-title">Memory-Mapped Register, MMIO</p>
<p>Memory Mapped Register（内存映射寄存器）是一种在计算机体系结构中用于外围设备和硬件控制的重要技术。</p>
<p>Memory-Mapped Register 是指将硬件设备的寄存器直接映射到处理器的内存地址空间中。这意味着 CPU 可以像访问内存那样访问某个地址，而该地址实际上对应着某个设备内部的寄存器。</p>
<p>使用 Memory-Mapped Register 进行的 IO 操作即称为 Memory-Mapped I/O (MMIO)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>gef &gt; monitor info mtree
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    000000000c000000-000000000c5fffff (prio 0, i/o): riscv.sifive.plic
</code></pre></div>
</div>
<p>例如，Specification 中的 Memory Map 规定，<code>base + 0x4 * i</code> 是第 i 个中断源的</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>base + 0x000000: Reserved (interrupt source 0 does not exist)
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>base + 0x000004: Interrupt source 1 priority
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>base + 0x000008: Interrupt source 2 priority
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>...
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>base + 0x000FFC: Interrupt source 1023 priority
</code></pre></div>
<p>在 <code>plicinit</code> 中，我们向 <code>base + 10*4 = 1</code> 设置 UART0 (10号中断) 的 Interrupt Priority 为 1。在 <code>plicinithart</code> 中，我们将该 Hart 的 S-mode Context 允许来自 10 号中断、并设置 Priority Threshold 为 0。最后，启用该核心的 <code>sie.SEIE</code> 位，表示该核心允许 Supervisor-Mode External Interrupt。在 <code>main.c</code> 的 <code>while(1)</code> 循环前，我们使用 <code>intr_on</code> 打开整个 CPU 的 S mode 中断。</p>
<h4 id="claim-complete">Claim &amp; Complete<a class="headerlink" href="#claim-complete" title="Permanent link">&para;</a></h4>
<p>在 Hart 因为 External Interrupt 陷入 Trap 后，Hart 需要向 PLIC 申请处理该中断。在处理完成后，Hart 还需要向 PLIC 申明该中断处理完毕。</p>
<p><img alt="alt text" src="../../assets/xv6lab-interrupts/PLICInterruptFlow.jpg" /></p>
<h4 id="_5">串口中断<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>在 QEMU 平台上，串口所使用的设备模型是 uart8250。它的 MMIO 接口暴露了 8 个寄存器。具体的细节可见：<a href="https://www.lammertbies.nl/comm/info/serial-uart">https://www.lammertbies.nl/comm/info/serial-uart</a></p>
<p>uart8250 具有一个读口和一个写口，分别是 <code>RHR</code> 和 <code>THR</code>，它们在寄存器 <code>LSR</code> 中各有一个 bit 表示读口有数据和写口空闲。读取和写入的函数位于 <code>uartgetc</code> 和 <code>uart_putchar</code>。</p>
<p>在串口初始化函数 <code>console_init</code> 中，我们向 uart8250 的 MMIO 地址中的 <code>IER</code> 寄存器写入特殊的标志位，表示我们允许 uart8250 设备在有输入的时候产生中断。随后，我们向 PLIC 注册该设备的中断号 10，将其路由到当前核心的 S mode 下，并在 <code>kernel_trap</code> 中对其处理。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SCAUSE_INTERRUPT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="c1">// handle interrupt</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">exception_code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SupervisorExternal</span><span class="p">:</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">            </span><span class="n">debugf</span><span class="p">(</span><span class="s">&quot;s-external interrupt.&quot;</span><span class="p">);</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">            </span><span class="n">plic_handle</span><span class="p">();</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="p">}</span>
</code></pre></div>
<p><code>plic_handle</code> 函数会从 PLIC Claim 得到当前外部中断来源的中断号，如果它是 UART0 的中断号 10，那么就交给 <code>uart_intr()</code> 函数处理。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-copyright">
    <div class="md-copyright__highlight">
        commit: 
        <a href="https://github.com/yuk1i/os-next-docs/commit/d08edb47, 2025-04-09 21:31:50+08:00" target="_blank" rel="noopener">
            d08edb47, 2025-04-09 21:31:50+08:00
        </a>
    </div>
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>