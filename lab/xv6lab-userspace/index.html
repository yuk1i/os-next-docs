
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../xv6lab-paging/">
      
      
        <link rel="next" href="../xv6lab-userprocess/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Week 7 - 用户空间 Userspace - 操作系统实验文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-header__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            操作系统实验文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Week 7 - 用户空间 Userspace
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../env/" class="md-tabs__link">
          
  
  实验环境搭建

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab1/" class="md-tabs__link">
          
  
  每周实验

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../laben/lab2/" class="md-tabs__link">
          
  
  Weekly Lab Material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qrh/nav/" class="md-tabs__link">
          
  
  快速参考手册

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-nav__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    操作系统实验文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    实验环境搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            实验环境搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux VM 搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Linux VM 搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/windows-vmware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + VMware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/wsl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + WSL (不推荐)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS + VMware
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    手动环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    验证环境
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    每周实验
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            每周实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 1 - Linux基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C 语言基础及Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - 裸机程序 Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - 上下文切换 Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - 内核页表 Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Week 7 - 用户空间 Userspace
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Week 7 - 用户空间 Userspace
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      实验目的
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      概览
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      用户态和内核态的切换
    </span>
  </a>
  
    <nav class="md-nav" aria-label="用户态和内核态的切换">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kernel-user" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel -&gt; User
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      User -&gt; Kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      用户页表 / 内核页表
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trampoline-trampolines" class="md-nav__link">
    <span class="md-ellipsis">
      Trampoline （trampoline.S）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trampoline （trampoline.S）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trampoline-" class="md-nav__link">
    <span class="md-ellipsis">
      Trampoline - 用户态到内核态
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trampoline - 用户态到内核态">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uservectrampolines" class="md-nav__link">
    <span class="md-ellipsis">
      uservec（trampoline.S）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trampoline-_1" class="md-nav__link">
    <span class="md-ellipsis">
      Trampoline - 内核态到用户态
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trampoline - 内核态到用户态">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usertraprettrapc" class="md-nav__link">
    <span class="md-ellipsis">
      usertrapret（trap.c）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#userrettrampolines" class="md-nav__link">
    <span class="md-ellipsis">
      userret（trampoline.S）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      第一个用户进程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第一个用户进程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      创建用户进程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      第一次到用户空间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      用户空间的第一条代码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      用户空间的退出
    </span>
  </a>
  
    <nav class="md-nav" aria-label="用户空间的退出">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usertraptrapc" class="md-nav__link">
    <span class="md-ellipsis">
      usertrap（trap.c）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#syscall" class="md-nav__link">
    <span class="md-ellipsis">
      系统调用 Syscall
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uaccess" class="md-nav__link">
    <span class="md-ellipsis">
      uaccess
    </span>
  </a>
  
    <nav class="md-nav" aria-label="uaccess">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-write" class="md-nav__link">
    <span class="md-ellipsis">
      read &amp; write
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uaccess_1" class="md-nav__link">
    <span class="md-ellipsis">
      uaccess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 练习
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      相关阅读
    </span>
  </a>
  
    <nav class="md-nav" aria-label="相关阅读">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-mm" class="md-nav__link">
    <span class="md-ellipsis">
      struct mm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mm_mappages" class="md-nav__link">
    <span class="md-ellipsis">
      mm_mappages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#walk" class="md-nav__link">
    <span class="md-ellipsis">
      walk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      程序的加载
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 8 - 进程 Process
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Weekly Lab Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Weekly Lab Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C language basic & Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - Trap & Interrupt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - Userspace
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    快速参考手册
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            快速参考手册
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/nav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/vf2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VisionFive2 板子教程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/ssh-vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH & VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      实验目的
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      概览
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      用户态和内核态的切换
    </span>
  </a>
  
    <nav class="md-nav" aria-label="用户态和内核态的切换">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kernel-user" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel -&gt; User
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      User -&gt; Kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      用户页表 / 内核页表
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trampoline-trampolines" class="md-nav__link">
    <span class="md-ellipsis">
      Trampoline （trampoline.S）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trampoline （trampoline.S）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trampoline-" class="md-nav__link">
    <span class="md-ellipsis">
      Trampoline - 用户态到内核态
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trampoline - 用户态到内核态">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uservectrampolines" class="md-nav__link">
    <span class="md-ellipsis">
      uservec（trampoline.S）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trampoline-_1" class="md-nav__link">
    <span class="md-ellipsis">
      Trampoline - 内核态到用户态
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trampoline - 内核态到用户态">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usertraprettrapc" class="md-nav__link">
    <span class="md-ellipsis">
      usertrapret（trap.c）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#userrettrampolines" class="md-nav__link">
    <span class="md-ellipsis">
      userret（trampoline.S）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      第一个用户进程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第一个用户进程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      创建用户进程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      第一次到用户空间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      用户空间的第一条代码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      用户空间的退出
    </span>
  </a>
  
    <nav class="md-nav" aria-label="用户空间的退出">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usertraptrapc" class="md-nav__link">
    <span class="md-ellipsis">
      usertrap（trap.c）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#syscall" class="md-nav__link">
    <span class="md-ellipsis">
      系统调用 Syscall
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uaccess" class="md-nav__link">
    <span class="md-ellipsis">
      uaccess
    </span>
  </a>
  
    <nav class="md-nav" aria-label="uaccess">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-write" class="md-nav__link">
    <span class="md-ellipsis">
      read &amp; write
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uaccess_1" class="md-nav__link">
    <span class="md-ellipsis">
      uaccess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 练习
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      相关阅读
    </span>
  </a>
  
    <nav class="md-nav" aria-label="相关阅读">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-mm" class="md-nav__link">
    <span class="md-ellipsis">
      struct mm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mm_mappages" class="md-nav__link">
    <span class="md-ellipsis">
      mm_mappages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#walk" class="md-nav__link">
    <span class="md-ellipsis">
      walk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      程序的加载
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="_1">用户空间<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>用户空间 (Userspace) 是操作系统为用户程序提供的一个受限制的运行环境。操作系统通过 CPU 的硬件功能辅助来实现用户空间和内核的隔离，这通常包括：</p>
<ul>
<li>特权级的隔离。用户空间一般使用低特权级运行，使用高特权级指令会触发异常。</li>
<li>内存空间的隔离。内核通过页表为用户空间设置地址空间，而用户空间不能直接访问内核地址。</li>
</ul>
<h2 id="_2">实验目的<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ol>
<li>掌握如何建立用户空间</li>
<li>掌握trampoline原理</li>
<li>理解第一个用户进程的执行过程</li>
<li>理解uaccess的作用</li>
</ol>
<h2 id="_3">概览<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>本次 Lab 中，我们将第一次把 CPU 运行在 U-mode，并运行第一个用户程序。</p>
<p>在第一次作业中，我们亲自实验发现，如果 CPU 在执行 <code>sret</code> 时 <code>sstatus.SPP == 0</code>，那么 CPU 将降级到 U-mode。
当 CPU 降级到 U-mode 后，CPU 只能通过 Trap 回到 S-mode。而 Trap 分为两种：异常（Exception）和中断（Interrupt）。</p>
<ul>
<li>用户程序可以主动地使用 <code>ecall</code> 发起一种异常 Exception: Code 8 (Environment call from U-mode)，这就是 RISC-V 平台上实现系统调用（syscall）的方式。</li>
<li>U-mode 下，<strong>中断永远是开启的</strong>。回顾 <code>Trap, Exception and Interrupt</code> 一章中，我们对 <code>中断到来时，能否进入 Trap</code> 这件事情的描述：（当前运行在 S 模式，且 <code>sstatus.SIE</code> == 1） 或者 当前运行在 U 模式。</li>
</ul>
<p>当你完成这节 Lab 中所描述的细节后，你可以通过下图理解 xv6 中的 userspace 结构。</p>
<p>下图中，蓝色方块表示由 <code>kallocpage</code> 分配的页面，黄色方块表示内核中的代码，绿色方块表示 Trampoline 中的代码。该图展示了内核中的众多数据结构之间的指针关系（黑色箭头），以及内核态用户态之间进行切换时的代码调用过程（红色虚线箭头）。</p>
<p><img alt="alt" src="../../assets/xv6lab-userspace/userspace-kernel-trampoline.png" /></p>
<div class="admonition warning">
<p class="admonition-title">xv6-lab5 代码分支</p>
<p><a href="https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab5">https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab5</a></p>
<p>使用命令 <code>git clone https://github.com/yuk1i/SUSTech-OS-2025 -b xv6-lab5 xv6lab5</code> 下载 xv6-lab5 代码。</p>
<p>使用 <code>make run</code> 运行本次 Lab 的内核，它会启动第一个用户进程 <code>init</code>，其源代码为 <code>user/src/init.c</code>。</p>
</div>
<h2 id="_4">用户态和内核态的切换<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>RISC-V CPU 运行时会处于某个特权级状态。操作系统运行在 S mode，而用户模式处于 U mode。</p>
<p>我们将分别讲解如何从 S mode 降级到 U mode，以及如何从 U mode 回到 S mode。</p>
<h3 id="kernel-user">Kernel -&gt; User<a class="headerlink" href="#kernel-user" title="Permanent link">&para;</a></h3>
<p>在 Interrupts 一章中，我们学习了 sret 指令完成的三件事情：</p>
<ol>
<li>sstauts.SIE &lt;= sstatus.SPIE</li>
<li>Current_Privilege_Level &lt;= sstauts.SPP</li>
<li>pc &lt;= epc</li>
</ol>
<p>用中文：还原 <code>sstatus.SIE</code> 为 <code>sstatus.SPIE</code>，将特权级(U/S)设置为 <code>sstauts.SPP</code>，将 PC 设置为 <code>sepc</code>。</p>
<p>在 CSR <code>sstatus</code> 中，<code>SPP</code> 的描述如下：</p>
<p>The SPP bit indicates the privilege level at which a hart was executing before entering supervisor mode.
When a trap is taken, SPP is set to 0 if the trap originated from user mode, or 1 otherwise.
When an SRET instruction (see Section 3.3.2) is executed to return from the trap handler, the privilege level is set to user mode if the SPP bit is 0, or supervisor mode if the SPP bit is 1; SPP is then set to 0.</p>
<p>所以说，只要在 <code>sret</code> 执行时，<code>sstatus.SPP</code> 为 0，我们即可降级到 U mode 下。（这其实并不要求我们一定处于 Trap Handler 中）</p>
<h3 id="user-kernel">User -&gt; Kernel<a class="headerlink" href="#user-kernel" title="Permanent link">&para;</a></h3>
<p>若 CPU 运行在 U mode 下，CPU 通过触发 Trap 来回到 S mode，这通常包括：</p>
<ul>
<li>中断。包含时钟中断、外部中断等。</li>
<li>
<p>异常通常包括：</p>
<ul>
<li>Illegal Instruction</li>
<li>(Load, Store, Fetch) Page Fault</li>
<li>Environment call (<strong>这是 RISC-V 的 syscall 方式</strong>， 即 ecall )</li>
</ul>
</li>
</ul>
<p>当需要进行系统调用时，用户程序可以使用 <code>ecall</code> 指令主动触发一次 Trap，而这将使 CPU 通过 Trap 回到 S mode.</p>
<div class="admonition note">
<p class="admonition-title">ecall</p>
<p>还记得吗，之前我们曾在 S mode 使用 <code>ecall</code> 指令调用 M mode 提供的接口。</p>
<p>环境调用即通过引发环境调用异常来请求执行环境。</p>
</div>
<h2 id="_5">用户页表 / 内核页表<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>在上一节 Lab 中，我们介绍了 RISC-V 的页表模型，并且为内核设置了页表。在 PTE 中的第 4 个 bit U 表示该映射关系是否允许在用户模式下访问。</p>
<p>本次lab中，我们引入用户空间，用户进程需要运行在用户空间上。
因此，我们将 512 GiB 的地址切分为用户地址（低地址）和内核地址（高地址），用户地址为 <code>0x0000_00</code> 开头，而内核地址以 <code>0xffff_ff</code> 开头。</p>
<p>每一个用户进程都需要有自己独立的地址空间，所以，对于每一个用户程序，我们都为它创建一个单独的页表。我们将其称为 <strong>用户页表</strong> 。</p>
<p>在 xv6 中，用户页表并不包含内核页表项目，也就是说不包含内核镜像的代码、数据和 Direct Mapping 等。那么在需要在 S mode 和 U mode 之前切换时，就产生了一个问题：</p>
<p>想象一下，目前用户进程使用的是用户页表，此时在用户进程运行过程中发生了一个 Trap ，将要进入 S mode 。而在进入 Trap Handler 前，CPU 需要将 pc 跳转为 <code>stvec</code>，但是此时 CPU 仍然还使用着原来的 <code>satp</code>，即 U mode 时所用的用户页表，该页表并不包含内核空间的地址映射，即内核的中断处理入口函数的地址 <code>stvec</code> 在用户空间下是不可用的。这就出现了问题。</p>
<p>因此，我们不能直接在 U mode 下使用内核所用的 <code>stvec</code> (<code>0xffff_ffff_8020_xxxx</code>)。这个问题与我们在实现 Relocation 时所遇到的问题类似。</p>
<p>所以，我们需要为 U mode 设置一个专门的 Trap Handler，并且，我们使其在内核页表和用户页表中都具有 <strong>相同的虚拟地址</strong> 。这样，我们在从 U mode 通过 Trap 回到 S mode 时，能在内核态 + 用户页表的环境下执行代码。</p>
<!-- 在我们需要 S mode -> U mode 时，我们切换到用户页表，并设置用户的 `stvec` 为该代码页面中的一个简易 Trap Handler。而在进入该 Trap Handler 时，即 U mode -> S mode 时，我们切换回内核的页表和内核的 `stvec`，保存用户的执行环境，并恢复内核的运行环境。 -->

<p>我们将包含这段代码的特殊页面称为 Trampoline，并将其映射到 <code>0x0000_003f_ffff_f000</code>。</p>
<h2 id="trampoline-trampolines">Trampoline （trampoline.S）<a class="headerlink" href="#trampoline-trampolines" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Trampoline n. 蹦床</p>
</blockquote>
<p>在 xv6 中，Trampoline 是两段特殊的代码 <code>uservec</code> 和 <code>userret</code>，分别用于从用户态切换回内核态（即用户态下的 <code>stvec</code>），和从内核切换到用户态。</p>
<p>Trampoline 的虚拟地址 <code>0x0000_003f_ffff_f000</code> 在 <strong>内核页表和每个用户页表</strong> 中都是存在的，所以我们可以放心的切换用户和内核的 <code>satp</code> 而不用担心当前 pc 会变得非法了（回忆我们在上一章 Relocation 中遇到的问题）。</p>
<h3 id="trampoline-">Trampoline - 用户态到内核态<a class="headerlink" href="#trampoline-" title="Permanent link">&para;</a></h3>
<p>当我们需要从 U mode 进入 S mode（通过 Trap ），我们需要通过 <code>uservec</code> 切换内核页表，并运行用户的 Trap Handler -- usertrap 。</p>
<h4 id="uservectrampolines">uservec（trampoline.S）<a class="headerlink" href="#uservectrampolines" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="w">    </span><span class="na">.section</span><span class="w"> </span><span class="no">trampsec</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="na">.globl</span><span class="w"> </span><span class="no">trampoline</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nl">trampoline:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="na">.globl</span><span class="w"> </span><span class="no">uservec</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="nl">uservec:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">        </span><span class="c1"># trap.c sets stvec to point here, so</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">        </span><span class="c1"># traps from user space start here,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">        </span><span class="c1"># in supervisor mode, but with a user page table.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">        </span><span class="c1">#</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">        </span><span class="c1"># sscratch points to where the process&#39;s p-&gt;trapframe is</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">        </span><span class="c1"># mapped into user space, at TRAPFRAME.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="c1"># swap a0 and sscratch, so that a0 is TRAPFRAME</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">        </span><span class="nf">csrrw</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">sscratch</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">        </span><span class="c1"># save the user registers (x1 - x31) in TRAPFRAME</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">        </span><span class="nf">sd</span><span class="w"> </span><span class="no">ra</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">        </span><span class="nf">sd</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">        </span><span class="c1"># ...</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">        </span><span class="nf">sd</span><span class="w"> </span><span class="no">t5</span><span class="p">,</span><span class="w"> </span><span class="mi">272</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">        </span><span class="nf">sd</span><span class="w"> </span><span class="no">t6</span><span class="p">,</span><span class="w"> </span><span class="mi">280</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">        </span><span class="c1"># we have saved t0, so we can smash it</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">        </span><span class="c1"># resotre a0 from sscratch, and save it</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">        </span><span class="nf">csrr</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">sscratch</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">        </span><span class="nf">sd</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">        </span><span class="c1"># save epc</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="w">        </span><span class="nf">csrr</span><span class="w"> </span><span class="no">t1</span><span class="p">,</span><span class="w"> </span><span class="no">sepc</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">        </span><span class="nf">sd</span><span class="w"> </span><span class="no">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">        </span><span class="c1"># load kernel&#39;s satp, sp, usertrap handler, tp(cpuid)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">        </span><span class="nf">ld</span><span class="w"> </span><span class="no">t1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="w">        </span><span class="nf">ld</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="w">        </span><span class="nf">ld</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="w">        </span><span class="nf">ld</span><span class="w"> </span><span class="no">tp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="w">        </span><span class="nf">csrw</span><span class="w"> </span><span class="no">satp</span><span class="p">,</span><span class="w"> </span><span class="no">t1</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="w">        </span><span class="nf">sfence.vma</span><span class="w"> </span><span class="no">zero</span><span class="p">,</span><span class="w"> </span><span class="no">zero</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="w">        </span><span class="nf">jr</span><span class="w"> </span><span class="no">t0</span>
</code></pre></div>
<p>在 Trampoline 的 <code>uservec</code> 中，所有 GPR (x1-x31) 均为用户程序正在使用的，我们需要在执行 <code>userret</code> 中的 <code>sret</code> 时保持所有 GPR 与我们进入 <code>uservec</code> 时一致，这个要求与我们处理内核 Trap 时是一致的。</p>
<p>在处理内核的 Trap 时，我们直接在内核栈上构建了 <code>struct ktrapframe</code> 结构体，用于保存所有 GPR。类似的，我们将保存用户寄存器的地方称为 <code>Trapframe</code> ，大小小于一个页面。并且，我们将其映射到用户页表中的一个固定地址 <code>0x0000_003f_ffff_e000</code> ，即 trampoline 下一个页面。</p>
<p><code>struct trapframe</code> 定义在 <code>proc.h</code> 中：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="cm">/*   0 */</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_satp</span><span class="p">;</span><span class="w">    </span><span class="c1">// kernel page table</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="cm">/*   8 */</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_sp</span><span class="p">;</span><span class="w">      </span><span class="c1">// top of process&#39;s kernel stack</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="cm">/*  16 */</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_trap</span><span class="p">;</span><span class="w">    </span><span class="c1">// usertrap()</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="cm">/*  24 */</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">epc</span><span class="p">;</span><span class="w">            </span><span class="c1">// saved user program counter</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="cm">/*  32 */</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_hartid</span><span class="p">;</span><span class="w">  </span><span class="c1">// saved kernel tp</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="cm">/*  40 */</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">ra</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="cm">/*  48 */</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="cm">/*  ... */</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="cm">/* 272 */</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">t5</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="cm">/* 280 */</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">t6</span><span class="p">;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="p">};</span>
</code></pre></div>
<p>由于 RISC-V 的指令的 destination 均为寄存器，不能是立即数，而我们在保存用户寄存器前不能修改寄存器的内容，所以我们起码需要一个能修改的寄存器来表示 <code>0x0000_003f_ffff_e000</code> 这个 trapframe 的地址。RISC-V 提供了一个 <code>sscratch</code> 寄存器来给 Trap Handler 一个暂存寄存器的地方。我们可以使用 <code>csrrw a0, sscratch, a0</code> 交换 <code>sscratch</code> 和 <code>a0</code> 寄存器。这样，用户的 a0 寄存器就被保存到了 <code>sscratch</code> 中，而 <code>sscratch</code> 中的内容就来到 <code>a0</code> 中。</p>
<p>我们规定，在操作系统初始化完成后， <code>sscratch</code> 寄存器保存着用户页表中 Trapframe 所映射的虚拟地址，即 <code>0x0000_003f_ffff_e000</code>。
在进入 <code>uservec</code> 后，我们交换 a0 和 sscratch，此时 a0 为 <code>0x0000_003f_ffff_e000</code>。
随后，我们用 <code>sd ra, 40(a0)</code> 等汇编指令来保存除了 a0 以外的所有用户寄存器。在保存用户寄存器后，我们能够修改所有寄存器了，我们将保存在 <code>sscratch</code> 中的用户 <code>a0</code> 读取到 <code>t0</code>，并写入 trapframe 中，至此我们成功保存了所有用户寄存器。然后，我们保存 <code>sepc</code> 到 trapframe 结构体中。</p>
<p>最后，我们从 <code>trapframe</code> 中读取内核相关的数据，如内核页表 <code>t1</code> (<code>kernel_satp</code>)，内核栈 <code>sp</code> (<code>kernel_sp</code>)，内核的 cpuid <code>tp</code> (<code>kernel_hartid</code>)，以及下一阶段的用户 Trap 处理函数 t0 (<code>kenrel_trap</code>)。
在切换回内核的页表后，我们即可跳转 <code>tf-&gt;kernel_trap</code> 进入C语言环境处理 <code>usertrap</code>。</p>
<div class="admonition info 内核栈">
<p class="admonition-title">Info</p>
<p>内核栈有如下几种：</p>
<ul>
<li><code>boot_stack</code>：内核启动时所用的栈。</li>
<li><code>sched_kstack</code>：每个 CPU 的 scheduler 所用的栈。</li>
<li><code>p-&gt;kstack</code>: 每个进程的 <strong>内核线程</strong> 的内核栈。当从 U-mode 来到 S-mode 时，用户模式下的 sp 是不可用的，我们需要切换到该进程的内核栈。</li>
</ul>
</div>
<h3 id="trampoline-_1">Trampoline - 内核态到用户态<a class="headerlink" href="#trampoline-_1" title="Permanent link">&para;</a></h3>
<p>当我们需要从 S mode 进入 U mode（如用户进程第一次运行或用户进程从 Trap 中返回），我们需要调用 <code>usertrapret</code> 方法进行内核态信息的保存并加载用户态的相关信息，再通过 <code>userret</code> 切换到用户页表，并回到sepc记录的地方继续执行。</p>
<h4 id="usertraprettrapc">usertrapret（trap.c）<a class="headerlink" href="#usertraprettrapc" title="Permanent link">&para;</a></h4>
<p><code>usertrapret</code> 先将内核的信息保存到 <code>trapframe</code>，修改 <code>sepc</code> 为中断帧中的sepc ，设置 <code>sstatus</code> 的SPP位 ，计算出用户页表的 <code>satp</code> 和 <code>stvec</code> 值，并跳转到 Trampoline 中的 <code>userret</code> 函数。</p>
<p>在调用 <code>userret</code> 时，我们传入了3个参数，分别是用户的 <code>trapframe</code> 地址，用户页表 <code>satp</code> 值，和 <code>stvec</code> 值。在汇编中，我们可以使用 a0, a1, a2 引用它们。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">//</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1">// return to user space</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1">//</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">usertrapret</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intr_get</span><span class="p">())</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;usertrapret entered with intr on&quot;</span><span class="p">);</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">trapframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_proc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">kernel_satp</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">r_satp</span><span class="p">();</span><span class="w">                                 </span><span class="c1">// kernel page table</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">kernel_sp</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">curr_proc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="p">;</span><span class="w">  </span><span class="c1">// process&#39;s kernel stack</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">kernel_trap</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">usertrap</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">kernel_hartid</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">r_tp</span><span class="p">();</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="n">w_sepc</span><span class="p">(</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span><span class="p">);</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="c1">// set up the registers that trampoline.S&#39;s sret will use to get to user space.</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">    </span><span class="c1">// set S Previous Privilege mode to User.</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_sstatus</span><span class="p">();</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">SSTATUS_SPP</span><span class="p">;</span><span class="w">  </span><span class="c1">// clear SPP to 0 for user mode</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">SSTATUS_SPIE</span><span class="p">;</span><span class="w">  </span><span class="c1">// enable interrupts in user mode</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">    </span><span class="n">w_sstatus</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">    </span><span class="c1">// tell trampoline.S the user page table to switch to.</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">satp</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_SATP</span><span class="p">(</span><span class="n">KVA_TO_PA</span><span class="p">(</span><span class="n">curr_proc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgt</span><span class="p">));</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">stvec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TRAMPOLINE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">uservec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">trampoline</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mh">0x3</span><span class="p">;</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRAMPOLINE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">userret</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">trampoline</span><span class="p">);</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="w">    </span><span class="n">tracef</span><span class="p">(</span><span class="s">&quot;return to user @%p, fn %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span><span class="p">);</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">    </span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">uint64</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="p">))</span><span class="n">fn</span><span class="p">)(</span><span class="n">TRAPFRAME</span><span class="p">,</span><span class="w"> </span><span class="n">satp</span><span class="p">,</span><span class="w"> </span><span class="n">stvec</span><span class="p">);</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="p">}</span>
</code></pre></div>
<h4 id="userrettrampolines">userret（trampoline.S）<a class="headerlink" href="#userrettrampolines" title="Permanent link">&para;</a></h4>
<p>在 userret 中，我们首先通过 usertrapret 中传递的 a1 寄存器内容切换回用户页表，此时我们即可使用 <code>0x0000_003f_ffff_e000</code> 访问到 trapframe，然后将 <code>stvec</code> 从内核的中断处理入口 <code>kernel_trap_entry</code> 设置为用户的中断处理入口 <code>uservec</code> 。</p>
<p>之后，我们将用户的 a0 存入 <code>sscratch</code>，然后从 trapframe 中恢复了其他用户寄存器。最后，我们使用 <code>csrrw a0, sscratch, a0</code> 交换 a0 和 <code>sscratch</code>，此时 a0 为用户的 a0，<code>sscratch</code> 是 trapframe 的虚拟地址 <code>0x0000_003f_ffff_e000</code>。</p>
<p>在 userret 的最后，我们执行 sret ，切换至 U mode，跳转至 sepc 存储的位置继续执行。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="na">.globl</span><span class="w"> </span><span class="no">userret</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nl">userret:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">        </span><span class="c1"># userret(TRAPFRAME, pagetable, stvec)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">        </span><span class="c1"># switch from kernel to user.</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">        </span><span class="c1"># usertrapret() calls here.</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">        </span><span class="c1"># a0: TRAPFRAME, in user page table.</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">        </span><span class="c1"># a1: user page table, for satp.</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">        </span><span class="c1"># switch to the user page table.</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">        </span><span class="nf">csrw</span><span class="w"> </span><span class="no">satp</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">        </span><span class="nf">sfence.vma</span><span class="w"> </span><span class="no">zero</span><span class="p">,</span><span class="w"> </span><span class="no">zero</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">        </span><span class="c1"># switch to the user stvec.</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">        </span><span class="nf">csrw</span><span class="w"> </span><span class="no">stvec</span><span class="p">,</span><span class="w"> </span><span class="no">a2</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">        </span><span class="c1"># put the saved user a0 in sscratch, so we</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">        </span><span class="c1"># can swap it with our a0 (TRAPFRAME) in the last step.</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">        </span><span class="nf">ld</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">        </span><span class="nf">csrw</span><span class="w"> </span><span class="no">sscratch</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">        </span><span class="c1"># restore all but a0 from TRAPFRAME</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">        </span><span class="nf">ld</span><span class="w"> </span><span class="no">ra</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">        </span><span class="nf">ld</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">        </span><span class="c1"># ...</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="w">        </span><span class="nf">ld</span><span class="w"> </span><span class="no">t5</span><span class="p">,</span><span class="w"> </span><span class="mi">272</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="w">        </span><span class="nf">ld</span><span class="w"> </span><span class="no">t6</span><span class="p">,</span><span class="w"> </span><span class="mi">280</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">        </span><span class="c1"># restore user a0, and save TRAPFRAME in sscratch</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">        </span><span class="nf">csrrw</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">sscratch</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">        </span><span class="c1"># return to user mode and user pc.</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">        </span><span class="c1"># usertrapret() set up sstatus and sepc.</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">        </span><span class="nf">sret</span>
</code></pre></div>
<h2 id="_6">第一个用户进程<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>在这个部分，我们需要理解操作系统在启动后，如何由 S mode 切换到 U mode 运行起第一个用户进程，并理解如何在用户进程中对 Trap 进行相应。</p>
<h3 id="_7">创建用户进程<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>操作系统启动后，通过在 <code>bootcpu_init</code> 中调用 <code>load_init_app</code> 函数会加载第一个用户进程，我们称之为 <code>init</code> 进程。<code>allocproc</code> 会创建并初始化 init 进程的 PCB，<code>load_user_elf</code> 会将加载 init 进程的 ELF 文件到 PCB <code>p</code> 中，<code>add_task</code> 将它丢进 <code>scheduler</code> 的队列中，等待第一次调度。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">load_init_app</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">user_app</span><span class="w"> </span><span class="o">*</span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_elf</span><span class="p">(</span><span class="n">INIT_PROC</span><span class="p">);</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocproc</span><span class="p">();</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="n">load_user_elf</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="n">add_task</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="n">init_proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="p">}</span>
</code></pre></div>
<p>在 Context Switch 一章，<code>allocproc</code> 会初始化 <code>struct proc</code> 中的 pid, state 等字段，以及初始化 context 为 <code>sched_first_ret</code>。而在本章中，我们多了用户模式，<code>allocproc</code> 额外完成了：在用户内存地址映射 trampoline 到内核源代码中的特殊页面，创建 trapframe 的空间，将其映射到用户内存地址，并保存其 KVA（内核虚拟地址）到 <code>p-&gt;trapframe</code>。</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">allocproc</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nl">found</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="c1">// ==== Resources Allocation ====</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">allocpid</span><span class="p">();</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USED</span><span class="p">;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="c1">// create struct mm for user memory management.</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">mm_create</span><span class="p">();</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="c1">// map trampoline to user address `TRAMPOLINE`</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="n">mm_mappageat</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">TRAMPOLINE</span><span class="p">,</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">trampoline</span><span class="p">),</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">);</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="c1">// allocate a physical page for trapframe.</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">__pa</span><span class="w"> </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">kallocpage</span><span class="p">();</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">    </span><span class="n">mm_mappageat</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">TRAPFRAME</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">    </span><span class="c1">// ==== Resources Allocation Ends ====</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">    </span><span class="c1">// prepare trapframe and the first return context.</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">PA_TO_KVA</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w">    </span><span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="p">);</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">    </span><span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">first_sched_ret</span><span class="p">;</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="p">;</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="p">}</span>
</code></pre></div>
<code>load_user_elf</code> 中，会将用户程序的 <code>epc</code> 等信息写入进程的中断帧中。
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="w">    </span><span class="c1">// setup trapframe</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">sp</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a0</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a1</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">uargv_ptr</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">RUNNABLE</span><span class="p">;</span>
</code></pre></div></p>
<p>至此，第一个用户进程加载并创建完成。</p>
<h3 id="_8">第一次到用户空间<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>与 Context Switch 章节中类似，在 <code>scheduler</code> 通过 <code>swtch</code> 切换到用户进程后， <code>first_sched_ret</code> 是一个进程第一次被 scheduler 调度到时执行的函数，它会按照 scheduler 规范释放 <code>p-&gt;lock</code>，并且跳转到 <code>usertrapret</code> 继续执行（见Trampoline部分）。由于我们在用户进程的中断帧中已经存储了用户程序的入口等相关信息，在 <code>userret</code> ‘恢复’用户进程的状态后， sret 将让用户进程正式开始在用户空间运行。</p>
<h3 id="_9">用户空间的第一条代码<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>用户空间的代码并不是 <code>init.c</code> 的入口代码，我们在 <code>user/lib/user.ld</code> 定义了用户程序的 Linker Script，里面指定了 ELF 入口 entry 是 <code>__start_main</code> 函数，该函数在 <code>user/lib/start_main.c</code> 中被定义。</p>
<p>该函数会调用 main 函数，并将其返回值作为 exit 的退出状态码，这允许我们在 main 函数中使用 <code>return</code> 来退出程序而不要求用户使用 exit 系统调用来保证进程的正常结束。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;syscall.h&quot;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="p">);</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&quot;.text.entry&quot;</span><span class="p">)))</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__start_main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="p">{</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">));</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="p">}</span>
</code></pre></div>
<h3 id="_10">用户空间的退出<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>用户进程运行结束后将在用户空间调用 <code>exit</code> 系统调用使得进程正常退出，并唤醒父进程进行资源的回收。</p>
<p><code>exit</code> 将执行 <code>user\lib\usys.pl</code> 生成的代码，通过将 exit 系统调用对应的system call number 放入 a7 寄存器后，执行 ecall 指令，触发环境调用 Trap 切换入 S mode 进行系统调用的相关内核代码执行流程。（如用户进程执行过程中发生 Trap ，也是同样的流程）</p>
<p>ecall 指令执行后，由于用户 <code>stvec</code> 寄存器中存储的是 <code>uservec</code> ，因而跳转至 Trampoline 的 uservec 部分代码进入 S mode (详细介绍见Trampoline部分)，uservec 的最后将跳转至用户中断处理程序 usertrap 进行相应的中断处理。</p>
<h4 id="usertraptrapc">usertrap（trap.c）<a class="headerlink" href="#usertraptrapc" title="Permanent link">&para;</a></h4>
<p>在 <code>usertrap</code> 中，我们先将 stvec 设置为 <code>kerneltrap</code>，以此捕捉之后在内核态可能出现的中断和异常。随后读取 scause 处理异常。最后，使用 <code>usertrapret</code> 返回用户空间。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">usertrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="n">set_kerneltrap</span><span class="p">();</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">intr_get</span><span class="p">());</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">r_sstatus</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SSTATUS_SPP</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;usertrap: not from user mode&quot;</span><span class="p">);</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">trapframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_proc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_scause</span><span class="p">();</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="c1">// handle usertrap according to scause</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">intr_get</span><span class="p">());</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">    </span><span class="n">usertrapret</span><span class="p">();</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="p">}</span>
</code></pre></div>
<p>exit 作为一个系统调用会通过中断处理的 ecall 分支调用 syscall() 方法执行相应的系统调用。由于它是一个不会返回的方法，自此操作系统回到 S mode 进行相应的回收处理，并准备下一次调度。用户进程正式结束。 </p>
<h4 id="syscall">系统调用 Syscall<a class="headerlink" href="#syscall" title="Permanent link">&para;</a></h4>
<p>系统调用（System Call）是操作系统提供给应用程序的接口，允许用户程序请求操作系统内核的服务。系统调用也有自己的调用规定（calling convention），你可以使用 <code>man 2 syscall</code> 查看不同平台上 Linux 的 syscall 调用规约。</p>
<p>RISC-V 上，系统调用由 <code>ecall</code> 指令发起，syscall number 即调用哪个 syscall 在 a7 寄存器中指定，6个参数在 a0-a5 中指定，系统调用的返回值则在 a0 与 a1 中。</p>
<p><code>ecall</code> 指令会发起一个异常，导致 CPU 进入 Trap，其 trap cause (scause) 为 8 (ecall from U-mode)。我们在 <code>usertrap</code> 中处理这种异常，并转交 <code>syscall.c</code> 中的 <code>syscall</code> 函数处理。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">usertrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">curr_proc</span><span class="p">();</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">trapframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_scause</span><span class="p">();</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SCAUSE_INTERRUPT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">        </span><span class="c1">// handle interrupt</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UserEnvCall</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">        </span><span class="c1">// sepc points to the ecall instruction,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">        </span><span class="c1">// but we want to return to the next instruction.</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">        </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">        </span><span class="c1">// an interrupt will change sepc, scause, and sstatus,</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">        </span><span class="c1">// so enable only now that we&#39;re done with those registers.</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">        </span><span class="n">intr_on</span><span class="p">();</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">        </span><span class="n">syscall</span><span class="p">();</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">        </span><span class="n">intr_off</span><span class="p">();</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">intr_get</span><span class="p">());</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">    </span><span class="n">usertrapret</span><span class="p">();</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="p">}</span>
</code></pre></div>
<p><code>syscall</code> 函数从当前进程的 Trapframe 中读取用户执行 <code>ecall</code> 时的寄存器值，并调用对应的 syscall 处理函数。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">syscall</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">trapframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_proc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w">                      </span><span class="o">=</span><span class="w"> </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a7</span><span class="p">;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a5</span><span class="p">};</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SYS_read</span><span class="p">:</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys_read</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SYS_write</span><span class="p">:</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys_write</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">            </span><span class="n">errorf</span><span class="p">(</span><span class="s">&quot;unknown syscall %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">    </span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">    </span><span class="n">tracef</span><span class="p">(</span><span class="s">&quot;syscall ret %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="p">}</span>
</code></pre></div>
<h2 id="uaccess">uaccess<a class="headerlink" href="#uaccess" title="Permanent link">&para;</a></h2>
<h3 id="read-write">read &amp; write<a class="headerlink" href="#read-write" title="Permanent link">&para;</a></h3>
<p><code>read</code> 和 <code>write</code> 是 Linux 下重要的两个系统调用，它们的原型如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">buf</span><span class="p">[.</span><span class="n">count</span><span class="p">],</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">buf</span><span class="p">[.</span><span class="n">count</span><span class="p">],</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</code></pre></div>
<p>read 表示用户程序希望从内核读取数据，它负责从 fd （文件描述符，File Descriptor）读取 <strong>至多</strong> count 字节，写入到 buf中，并返回读取了多少字节。
而 write 则表示用户程序希望往内核写入数据，它负责将 <strong>至多</strong> count 字节的数据从 buf 写入到 fd 中。</p>
<p>在我们这节课所用的 xv6 上，我们还尚未引入文件的概念。所以，我们假定 read &amp; write 系统调用即是对标准输入输出的 read &amp; write，这两个系统调用最终会被 <code>user_console_write</code> 和 <code>user_console_read</code> 处理。</p>
<p>所以，在目前的 xv6 中，read 和 write 的语义也很简单了：write 即是从用户空间将 <code>buf</code> 中的数据打印到串口，read 即是等待串口的数据并拷贝到 <code>buf</code> 中。</p>
<p>这两个系统调用背后均有一个问题：<strong>操作系统如何对用户内存进行读写？</strong>，毕竟用户内存使用的是用户页表而非内核页表。</p>
<h3 id="uaccess_1">uaccess<a class="headerlink" href="#uaccess_1" title="Permanent link">&para;</a></h3>
<p>在内核下访问用户进程是一种非常常见的需求，以至于我们为此专门创建了一系列函数，我们将这系列函数称为 <strong>用户访问原语</strong> (uaccess primitive)。</p>
<p>在考虑 “uaccess 如何实现 <strong>在内核读写用户内存</strong> ”前，我们似乎已经干过这件事了：在 <code>loader.c</code> 中的 <code>load_user_elf</code> 通过 ELF 加载用户程序时，我们就是在修改用户内存。</p>
<p>我们重新回顾一下，在 <code>load_user_elf</code> 中是如何分配并写入用户内存的：</p>
<ol>
<li>对于每个 <code>PT_LOAD</code> 段，我们得到它要加载的起始地址和范围，并使用一个 <code>struct vma</code> 来表示这个范围。</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="w">    </span><span class="n">Elf64_Phdr</span><span class="w"> </span><span class="o">*</span><span class="n">phdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">phdr_base</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_create_vma</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">);</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">PGROUNDDOWN</span><span class="p">(</span><span class="n">phdr</span><span class="o">-&gt;</span><span class="n">p_vaddr</span><span class="p">);</span><span class="w">  </span><span class="c1">// The ELF requests this phdr loaded to p_vaddr;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">PGROUNDUP</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">phdr</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">);</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">pte_flags</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">pte_perm</span><span class="p">;</span>
</code></pre></div>
<ol>
<li>我们使用 <code>mm_mappages</code> 映射该 vma 区域。<code>mm_mappages</code> 会对 vma 中的每个页面使用 <code>kallocpage()</code> 分配物理页面。</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">mm_mappages</span><span class="p">(</span><span class="n">vma</span><span class="p">);</span>
</code></pre></div>
<ol>
<li>使用 <code>walkaddr</code> 在页表结构上找到 va 所对应的 pa。注意到 <code>kallocpage</code> 返回的页面是 Kernel Direct Mapping 区域中的页面，所以我们可以使用 <code>PA_TO_KVA</code> 转换地址为 KVA 并直接对用户内存背后的物理页面进行访问。</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">__kva</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">PA_TO_KVA</span><span class="p">(</span><span class="n">walkaddr</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">));</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">elf_address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">phdr</span><span class="o">-&gt;</span><span class="n">p_offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">file_off</span><span class="p">);</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">uint64</span><span class="w"> </span><span class="n">copy_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIN</span><span class="p">(</span><span class="n">file_remains</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="n">memmove</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">copy_size</span><span class="p">);</span>
</code></pre></div>
<p>所以，uaccess 也是完全在做同样的事情，它通过 <code>walk</code> 系列函数 <code>walkaddr</code> ，通过 <code>p-&gt;mm-&gt;pgt</code> 将用户地址转换为物理地址，然后通过物理地址来进行内存访问。</p>
<p>我们定义了如下三种原语：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">copy_to_user</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="n">dstva</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kt">int</span><span class="w"> </span><span class="nf">copy_from_user</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="n">srcva</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">copystr_from_user</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="n">srcva</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">max</span><span class="p">);</span>
</code></pre></div>
<p>我们将通过作业2对 uaccess 进行进一步的理解。</p>
<h2 id="lab">Lab 练习<a class="headerlink" href="#lab" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>请你写出：当 <code>init</code> 进程第一次回退到用户模式时，它的所有寄存器状态（包含 pc，只列出值不为0的）</p>
<p>Hint: 在 <code>first_sched_ret</code> 中，<code>usertrapret</code> 前，使用 <code>print_trapframe</code> 打印 <code>curr_proc()</code> 的 trapframe。</p>
</li>
<li>
<p>在 <code>user/src/init.c</code> 中，取消注释：<code>asm volatile(" csrw stvec, %0" : : "r"(0x80000000));</code>。</p>
<p><code>make run</code> 运行内核，<code>init</code> 应该触发异常并退出。</p>
<p>请你写出 <code>init</code> 触发了什么异常，以及为什么会触发异常。</p>
</li>
<li>
<p>Trapframe 和 Trampoline 是两个页面，这两个页面应该允许 U-mode 访问吗？即用户页表中，这两个页面的 PTE 的 Flags 中是否应该拥有 <code>PTE_U</code>。请解释你的答案，不超过 50 字。</p>
<p>Hint: 我们在 <code>proc.c</code> 中的 <code>allocproc</code> 对这两个页面进行映射，使用函数 <code>mm_mappageat</code>。</p>
</li>
</ol>
<h2 id="_11">相关阅读<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<h3 id="struct-mm"><code>struct mm</code><a class="headerlink" href="#struct-mm" title="Permanent link">&para;</a></h3>
<p><code>struct mm</code> 结构体用于管理用户的内存空间，其源代码位于 <code>vm.c</code>。（内核的内存空间管理源代码为 <code>kvm.c</code>）</p>
<p><code>struct vma</code> 结构体用于表示一片连续的虚拟地址，每个 <code>struct mm</code> 下面有多个 <code>struct vma</code> 结构体，每个 <code>struct vma</code> 所有于某个 <code>struct mm</code>，它们使用链表 <code>vma-&gt;next</code> 串联在一起。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">owner</span><span class="p">;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="o">*</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">vm_start</span><span class="p">;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">vm_end</span><span class="p">;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">pte_flags</span><span class="p">;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="p">};</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">pgt</span><span class="p">;</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="o">*</span><span class="w"> </span><span class="n">vma</span><span class="p">;</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">refcnt</span><span class="p">;</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="p">};</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="c1">// vm.c</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="kt">void</span><span class="w"> </span><span class="nf">uvm_init</span><span class="p">();</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="n">pte_t</span><span class="o">*</span><span class="w"> </span><span class="nf">walk</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="n">uint64</span><span class="w"> </span><span class="n">__pa</span><span class="w"> </span><span class="n">walkaddr</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">);</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="n">uint64</span><span class="w"> </span><span class="nf">useraddr</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">);</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">mm_create</span><span class="p">();</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="o">*</span><span class="w"> </span><span class="n">mm_create_vma</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">mm</span><span class="p">);</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="kt">void</span><span class="w"> </span><span class="nf">mm_free_pages</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">mm</span><span class="p">);</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="kt">void</span><span class="w"> </span><span class="nf">mm_free</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">mm</span><span class="p">);</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="kt">int</span><span class="w"> </span><span class="nf">mm_mappages</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="o">*</span><span class="w"> </span><span class="n">vma</span><span class="p">);</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="kt">int</span><span class="w"> </span><span class="nf">mm_remap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">pte_flags</span><span class="p">);</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="kt">int</span><span class="w"> </span><span class="nf">mm_mappageat</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">__pa</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="kt">int</span><span class="w"> </span><span class="nf">mm_copy</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">new</span><span class="p">);</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="o">*</span><span class="w"> </span><span class="n">mm_find_vma</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="o">*</span><span class="w"> </span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">);</span>
</code></pre></div>
<p>当我们要为用户映射一段空间时：</p>
<ol>
<li>使用 <code>mm_create_vma</code> 新建一个 <code>struct vma</code> 结构体，然后填充它的 <code>vma_start</code>, <code>vma_end</code> 和 <code>pte_flags</code> 字段。</li>
<li>使用 <code>mm_mappages</code> 映射该 vma。</li>
<li>如果要对该地址进行访问，使用 <code>walkaddr</code> 将其转换为物理地址。由于用户所用的物理页面均是由 <code>kallocpage</code> 动态分配的，我们可以使用 <code>PA_TO_KVA</code> 宏将其转换为 KVA 即可正常访问该虚拟地址。</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1">// loader.c, load_user_elf</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="c1">// setup stack</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="w"> </span><span class="o">*</span><span class="n">vma_ustack</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">mm_create_vma</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">);</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="n">vma_ustack</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">USTACK_START</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">USTACK_SIZE</span><span class="p">;</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="n">vma_ustack</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">USTACK_START</span><span class="p">;</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="n">vma_ustack</span><span class="o">-&gt;</span><span class="n">pte_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_U</span><span class="p">;</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="n">mm_mappages</span><span class="p">(</span><span class="n">vma_ustack</span><span class="p">);</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vma_ustack</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vma_ustack</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">;</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">__kva</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">PA_TO_KVA</span><span class="p">(</span><span class="n">walkaddr</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">));</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="p">}</span>
</code></pre></div>
<h3 id="mm_mappages">mm_mappages<a class="headerlink" href="#mm_mappages" title="Permanent link">&para;</a></h3>
<p>函数原型：<code>int mm_mappages(struct vma *vma)</code>。</p>
<p>该函数会在页表 <code>vma-&gt;owner-&gt;pgt</code>中，映射 <code>vma</code> 中的虚拟地址范围。注意到，该页表就是用户进程的页表 <code>p-&gt;mm-&gt;pgt</code>。</p>
<p>具体而言，对于每个页面：从 <code>kallocpage()</code> 分配页面，并在 <code>mm-&gt;pgt</code> 页表中映射它。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">mm_mappages</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// simplified</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="c1">// sanity checking</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">;</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">        </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">        </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kallocpage</span><span class="p">();</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">        </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PA2PTE</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">pte_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">;</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="p">}</span>
</code></pre></div>
<p><code>mm_mappages</code> 会使用 <code>walk</code> 函数，得到 <code>mm-&gt;pgt</code> 中虚拟地址 va 所对应的 PTE 的地址，并构造 PTE。</p>
<h3 id="walk">walk<a class="headerlink" href="#walk" title="Permanent link">&para;</a></h3>
<p><code>walk</code> 函数会返回在页表中的 PTE 地址。如果指定了 <code>alloc</code>，则会对中间缺少的页表进行分配。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1">// Return the address of the PTE in page table pagetable</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="c1">// that corresponds to virtual address va.  </span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1">// If alloc!=0, create any required page-table pages.</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="nf">walk</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">alloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">holding</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgt</span><span class="p">;</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_USER_VA</span><span class="p">(</span><span class="n">va</span><span class="p">))</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">        </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pagetable</span><span class="p">[</span><span class="n">PX</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">)];</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">            </span><span class="n">pagetable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">PA_TO_KVA</span><span class="p">(</span><span class="n">PTE2PA</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">));</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">alloc</span><span class="p">)</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kallocpage</span><span class="p">();</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pa</span><span class="p">)</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">            </span><span class="n">pagetable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">PA_TO_KVA</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">            </span><span class="n">memset</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">            </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PA2PTE</span><span class="p">(</span><span class="n">KVA_TO_PA</span><span class="p">(</span><span class="n">pagetable</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">;</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pagetable</span><span class="p">[</span><span class="n">PX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">)];</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="p">}</span>
</code></pre></div>
<h3 id="_12">程序的加载<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p><code>loader.c</code> 的 <code>load_user_elf</code> 实现了加载一个ELF文件到用户空间。<code>load_user_elf</code> 会根据 ELF 的 Program Header 进行加载，每个 LOAD 段会包含：</p>
<ul>
<li>p_vaddr：这个段应该被加载到哪个虚拟地址</li>
<li>p_paddr：这个段应该被加载到哪个物理地址，该值在加载用户程序时不起作用，因为用户只能看到虚拟地址，并且用户的页面是由内核动态分配的。</li>
<li>p_memsz：这个段应该占用多少内存空间</li>
<li>p_filesz：这个段在 ELF 文件中占据多少空间</li>
<li>p_offset：这个段的开始地址在 ELF 文件中哪个位置</li>
<li>p_flags：段的权限</li>
</ul>
<p>以下是 <code>init</code> 的 ELF 文件中的 phdr:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>Elf file type is EXEC (Executable file)
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>Entry point 0x402400
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>There are 4 program headers, starting at offset 64
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>Program Headers:
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>  ATTRIBUTES     0x0074ed 0x0000000000000000 0x0000000000000000 0x000061 0x000000 R   0x1
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>  LOAD           0x001000 0x0000000000402000 0x0000000000402000 0x000f30 0x000f30 R E 0x1000
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>  LOAD           0x002000 0x0000000000403000 0x0000000000403000 0x0000b9 0x0000b9 R   0x1000
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>  LOAD           0x003000 0x0000000000404000 0x0000000000404000 0x000028 0x000440 RW  0x1000
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">内核是怎么找到用户 ELF 文件的</p>
<p>用户空间的程序位于 <code>user/</code> 目录下，<code>make user</code> 会编译所有用户程序，编译产物位于 <code>user/build/stripped/</code> 目录下。</p>
<p>内核的 Makefile 会调用 <code>scripts/pack.py</code> 脚本生成一个 <code>link_app.S</code>，而它负责最终将所有用户的 ELF 打包进内核镜像的 rodata 段。</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-copyright">
    <div class="md-copyright__highlight">
        commit: 
        <a href="https://github.com/yuk1i/os-next-docs/commit/e3321472, 2025-04-06 22:19:04+08:00" target="_blank" rel="noopener">
            e3321472, 2025-04-06 22:19:04+08:00
        </a>
    </div>
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>