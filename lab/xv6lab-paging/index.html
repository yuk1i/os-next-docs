
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../xv6lab-contextswitch/">
      
      
        <link rel="next" href="../xv6lab-userspace/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Week 6 - 内核页表 Kernel Paging - 操作系统实验文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#risc-v-xv6" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-header__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            操作系统实验文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Week 6 - 内核页表 Kernel Paging
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../env/" class="md-tabs__link">
          
  
  实验环境搭建

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab1/" class="md-tabs__link">
          
  
  每周实验

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../laben/lab2/" class="md-tabs__link">
          
  
  Weekly Lab Material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qrh/nav/" class="md-tabs__link">
          
  
  快速参考手册

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-nav__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    操作系统实验文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    实验环境搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            实验环境搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux VM 搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Linux VM 搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/windows-vmware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + VMware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/wsl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + WSL (不推荐)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS + VMware
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    手动环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    验证环境
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    每周实验
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            每周实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 1 - Linux基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C 语言基础及Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - 裸机程序 Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - 上下文切换 Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Week 6 - 内核页表 Kernel Paging
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Week 6 - 内核页表 Kernel Paging
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      为什么要地址翻译（虚拟地址）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#satp" class="md-nav__link">
    <span class="md-ellipsis">
      satp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sv39" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sv39">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-d" class="md-nav__link">
    <span class="md-ellipsis">
      A &amp; D
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      权限检查
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V 物理地址布局
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 内核内存布局
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kalloc" class="md-nav__link">
    <span class="md-ellipsis">
      kalloc 模块
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relocation" class="md-nav__link">
    <span class="md-ellipsis">
      重定位（Relocation）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="重定位（Relocation）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#relocation_start" class="md-nav__link">
    <span class="md-ellipsis">
      relocation_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      跳转
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      内核页表
    </span>
  </a>
  
    <nav class="md-nav" aria-label="内核页表">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kvmmap" class="md-nav__link">
    <span class="md-ellipsis">
      kvmmap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      固定大小对象分配器
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - 用户空间 Userspace
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Weekly Lab Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Weekly Lab Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C language basic & Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - Trap & Interrupt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../laben/xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - Context Switch
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    快速参考手册
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            快速参考手册
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/nav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/vf2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VisionFive2 板子教程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/ssh-vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH & VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      为什么要地址翻译（虚拟地址）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#satp" class="md-nav__link">
    <span class="md-ellipsis">
      satp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sv39" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sv39">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-d" class="md-nav__link">
    <span class="md-ellipsis">
      A &amp; D
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      权限检查
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V 物理地址布局
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 内核内存布局
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kalloc" class="md-nav__link">
    <span class="md-ellipsis">
      kalloc 模块
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relocation" class="md-nav__link">
    <span class="md-ellipsis">
      重定位（Relocation）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="重定位（Relocation）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#relocation_start" class="md-nav__link">
    <span class="md-ellipsis">
      relocation_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      跳转
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      内核页表
    </span>
  </a>
  
    <nav class="md-nav" aria-label="内核页表">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kvmmap" class="md-nav__link">
    <span class="md-ellipsis">
      kvmmap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      固定大小对象分配器
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="risc-v-xv6">RISC-V 页表模型 &amp; xv6 内核页表<a class="headerlink" href="#risc-v-xv6" title="Permanent link">&para;</a></h1>
<h2 id="_1">为什么要地址翻译（虚拟地址）<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>从对内存访问保护而言，我们希望对内存的访问是带有权限保护的。这包括两个层面：</p>
<ol>
<li>该内存地址是否可读、可写、可执行。</li>
<li>该内存地址是否允许低特权级访问。</li>
</ol>
<p>也就是说，对于每个虚拟地址，我们都希望能检查它的操作权限是否符合原先的程序设计。</p>
<p>在 CPU 实现上，内存是以字节为单位来寻址的。如果要实现对每个字节的访问权限都能进行管理，这样的代价是难以现象的。
但是，我们可以让相同权限的代码、数据排布在一起，这样即可将整个程序的内存空间分为几个大块，每个块均有自己的起始地址(Base)和大小限制(Limit)，以及权限设置，这就是使用 Segmentation 进行内存保护的方式。 </p>
<p>Segmentation 在内存空间的管理上有着诸多劣势，例如难以动态调节大小、存在碎片化的问题。所以，现代 CPU 和操作系统均使用页表（Paging）机制来实现内存管理。</p>
<h2 id="satp">satp<a class="headerlink" href="#satp" title="Permanent link">&para;</a></h2>
<p>satp (Supervisor Address Translation and Protection) 寄存器是控制 S mode 和 U mode 下地址翻译的寄存器，其中包含三个属性：<code>MODE</code>, <code>ASID</code> 和 <code>PPN</code>。</p>
<blockquote>
<p>This register holds the physical page number (PPN) of the root page table, i.e., its supervisor physical address divided by 4 KiB; an address space identifier (ASID), which facilitates address-translation fences on a per-address-space basis; and the MODE field, which selects the current address-translation scheme. Further details on the access to this register are described in Section 3.1.6.5.</p>
</blockquote>
<p><img alt="alt text" src="../../assets/xv6lab-paging/satp.png" /></p>
<p>Mode 表示使用的地址翻译模式，0 则表示禁用地址翻译，所有请求的地址均作为物理地址看待，<code>PPN</code> 表示根页表的基地址。在我们的课程中，我们将使用 Sv39 作为页表模式。</p>
<p>我们暂且不需要理解 ASID 的作用。</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/satp-mode.png" /></p>
<h2 id="sv39">Sv39<a class="headerlink" href="#sv39" title="Permanent link">&para;</a></h2>
<p>RISC-V 的 Sv39 模式支持了 39-bit 的虚拟地址空间，每个页面大小 4KiB。</p>
<p>RISC-V CPU 的虚拟地址为64位。Sv39模式下，有效的虚拟地址为 39 位，并规定虚拟地址的 63-39 位必须与第 38 位相同，否则会产生 Page Fault 异常。所以，Sv39 的虚拟地址空间一共为 <code>(1 &lt;&lt; 39) = 512 GiB</code> 的空间，其中分为高地址和低地址各 <code>256 GiB</code> 的空间，低地址空间为 <code>0x0000_0000_0000_0000</code> - <code>0x0000_003f_xxxx_xxxx</code> ，而高地址空间为 <code>0xffff_ffc0_0000_0000</code> - <code>0xffff_ffff_xxxx_xxxx</code>。</p>
<blockquote>
<p>Sv39 implementations support a 39-bit virtual address space, divided into 4 KiB pages.
An Sv39 address is partitioned as shown in Figure 4.19.
Instruction fetch addresses and load and store effective addresses, which are 64 bits, must have bits 63–39 all equal to bit 38, or else a page-fault exception will occur.
The 27-bit VPN is translated into a 44-bit PPN via a three-level page table, while the 12-bit page offset is untranslated.</p>
</blockquote>
<p><img alt="alt text" src="../../assets/xv6lab-paging/sv39-pgt-structure.png" /></p>
<p>虚拟地址分为四部分：VPN[2-0] (Virtual Page Number) 和 page offset。三级 VPN 表示在三级页表中的 index, 而 page offset 表示当前地址在被翻译的页面中的偏移量。</p>
<p>Sv39 中的 PTE 长度为 8-byte，分为两部分：PPN 和 Flags。PPN (Physical Page Number) 和虚拟地址中的 page offset 组成最终的物理地址，Flags 则表示该虚拟地址页面的访问权限等信息。</p>
<p>Flags 定义如下：</p>
<ul>
<li>D, A: Dirty, Accessed。表示该页面最近被访问 / 写入过。</li>
<li>G: Global。表示该映射关系在所有页表中均存在。</li>
<li>U: User。表示该映射关系允许在用户权限下访问。</li>
<li>V: Valid。该 bit 表示此 PTE 为有效 PTE，否则整个 PTE 视为无效。</li>
<li>R, W, X: Read, Write, Executable 权限</li>
</ul>
<p>RWX 定义如下图所示：
注意 <code>XWR == 3'b000</code> 的情况表示物理地址 [PPN: 12b0] 为下一级页表的基地址。</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/pte-rwx-encoding.png" /></p>
<p>地址翻译的过程如下图所示：</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/riscv-address-translation.png" /></p>
<p>See also: riscv-privilege.pdf, 4.3.2 Virtual Address Translation Process</p>
<p>文字描述，以下 <code>{xx | yy}</code> 表示在 <code>xx</code> bit 右边并上 <code>yy</code> bit，类似于 Verilog 的写法。</p>
<ol>
<li>分解 Virtual Address: <code>{ 25'signed_ext, 9'VPN2, 9'VPN1, 9'VPN0, 12'pgoff} = 64'VirtualAddress</code></li>
<li>将 satp 寄存器中第二级页表的基地址取出</li>
<li>使用 VPN2 作为 index 在第二级页表中找到 PTE。</li>
</ol>
<p>这一步等效于 C 代码：<code>uint64 pte2 = *(uint64*)(satp.base + VPN2 * 8);</code></p>
<ol>
<li>如果 <code>pte2.WXR != 3'b000</code>，则表示该 PTE 为 1GiB 大页映射。</li>
</ol>
<p>检查 PPN 是否对齐到 1GiB，aka：<code>pte2.PPN1 == 9'b0 &amp;&amp; pte2.PPN0 == 9'b0</code>。如果满足，则跳转至 10.，否则 Page Fault。</p>
<ol>
<li>否则，<code>{pte2.PPN, 12'b0}</code> 为第一级页表的基地址</li>
<li>使用 VPN1 作为 index 在第一级页表中找到 PTE。</li>
</ol>
<p>这一步等效于 C 代码：<code>uint64 pte1 = *(uint64*)((pte2.ppn &lt;&lt; 12) + VPN1 * 8);</code></p>
<ol>
<li>如果 <code>pte1.WXR != 3'b000</code>，则表示该 PTE 为 2MiB 大页映射。</li>
</ol>
<p>检查 PPN 是否对齐到 2MiB，aka：<code>pte2.PPN0 == 9'b0</code>。如果满足，则跳转至 10.，否则 Page Fault。</p>
<ol>
<li>否则，<code>{pte1.PPN | 12'b0}</code> 为第零级页表的基地址</li>
<li>使用 VPN0 作为 index 在第零级页表中找到 PTE。</li>
</ol>
<p>这一步等效于 C 代码：<code>uint64 pte0 = *(uint64*)((pte1.ppn &lt;&lt; 12) + VPN0 * 8);</code></p>
<ol>
<li>
<p>得到最终的物理地址：<code>PA = (final_pte.ppn &lt;&lt; 12) | final_page_offset</code>，</p>
<p>如果为 2MiB 大页映射，<code>final_page_offset = {9'bVPN0, 12'bpgoff}</code>。</p>
<p>如果为 1GiB 大页映射，<code>final_page_offset = {9'bVPN1, 9'bVPN0, 12'bpgoff}</code></p>
<p>否则，<code>final_page_offset = pgoff</code></p>
</li>
<li>
<p>权限检查：检查 <code>final_pte.rwx</code> 是否与访存请求相同。</p>
</li>
</ol>
<h3 id="a-d">A &amp; D<a class="headerlink" href="#a-d" title="Permanent link">&para;</a></h3>
<p>每个叶 PTE 包含 Accessed 和 Dirty 两个 bits：</p>
<ul>
<li>A 表示：自从上次 A bit 被清零，该虚拟页面曾经被读取、写入、取指 （Instruction Fetch）。</li>
<li>D 表示：自从上次 D bit 被清零，该虚拟页面曾经被写入。</li>
</ul>
<p>当访问的虚拟页面被访问时，A bit 是 0、或被写入时，D bit 是 0 是，RISC-V 规范实现允许两种方式来更新 A &amp; D bits：</p>
<ol>
<li>发出 PageFault，Supervisor 的异常处理函数需要手动设置 A / D bits.</li>
<li>由硬件设置 A / D bits.</li>
</ol>
<p>Supervisor 软件应当正确处理以上两种情况。</p>
<p>Each leaf PTE contains an accessed (A) and dirty (D) bit.</p>
<ul>
<li>The A bit indicates the virtual page has been read, written, or fetched from since the last time the A bit was cleared.</li>
<li>The D bit indicates the virtual page has been written since the last time the D bit was cleared.</li>
</ul>
<p>Two schemes to manage the A and D bits are permitted:</p>
<ol>
<li>When a virtual page is accessed and the A bit is clear, or is written and the D bit is clear, a page-fault exception is raised.</li>
<li>When a virtual page is accessed and the A bit is clear, or is written and the D bit is clear, the implementation sets the corresponding bit(s) in the PTE.</li>
</ol>
<p>See also: "riscv-privilege.pdf" "4.3.1 Addressing and Memory Protection"</p>
<h3 id="_2">权限检查<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>凭直觉的，读取的页面要带有 R bit，写入的页面要带有 W bit，执行的页面要带有 X bit。</p>
<p>但是，如果一个页面的权限带有 U bit，并且现在 CPU 核心运行在 S mode 下，我们需要对此进行额外检查：如果 <code>sstatus.SUM == 1</code> 则访问被允许，否则 Page Fault.</p>
<blockquote>
<p>The SUM (permit Supervisor User Memory access) bit modifies the privilege with which S-mode loads and stores access virtual memory.
When SUM=0, S-mode memory accesses to pages that are accessible by U-mode (U=1 in Figure 4.18) will fault. When SUM=1, these accesses are permitted.</p>
</blockquote>
<p>通常来说，S mode 一般运行在 <code>sstatus.SUM == 0</code> 的情况下，如果我们需要通过页表去访问用户数据时，我们会将该 flag 置 1，并在访问结束后清零。该过程一般被称为 uaccess 原语 (primitive).</p>
<p>See also: <a href="https://github.com/torvalds/linux/blob/master/arch/riscv/include/asm/uaccess.h">https://github.com/torvalds/linux/blob/master/arch/riscv/include/asm/uaccess.h</a></p>
<!-- !!!questions "AArch64 架构下的虚拟内存模型"

    AArch64 显著地将虚拟地址分为低地址部分和高地址部分。（简单理解就是 0x0000_xxxx 开头的地址，和 0xffff_xxxx 开头的地址）

    对于低地址，使用 `TTBR0_EL1` (Translation Table Base Register 0 (EL1)) 寄存器作为类似 satp 寄存器的基地址寄存器进行地址翻译。
    对于高地址，使用 `TTBR1_EL1` 进行地址翻译。

    显然，这一种模型天生适合将内核页表和用户页表隔离。 -->

<h2 id="risc-v">RISC-V 物理地址布局<a class="headerlink" href="#risc-v" title="Permanent link">&para;</a></h2>
<p>RISC-V 将物理内存 (DDR / DRAM) 的起始地址映射到物理地址 <code>0x8000_0000</code> 上，而不是物理地址 <code>0x0000_0000</code> 处。</p>
<p>也就是说，如果我们有 128 MiB (0x0800_0000) 的 DRAM 大小，RISC-V 核心会将 DRAM 空间映射到 <code>[0x8000_0000, 0x8800_0000)</code> 上面。</p>
<p>对于 QEMU 的 virt 机子，我们可以翻阅 qemu 的源代码找到其物理地址的映射：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">MemMapEntry</span><span class="w"> </span><span class="n">virt_memmap</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_DEBUG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="p">{</span><span class="w">        </span><span class="mh">0x0</span><span class="p">,</span><span class="w">         </span><span class="mh">0x100</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_MROM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">         </span><span class="p">{</span><span class="w">     </span><span class="mh">0x1000</span><span class="p">,</span><span class="w">        </span><span class="mh">0xf000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_TEST</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">         </span><span class="p">{</span><span class="w">   </span><span class="mh">0x100000</span><span class="p">,</span><span class="w">        </span><span class="mh">0x1000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_RTC</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">          </span><span class="p">{</span><span class="w">   </span><span class="mh">0x101000</span><span class="p">,</span><span class="w">        </span><span class="mh">0x1000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_CLINT</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="p">{</span><span class="w">  </span><span class="mh">0x2000000</span><span class="p">,</span><span class="w">       </span><span class="mh">0x10000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_ACLINT_SSWI</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">{</span><span class="w">  </span><span class="mh">0x2F00000</span><span class="p">,</span><span class="w">        </span><span class="mh">0x4000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PCIE_PIO</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="p">{</span><span class="w">  </span><span class="mh">0x3000000</span><span class="p">,</span><span class="w">       </span><span class="mh">0x10000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PLATFORM_BUS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="mh">0x4000000</span><span class="p">,</span><span class="w">     </span><span class="mh">0x2000000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PLIC</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">         </span><span class="p">{</span><span class="w">  </span><span class="mh">0xc000000</span><span class="p">,</span><span class="w"> </span><span class="n">VIRT_PLIC_SIZE</span><span class="p">(</span><span class="n">VIRT_CPUS_MAX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_APLIC_M</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="p">{</span><span class="w">  </span><span class="mh">0xc000000</span><span class="p">,</span><span class="w"> </span><span class="n">APLIC_SIZE</span><span class="p">(</span><span class="n">VIRT_CPUS_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_APLIC_S</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="p">{</span><span class="w">  </span><span class="mh">0xd000000</span><span class="p">,</span><span class="w"> </span><span class="n">APLIC_SIZE</span><span class="p">(</span><span class="n">VIRT_CPUS_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_UART0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mh">0x10000000</span><span class="p">,</span><span class="w">         </span><span class="mh">0x100</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_VIRTIO</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="mh">0x10001000</span><span class="p">,</span><span class="w">        </span><span class="mh">0x1000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_FW_CFG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="mh">0x10100000</span><span class="p">,</span><span class="w">          </span><span class="mh">0x18</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_FLASH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mh">0x20000000</span><span class="p">,</span><span class="w">     </span><span class="mh">0x4000000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_IMSIC_M</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x24000000</span><span class="p">,</span><span class="w"> </span><span class="n">VIRT_IMSIC_MAX_SIZE</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_IMSIC_S</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x28000000</span><span class="p">,</span><span class="w"> </span><span class="n">VIRT_IMSIC_MAX_SIZE</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PCIE_ECAM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mh">0x30000000</span><span class="p">,</span><span class="w">    </span><span class="mh">0x10000000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PCIE_MMIO</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mh">0x40000000</span><span class="p">,</span><span class="w">    </span><span class="mh">0x40000000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_DRAM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">         </span><span class="p">{</span><span class="w"> </span><span class="mh">0x80000000</span><span class="p">,</span><span class="w">           </span><span class="mh">0x0</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="p">};</span>
</code></pre></div>
<p>或者，我们可以在 gdb 连接到 qemu 上时，输入 <code>monitor info mtree -f</code> 查看 Memory Tree 的结构：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>(qemu) gef➤  monitor info mtree -f
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>FlatView #0
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a> AS &quot;memory&quot;, root: system
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a> AS &quot;cpu-memory-0&quot;, root: system
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a> Root memory region: system
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>  0000000000001000-000000000000ffff (prio 0, rom): riscv_virt_board.mrom
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>  0000000000100000-0000000000100fff (prio 0, i/o): riscv.sifive.test
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>  0000000000101000-0000000000101023 (prio 0, i/o): goldfish_rtc
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>  0000000002000000-0000000002003fff (prio 0, i/o): riscv.aclint.swi
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>  0000000002004000-000000000200bfff (prio 0, i/o): riscv.aclint.mtimer
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>  0000000003000000-000000000300ffff (prio 0, i/o): gpex_ioport_window
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>  000000000c000000-000000000c5fffff (prio 0, i/o): riscv.sifive.plic
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>  0000000010000000-0000000010000007 (prio 0, i/o): serial
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>  0000000010001000-00000000100011ff (prio 0, i/o): virtio-mmio
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>  0000000010002000-00000000100021ff (prio 0, i/o): virtio-mmio
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>  0000000010003000-00000000100031ff (prio 0, i/o): virtio-mmio
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>  0000000010004000-00000000100041ff (prio 0, i/o): virtio-mmio
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>  0000000010005000-00000000100051ff (prio 0, i/o): virtio-mmio
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>  0000000010006000-00000000100061ff (prio 0, i/o): virtio-mmio
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>  0000000010007000-00000000100071ff (prio 0, i/o): virtio-mmio
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>  0000000010008000-00000000100081ff (prio 0, i/o): virtio-mmio
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>  0000000010100000-0000000010100007 (prio 0, i/o): fwcfg.data
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>  0000000010100008-0000000010100009 (prio 0, i/o): fwcfg.ctl
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>  0000000010100010-0000000010100017 (prio 0, i/o): fwcfg.dma
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>  0000000020000000-0000000021ffffff (prio 0, romd): virt.flash0
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>  0000000022000000-0000000023ffffff (prio 0, romd): virt.flash1
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>  0000000030000000-000000003fffffff (prio 0, i/o): pcie-mmcfg-mmio
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>  0000000040000000-000000007fffffff (prio 0, i/o): gpex_mmio_window @0000000040000000
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>  0000000080000000-000000009fffffff (prio 0, ram): riscv_virt_board.ram
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>  0000000400000000-00000007ffffffff (prio 0, i/o): gpex_mmio_window @0000000400000000
</code></pre></div>
<p>在我们的操作系统实验中，我们只需要关注 DRAM 空间和一些外设(PLIC, UART)即可</p>
<table>
<thead>
<tr>
<th style="text-align: left;"><code>Base</code></th>
<th style="text-align: left;">Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>0x0000_1000</code></td>
<td style="text-align: left;"><code>0x0000_f000</code></td>
<td>BootROM</td>
</tr>
<tr>
<td style="text-align: left;"><code>0x0c00_0000</code></td>
<td style="text-align: left;"><code>0x0060_0000</code></td>
<td>PLIC</td>
</tr>
<tr>
<td style="text-align: left;"><code>0x1000_0000</code></td>
<td style="text-align: left;"><code>0x0000_0100</code></td>
<td>Serial UART</td>
</tr>
<tr>
<td style="text-align: left;"><code>0x8000_0000</code></td>
<td style="text-align: left;">DRAM Size</td>
<td>DRAM</td>
</tr>
</tbody>
</table>
<p>实际上 OpenSBI 在加载时也会占用一部分 DRAM 空间，我们可以在 gdb 下用 <code>monitor info roms</code> 查看 QEMU 启动时所加载的文件：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>(qemu) gef➤  monitor info roms
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>addr=0000000000001000 size=0x000028 mem=rom name=&quot;mrom.reset&quot;
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>addr=0000000000001028 size=0x000030 mem=rom name=&quot;mrom.finfo&quot;
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>addr=0000000080000000 size=0x042868 mem=ram name=&quot;/usr/share/qemu/opensbi-riscv64-generic-fw_dynamic.bin&quot;
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>addr=0000000080200000 size=0x002790 mem=ram name=&quot;build/kernel ELF program header segment 1&quot;
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>addr=0000000080203000 size=0x009048 mem=ram name=&quot;build/kernel ELF program header segment 2&quot;
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>addr=000000009fe00000 size=0x0012b8 mem=ram name=&quot;fdt&quot;
</code></pre></div>
<p>其中，<code>0x1000</code> 上放置的是 BootROM，是 CPU 上电后的执行的第一块代码。（类似于在组成原理课程里面使用的 BlockRAM）
OpenSBI 被加载到 DRAM 空间开始的 <code>0x8000_0000</code>。（这也是为什么我们内核的 BASE_ADDRESS 不能是 <code>0x8000_0000</code> 而得是 <code>0x8020_0000</code>）
内核 ELF 被加载到 <code>0x8020_0000</code> 的地址。</p>
<table>
<thead>
<tr>
<th style="text-align: left;"><code>Base</code></th>
<th style="text-align: left;">Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>0x8000_0000</code></td>
<td style="text-align: left;"><code>0x0004_2868</code></td>
<td>OpenSBI</td>
</tr>
<tr>
<td style="text-align: left;"><code>0x8020_0000</code></td>
<td style="text-align: left;"><code>0x0000_2790</code></td>
<td>kernel segment 1</td>
</tr>
<tr>
<td style="text-align: left;"><code>0x8020_3000</code></td>
<td style="text-align: left;"><code>0x0000_9048</code></td>
<td>kernel segment 2</td>
</tr>
</tbody>
</table>
<p><img alt="alt text" src="../../assets/xv6lab-paging/xv6lab-paging-phymemlayout.png" /></p>
<h2 id="xv6">xv6 内核内存布局<a class="headerlink" href="#xv6" title="Permanent link">&para;</a></h2>
<p>Sv39 虚拟地址的高位是 Sign-Extension 的，在 <code>&lt; 256 GiB</code> 和 <code>256 GiB ~ 512 GiB</code> 之间有着巨大的 gap，我们利用此特性在地址上区分用户地址（低，以 <code>0x0000</code> 开头）和内核地址（高，以 <code>0xffff</code> 开头）。</p>
<table>
<thead>
<tr>
<th style="text-align: right;"><code>Base Address</code></th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;"><code>0x0000_0000_xxxx_xxxx</code></td>
<td>Userspace</td>
</tr>
<tr>
<td style="text-align: right;"><code>0x0000_003f_ffff_e000</code></td>
<td>Trapframe</td>
</tr>
<tr>
<td style="text-align: right;"><code>0x0000_003f_ffff_f000</code></td>
<td>Trampoline</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffc0_0000_0000</code></td>
<td>Kernel Direct Mapping of all available physical pages</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_fffd_0000_0000</code></td>
<td>Kernel Heap (fixed-size object)</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffff_8020_0000</code></td>
<td>Kernel Image (.text, .data, .bss)</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffff_a000_0000</code></td>
<td>Device Memory-Mapped IO</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffff_d000_0000</code></td>
<td>Kernel stack for processes</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffff_ff00_0000</code></td>
<td>Kernel stack for per-cpu scheduler</td>
</tr>
</tbody>
</table>
<ul>
<li>Trampoline (n. 蹦床) 是用户空间和内核空间的跳板，所以我们将它放在低 128 GiB 的最高处。</li>
<li>然后，我们将内核的镜像，即 <code>build/kernel</code> ELF 文件，映射到 <code>0xffff_ffff_8020_0000</code>。</li>
<li>其次，映射一些内核所需要的页面，如每个 CPU 的 scheduler 所用的栈，以及外设所需要的 MMIO。</li>
<li>最后，剩下的所有可用的物理页面将被 Direct Mapping 到 <code>0xffff_ffc0_80xx_xxxx</code>，并交给 kalloc 管理。</li>
</ul>
<p><img alt="alt text" src="../../assets/xv6lab-paging/xv6lab-paging-kmemlayout.png" /></p>
<p>Direct Mapping 的作用是让 Kernel 能直接操纵所有可用的物理内存，但是除了内核本身镜像以外。</p>
<p>如果没有 Direct Mapping，我们每次都需要将新分配的页面映射到内核虚拟地址空间上，才能通过虚拟地址去访问该物理页面。
而有了 Direct Mapping 后，我们可以直接将物理地址加上一个常量偏移量，即可得到一个内核可访问的虚拟地址：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="cp">#define KERNEL_DIRECT_MAPPING_BASE  0xffffffc000000000ull</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="cp">#define KVA_TO_PA(x) (((uint64)(x)) - KERNEL_DIRECT_MAPPING_BASE)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="cp">#define PA_TO_KVA(x) (((uint64)(x)) + KERNEL_DIRECT_MAPPING_BASE)</span>
</code></pre></div>
<h2 id="kalloc">kalloc 模块<a class="headerlink" href="#kalloc" title="Permanent link">&para;</a></h2>
<p><code>kalloc.c</code> 会在启动后接管 Direct Mapping，其负责两个功能：</p>
<ol>
<li>对剩余可分配的物理页面的管理</li>
<li>对固定大小对象的动态分配和回收 (对象分配器管理)</li>
</ol>
<p>在 kalloc 接管内核启动后剩余的物理内存（即上图紫色部分）后，我们需要从它分配：</p>
<ol>
<li>每个 object allocator（对象分配器）的内存池</li>
<li>每个 process 的 kernel stack</li>
<li>每个 cpu scheduler 的 kernel stack</li>
</ol>
<p>随后，用户空间所需要的页面和配置页表所需要的页面均由 <code>kalloc</code> 模块管理。</p>
<h2 id="relocation">重定位（Relocation）<a class="headerlink" href="#relocation" title="Permanent link">&para;</a></h2>
<p>对于内核本身（即编译出来的 ELF 文件：<code>build/kernel</code>，也称为内核镜像），我们也需要把它映射到高地址上。我们采用固定偏移量来映射整个 ELF 文件。</p>
<p>也就是说，内核中定义 (Defined) 的符号（变量、函数），它们会被 OpenSBI 加载到指定的物理地址 <code>0x0000_0000_8020_abcd</code>，而我们最终会将该符号加载到虚拟地址 <code>0xffff_ffff_8020_abcd</code> 上。对于所有符号，这两个地址之间永远相差一个固定的值。我们将该值定义为内核偏移量 (kernel offset)。</p>
<p>我们将该值定义为宏 <code>KERNEL_OFFSET</code>，并定义宏 <code>KIVA_TO_PA</code> 和 <code>PA_TO_KIVA</code> 在便于两者之间转换。(KIAV: Kernel Image Virtual Address)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="cp">#define KERNEL_VIRT_BASE 0xffffffff80200000ull</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="cp">#define KERNEL_PHYS_BASE 0x80200000ull</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="cp">#define KERNEL_OFFSET    ((uint64)(KERNEL_VIRT_BASE - KERNEL_PHYS_BASE))</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1">// (Kernel Image Virtual Address) TO (Physical Address)</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="cp">#define KIVA_TO_PA(x) (((uint64)(x)) - KERNEL_OFFSET)</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="cp">#define PA_TO_KIVA(x) (((uint64)(x)) + KERNEL_OFFSET)</span>
</code></pre></div>
<p>我们注意到，偏移整个镜像文件加载的基地址并不会改变两个符号之间的距离，也就是说：</p>
<ol>
<li>符号 a 被加载到 PA_a <code>0x0000_0000_8020_dead</code>，符号 b 被加载到 PA_b <code>0x0000_0000_8020_beef</code>。</li>
<li>符号 a 将会被映射到 VA_a <code>0xffff_ffff_8020_dead</code>，符号 b 将会被映射到 VA_b <code>0xffff_ffff_8020_beef</code></li>
<li><code>PA_a - PA_b = VA_a - VA_b</code></li>
</ol>
<p>这个性质允许我们在使用 <code>PC-relative</code> 寻址时，对整个内核镜像进行重定位。使用 <code>PC-relative</code> 寻址时，我们会通过当前 PC 与目标符号的偏移量来计算目标符号的地址，具体而言，在汇编上使用 <code>auipc</code> 和 <code>addi</code> 来计算 <code>target = pc + offset</code>，而不是 <code>target = immediate</code>（立即数寻址）。
所以，我们可以将整个内核镜像整体重定位到任何起始地址，只需要保证所有符号之间的偏移量在编译期间和被加载时是固定的即可。这一条性质也是 Linux Kernel 能实现对自身镜像的 KASLR (Kernel address space layout randomization, See also: <a href="https://lwn.net/Articles/569635/">https://lwn.net/Articles/569635/</a>) 的原理。</p>
<p>因此，我们只需要完成两步即可实现内核镜像的重定位：</p>
<ol>
<li>将内核镜像映射到虚拟地址 <code>0xffff_ffff_8020_0000</code> 上。</li>
<li>将 PC 跳转到 <code>0xffff_ffff_8020_xxxx</code> 的高地址上。</li>
</ol>
<p>我们期望内核会运行在 <code>0xffff_ffff_8020_0000</code> 的高地址上。所以，我们需要修改 <code>kernel.ld</code> 使链接器能正确链接内核。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>OUTPUT_ARCH(riscv)
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>ENTRY(_entry)
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>BASE_ADDRESS = 0xffffffff80200000;
</code></pre></div>
<p>但是，此时 OpenSBI 无法正确加载 kernel ELF 到物理地址上，因为 kernel ELF 的 Program Header 的预计加载的物理地址 (PhysAddr) 是 <code>0xffff_ffff_8020_0000</code> 的高地址，然而这个地址在 OpenSBI 转交至我们的内核时是非法的。</p>
<p>所以，我们在第一个段 <code>.text</code> 后面注明 <code>AT(0x80200000)</code>，表示这个段应该被加载到物理地址 <code>0x8020_0000</code>。这样能使链接器产生的 ELF 的 Program Headers 拥有 <code>VirtAddr = 0xffff_ffff_8020_0000</code>，以及 <code>PhysAddr = 0x8020_0000</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>BASE_ADDRESS = 0xffffffff80200000;
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>SECTIONS
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>{
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    . = BASE_ADDRESS;
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    skernel = .;
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    s_text = .;
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    .text : AT(0x80200000) {
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>        *(.text.entry)
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>        // ...
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    }
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    // ...
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>}
</code></pre></div>
<p>此时再 <code>make run</code> 运行内核，我们可以发现 OpenSBI 正确找到了我们内核的入口点：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Domain0 Next Address      : 0x0000000080200000
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>Domain0 Next Arg1         : 0x000000009fe00000
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>Domain0 Next Mode         : S-mode
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>...
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>clean bss: 0x00000000802ac000 - 0x00000000802b3000
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>Kernel is Relocating...
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Question</p>
<p>我们在 <code>kernel.ld</code> 里面指定的虚拟地址是 <code>0xffff_ffff_8020_0000</code>，但是 <code>entry.S</code> 中仍然使用的是</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>_entry:
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    lla sp, boot_stack_top
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    call main
</code></pre></div>
<p>请思考：为什么在程序运行在 <code>0x0000_0000_8020_0000</code> 的地址上时，使用 <code>lla</code> 加载符号和 <code>call main</code> 跳转 main <strong>能找到正确的物理地址，而不是在此时为非法的虚拟地址</strong> <code>0xffff_ffff_8020_0000</code>？</p>
<p>Hint: 我们是如何寻址的？回忆计算机组成原理课上学习的寻址模式。</p>
<p>上述 <code>_entry</code> 中两行汇编代码被编译后的汇编是：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>────────────────────────────────────────────────────────────────────────── code:riscv:RISCV ────
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>●→  0x80200000 &lt;skernel+0000&gt;   auipc  sp, 0xac
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    0x80200004 &lt;skernel+0004&gt;   mv     sp, sp
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    0x80200008 &lt;skernel+0008&gt;   auipc  ra, 0x2
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    0x8020000c &lt;skernel+000c&gt;   jalr   488(ra)
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>─────────────────────────────────────────────────────────────────────── source:os/entry.S+4 ────
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    3  _entry:
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>→   4      lla sp, boot_stack_top
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    5      call main
</code></pre></div>
</div>
<p>如果我们直接构建上图的页表，我们需要两条或更多指令来完成切换页表+跳转到高地址：</p>
<ol>
<li><code>csrw satp</code>: 设置 satp 寄存器，启用 Sv39 地址翻译</li>
<li><code>...</code></li>
</ol>
<p>当执行第一条指令时，我们的 PC 指向在 <code>0x8020_xxxx</code> 的物理地址上。
但是，当我们执行完第 1 条指令设置完 satp 后，即将开始执行第二条指令，我们的 PC 还指向着该指令的物理地址，而这个物理地址的 PC 在当前的页表中是非法的。
所以，我们的第 2 条指令就会发生 Instruction Page Fault 异常。</p>
<p>也就是说，在我们设置完内核页表后，我们并不能直接切换到仅包含高地址的页表上，因为此时我们的 PC 指针还指向低地址，而我们无法在同时完成切换 PC + 切换 satp 两件事情。
所以，我们需要一个临时页表，其中包含了两份映射：</p>
<ol>
<li>VA <code>0x0000_0000_8020_0000</code> -&gt; PA <code>0x8020_0000</code></li>
<li>VA <code>0xffff_ffff_8020_0000</code> -&gt; PA <code>0x8020_0000</code></li>
</ol>
<p>当执行完上述第 1 条指令启用 Sv39 后，我们目前的 PC 虽然是下一条指令的物理地址，但是它是一个合法的虚拟地址。我们可以加载一个立即数到寄存器中，然后使用 <code>jr</code> 指令跳转到该寄存器的值，从而进入到高地址。</p>
<p>我们将这一系列步骤称为 Relocate (重定位)。</p>
<p>See also: <a href="https://0xax.gitbooks.io/linux-insides/content/Booting/linux-bootstrap-6.html">https://0xax.gitbooks.io/linux-insides/content/Booting/linux-bootstrap-6.html</a></p>
<h3 id="relocation_start"><code>relocation_start</code><a class="headerlink" href="#relocation_start" title="Permanent link">&para;</a></h3>
<p>在 relocation_start 的临时页表中，我们使用 2 MiB 的大页映射。我们先开辟四个对齐的物理页面：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">relocate_pagetable</span><span class="p">[</span><span class="n">PGSIZE</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PGSIZE</span><span class="p">)));</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">relocate_pagetable_level1_ident</span><span class="p">[</span><span class="n">PGSIZE</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PGSIZE</span><span class="p">)));</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">relocate_pagetable_level1_direct_mapping</span><span class="p">[</span><span class="n">PGSIZE</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PGSIZE</span><span class="p">)));</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">relocate_pagetable_level1_high</span><span class="p">[</span><span class="n">PGSIZE</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PGSIZE</span><span class="p">)));</span>
</code></pre></div>
<p>然后，我们计算内核镜像的终止点 <code>ekernel</code> 向上对齐到 2MiB 的大小。这是因为 2 MiB 的大页映射要求虚拟地址和物理地址同时对齐到 2MiB 上。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">// Kernel Start Point must be aligned to 2MiB</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">assert</span><span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">KERNEL_PHYS_BASE</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">));</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1">// Calculate Kernel image size, and round up to 2MiB.</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">ekernel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">skernel</span><span class="p">;</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_size_4K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDUP_2N</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDUP_2N</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">);</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="n">kernel_image_end_4k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_PHYS_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_size_4K</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="n">kernel_image_end_2M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_PHYS_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="p">;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel size: %p, Rounded to 2MiB: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_size</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="p">);</span>
</code></pre></div>
<p>在 <code>kernel_image_end_2M</code> 后面，我们再开辟一个 2MiB 的页面作为 Kernel Direct Mapping 的第一个内存池，这是为了在第二阶段中，在最终的 <code>kallocpage</code> 还未能使用时，给 <code>kvmmake</code> 提供构建页表时所需要的物理页面。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">// Calculate Kernel Mapping Base &amp; End</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_phys_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_PHYS_BASE</span><span class="p">;</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_phys_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_phys_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="p">;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_virt_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_VIRT_BASE</span><span class="p">;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_virt_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_virt_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="p">;</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1">// Calculate the first Direct Mapping Base &amp; End</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_la_phy_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_image_end_2M</span><span class="p">;</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_la_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_DIRECT_MAPPING_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_la_phy_base</span><span class="p">;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_la_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_la_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">;</span>
</code></pre></div>
<p>然后，我们开始映射：VA <code>0x0000_0000_8020_0000</code> -&gt; PA <code>0x8020_0000</code></p>
<ol>
<li>在 <code>pgt_root</code> 上添加一条 PTE，使其指向第一级页表 <code>pgt_ident</code>。</li>
<li>从 <code>kernel_phys_base</code> 到 <code>kernel_phys_end</code>，每 2 MiB 添加一个 PTE 映射</li>
<li>计算该物理地址应该被映射到哪个虚拟地址上，在这个映射中，<code>va = pa</code>。</li>
<li>计算 <code>VPN1</code>，并在 <code>pgt_ident</code> 中添加映射。</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">// We will still have some instructions executed on pc 0x8020xxxx before jumping to KIVA.</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1">// Step 2. Setup Identity Mapping for 0x80200000 -&gt; 0x80200000, using 2MiB huge page.</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="p">{</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">VPN2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_phys_base</span><span class="p">);</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="n">pgt_root</span><span class="p">[</span><span class="n">VPN2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">((</span><span class="n">uint64</span><span class="p">)</span><span class="n">pgt_ident</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_phys_base</span><span class="p">;</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kernel_phys_end</span><span class="p">;</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">        </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pa</span><span class="p">;</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">        </span><span class="n">uint64</span><span class="w"> </span><span class="n">vpn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">);</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">        </span><span class="n">pgt_ident</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="p">);</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Mapping Identity: %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">pa</span><span class="p">);</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="p">}</span>
</code></pre></div>
<p>然后，我们开始映射内核 ELF 的虚拟地址：VA <code>0xffff_ffff_8020_0000</code> -&gt; PA <code>0x8020_0000</code>。
此时 <code>va = pa + KERNEL_OFFSET</code>。</p>
<p>最后，我们映射第一块 Direct Mapping：VA <code>0xffff_ffc0_80xx_0000</code> -&gt; 第一个空闲的 2 MiB 物理页 <code>0x80xx_0000</code>。</p>
<h3 id="_3">跳转<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<blockquote>
<p>code: os/main.c</p>
</blockquote>
<p>在 <code>bootcpu_entry</code> 的末尾，我们会调用 <code>bootcpu_start_relocation</code>，而在它的末尾，我们会使用汇编完成跳转 PC 到 <code>bootcpu_relocating</code>。</p>
<p><code>bootcpu_relocating</code> 会调用 <code>kvm_init</code> 完成对内核页表的设置与切换，它最终会跳转函数 <code>bootcpu_init</code>，并使用最终的栈 scheduler kernel stack(<code>mycpu()-&gt;sched_kstack_top</code>)。</p>
<p><code>bootcpu_init</code> 会完成接下来的内核初始化，包括启动其他 CPU，设置 Kernel Trap，初始化 kernel page manager 等。最终，它会调用 <code>scheduler()</code> 函数并永不返回。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">bootcpu_entry</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">mhartid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">=====</span><span class="se">\n</span><span class="s">Hello World!</span><span class="se">\n</span><span class="s">=====</span><span class="se">\n\n</span><span class="s">Boot stack: %p</span><span class="se">\n</span><span class="s">clean bss: %p - %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">boot_stack</span><span class="p">,</span><span class="w"> </span><span class="n">s_bss</span><span class="p">,</span><span class="w"> </span><span class="n">e_bss</span><span class="p">);</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">s_bss</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">e_bss</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_bss</span><span class="p">);</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel Starts Relocating...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="n">bootcpu_start_relocation</span><span class="p">();</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span><span class="c1">// We will jump to kernel&#39;s real pagetable in bootcpu_start_relocation.</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="n">__builtin_unreachable</span><span class="p">();</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="p">}</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bootcpu_start_relocation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bootcpu_relocating</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KERNEL_OFFSET</span><span class="p">;</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_stack_top</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KERNEL_OFFSET</span><span class="p">;</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">        </span><span class="s">&quot;mv a1, %0 </span><span class="se">\n</span><span class="s"> \</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="s">        mv sp, %1 </span><span class="se">\n</span><span class="s"> \</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="s">        jr a1&quot;</span><span class="w"> </span><span class="o">::</span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">sp</span><span class="p">));</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">    </span><span class="n">__builtin_unreachable</span><span class="p">();</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="p">}</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bootcpu_relocating</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Boot HART Relocated. We are at high address now! PC: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r_pc</span><span class="p">());</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="w">    </span><span class="c1">// Step 4. Rebuild final kernel pagetable</span>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="w">    </span><span class="n">kvm_init</span><span class="p">();</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">new_sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sched_kstack_top</span><span class="p">;</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">fn</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bootcpu_init</span><span class="p">;</span>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a><span class="w">        </span><span class="s">&quot;mv a1, %0 </span><span class="se">\n</span><span class="s"> \</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a><span class="s">        mv sp, %1 </span><span class="se">\n</span><span class="s"> \</span>
<a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a><span class="s">        jr a1&quot;</span><span class="w"> </span><span class="o">::</span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">new_sp</span><span class="p">));</span>
<a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a><span class="w">    </span><span class="n">__builtin_unreachable</span><span class="p">();</span>
<a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a><span class="p">}</span>
</code></pre></div>
<h2 id="_4">内核页表<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<blockquote>
<p>code: <code>os/kvm.c</code></p>
</blockquote>
<p>在完成 Relocation 后，我们调用 <code>kvm_init()</code> 来构造最终的内核页表，并切换到该页表上。</p>
<p>Relocation 时，我们会在 Direct Mapping 区间先借用一个 2M 的区域，即 <code>e_kernel</code> (0x802x_0000) 对齐到 2MiB (0x8040_0000) 后的下一个 2MiB 区域 <code>[0x8040_0000, 0x8060_0000)</code>。
在构建内核页表时，我们会需要申请物理页面来放置次级页表，我们称之为 <code>boot-stage page allocator</code>，这些页面的生命周期是持久的，永远不会被释放。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>[INFO  0,-1] kvm_init: boot-stage page allocator: base 0xffffffc080400000, end 0xffffffc080600000
</code></pre></div>
<p><code>kvmmake</code> 函数会调用 <code>kvmmap</code> 依次映射每个区域。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">static</span><span class="w"> </span><span class="n">pagetable_t</span><span class="w"> </span><span class="nf">kvmmake</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">kpgtbl</span><span class="p">;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="n">kpgtbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">allocsetuppage</span><span class="p">();</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="c1">// Step.1 : Kernel Image</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="c1">// Step.2 : Kernel Trampoline</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="c1">// Step.3 : Kernel Device MMIO :</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="c1">// Step.4 : Kernel Scheduler stack:</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="c1">// Step.5 : Kernel Direct Mapping</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="p">}</span>
</code></pre></div>
<p><code>kvmmap</code> 的原型为 <code>void kvmmap(pagetable_t kpgtbl, uint64 va, uint64 pa, uint64 sz, int perm)</code>，表示将 <code>[va, va+sz)</code> 映射到 <code>[pa, pa+sz)</code> 的区域上。</p>
<ol>
<li>对于 Kernel Image，我们映射三个分区：<code>.text</code> (RX), <code>.rodata</code> (RO), <code>.data (.bss)</code> (RW)。我们可以引用在 <code>kernel.ld</code> 中导出的地址符号 <code>e_text</code> 等来得到每个分区的起始地址和结束地址。注意我们直接引用符号 <code>s_text</code> 时，我们会解析得到它的虚拟地址；而它的物理地址则可以通过 <code>KIVA_TO_PA</code> 转换得到。</li>
</ol>
<p>在 <code>kernel.ld</code> 中的 <code>.text</code> 存在另一个特殊的页面，称为 trampoline，我们会在下一节课讲到它。我们将它映射到虚拟地址 <code>0x3f_ffff_f000</code> 上。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="w">    </span><span class="c1">// map kernel text executable and read-only.</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="c1">// 0xffff_ffff_8020_0000 -&gt; 0x8020_0000</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_text</span><span class="p">,</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">s_text</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">e_text</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_text</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">);</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="c1">// map kernel ro_data: s_rodata to e_rodata</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_rodata</span><span class="p">,</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">s_rodata</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">e_rodata</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_rodata</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="p">);</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="c1">// map kernel .s_data to .e_bss,</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">kimage_data_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">e_bss</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">s_data</span><span class="p">);</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_data</span><span class="p">,</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">s_data</span><span class="p">),</span><span class="w"> </span><span class="n">kimage_data_size</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="c1">// map trampoline</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">TRAMPOLINE</span><span class="p">,</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">trampoline</span><span class="p">),</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">);</span>
</code></pre></div>
<p>此时，<code>kernel_pagetable</code> 的结构如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>=== PageTable at 0xffffffc080400000 ===
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>[ff], pte[0xffffffc0804007f8]: 0x0000003fc0000000 -&gt; 0x0000000080403000 -------V
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>  [1ff], pte[0xffffffc080403ff8]: 0x0000003fffe00000 -&gt; 0x0000000080404000 -------V
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    [1ff], pte[0xffffffc080404ff8]: 0x0000003ffffff000 -&gt; 0x000000008020a000 -A--X-RV
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>[1fe], pte[0xffffffc080400ff0]: 0xffffffff80000000 -&gt; 0x0000000080401000 -------V
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>  [1], pte[0xffffffc080401008]: 0xffffffff80200000 -&gt; 0x0000000080402000 -------V
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>    [0], pte[0xffffffc080402000]: 0xffffffff80200000 -&gt; 0x0000000080200000 -A--X-RV
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>    ...
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>    [9], pte[0xffffffc080402048]: 0xffffffff80209000 -&gt; 0x0000000080209000 -A--X-RV
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>    [b], pte[0xffffffc080402058]: 0xffffffff8020b000 -&gt; 0x000000008020b000 -A----RV
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>    ...
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>    [20], pte[0xffffffc080402100]: 0xffffffff80220000 -&gt; 0x0000000080220000 -A----RV
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    [21], pte[0xffffffc080402108]: 0xffffffff80221000 -&gt; 0x0000000080221000 DA---WRV
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>    ...
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>    [2c], pte[0xffffffc080402160]: 0xffffffff8022c000 -&gt; 0x000000008022c000 DA---WRV
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>=== END ===
</code></pre></div>
<ol>
<li>然后，我们映射外设的 MMIO 区域，目前我们会使用到 PLIC 和 UART0 两个外设。</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="w">    </span><span class="c1">// Step.3 : Kernel Device MMIO :</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_PLIC_BASE</span><span class="p">,</span><span class="w"> </span><span class="n">PLIC_PHYS</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_PLIC_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_UART0_BASE</span><span class="p">,</span><span class="w"> </span><span class="n">UART0_PHYS</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_UART0_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
</code></pre></div>
<ol>
<li>然后，我们映射每个 cpu 的 scheduler 所用的栈。我们令每个 scheduler 的内核为两个 <code>PGSIZE</code>，并且相邻的两个栈空间相隔一段非法的地址，我们称之为 <code>guard page</code>。如果我们在内核栈上发生栈溢出，我们会得到一个 Page Fault 而不是内核带着错误悄无声息的继续运行。</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="w">    </span><span class="c1">// Step.4 : Kernel Scheduler stack:</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">sched_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_STACK_SCHED</span><span class="p">;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NCPU</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpu</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getcpu</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">        </span><span class="c1">// allocate #KERNEL_STACK_SIZE / PGSIZE pages</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_stack</span><span class="p">;</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sched_stack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">            </span><span class="n">uint64</span><span class="w"> </span><span class="n">__pa</span><span class="w"> </span><span class="n">newpg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KVA_TO_PA</span><span class="p">(</span><span class="n">allockernelpage</span><span class="p">());</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">            </span><span class="n">debugf</span><span class="p">(</span><span class="s">&quot;map halt %d, va:%p, pa:%p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">newpg</span><span class="p">);</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">            </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">newpg</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">        </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sched_kstack_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_stack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="p">;</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">        </span><span class="c1">// double the sched_stack to make a significant gap between different cpus.</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">        </span><span class="c1">//  if any kernel stack overflows, it will page fault.</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">        </span><span class="n">sched_stack</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="p">;</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>内核 scheduler 栈的结构如下所示，尽管所分配的页面在物理地址上是连续的，但是在虚拟地址上我们可以故意令它不连续。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>[1ff], pte[0xffffffc080400ff8]: 0xffffffffc0000000 -&gt; 0x0000000080405000 -------V
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>  [1f8], pte[0xffffffc080405fc0]: 0xffffffffff000000 -&gt; 0x0000000080408000 -------V
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    [0], pte[0xffffffc080408000]: 0xffffffffff000000 -&gt; 0x0000000080407000 DA---WRV
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    [1], pte[0xffffffc080408008]: 0xffffffffff001000 -&gt; 0x0000000080409000 DA---WRV
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    [4], pte[0xffffffc080408020]: 0xffffffffff004000 -&gt; 0x000000008040a000 DA---WRV
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    [5], pte[0xffffffc080408028]: 0xffffffffff005000 -&gt; 0x000000008040b000 DA---WRV
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    [8], pte[0xffffffc080408040]: 0xffffffffff008000 -&gt; 0x000000008040c000 DA---WRV
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    [9], pte[0xffffffc080408048]: 0xffffffffff009000 -&gt; 0x000000008040d000 DA---WRV
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    [c], pte[0xffffffc080408060]: 0xffffffffff00c000 -&gt; 0x000000008040e000 DA---WRV
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>    [d], pte[0xffffffc080408068]: 0xffffffffff00d000 -&gt; 0x000000008040f000 DA---WRV
</code></pre></div>
<ol>
<li>最后，计算系统中所有应该被 Direct Mapping 管理的页面，即 <code>kernel_image_end_2M</code> 开始到物理内存空间的结束，从 <code>0xffffffc0_80400000 -&gt; 0x00000000_80400000</code> 处开始映射。注意到 <code>boot-stage page allocator</code> 所用的区域（<code>[0x8040_0000, 0x8060_0000)</code>）也会在这个映射范围之内。</li>
</ol>
<p>之后，将剩下的空间交给 <code>kalloc.c</code> 中的 <code>kpgmgr</code> 管理：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="w">    </span><span class="c1">// So page allocator should starts after these used pages.</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="n">kpage_allocator_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init_page_allocator</span><span class="p">;</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="n">kpage_allocator_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available_mems</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">init_page_allocator</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">init_page_allocator_base</span><span class="p">);</span>
</code></pre></div>
<h3 id="kvmmap">kvmmap<a class="headerlink" href="#kvmmap" title="Permanent link">&para;</a></h3>
<p><code>kvmmap</code> 的逻辑非常简单，按照 Sv39 的三级页表格式对 <code>vaddr</code> 展开到三个 index：<code>vpn2</code>, <code>vpn1</code>, 和 <code>vpn0</code>，随后开始逐级往下走 <code>pgtbl_level1</code>, <code>pgtbl_level0</code>。当遇到未被分配的次级页表时，从 <code>allockernelpage</code> 处分配一个，并设置上级到次级的 PTE (<code>RWX=000</code>) 即可。最后，在最后一级按照给定的 <code>perm</code> 设置 PTE ：<code>pgtbl_level0[vpn0] = MAKE_PTE(paddr, perm)</code>。</p>
<p>当然，当我们映射一大片对齐到 2MiB 的内存区域时，我们可以使用一个 2MiB 的大页映射，而不是多个 4KiB 的映射。这需要满足大页映射的条件： <code>IS_ALIGNED(vaddr, PGSIZE_2M) &amp;&amp; IS_ALIGNED(paddr, PGSIZE_2M) &amp;&amp; sz &gt;= PGSIZE_2M</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kvmmap</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">PGALIGNED</span><span class="p">(</span><span class="n">va</span><span class="p">));</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">PGALIGNED</span><span class="p">(</span><span class="n">pa</span><span class="p">));</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">PGALIGNED</span><span class="p">(</span><span class="n">sz</span><span class="p">));</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="n">debugf</span><span class="p">(</span><span class="s">&quot;va:%p, pa:%p, sz:%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">);</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">    </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">pgtbl_level1</span><span class="p">,</span><span class="w"> </span><span class="n">pgtbl_level0</span><span class="p">;</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">vpn2</span><span class="p">,</span><span class="w"> </span><span class="n">vpn1</span><span class="p">,</span><span class="w"> </span><span class="n">vpn0</span><span class="p">;</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">vaddr</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">va</span><span class="p">;</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">paddr</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">pa</span><span class="p">;</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">vaddr_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vaddr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sz</span><span class="p">;</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">vaddr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vaddr_end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">        </span><span class="c1">// try to add mapping: vaddr -&gt; pa</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">        </span><span class="n">vpn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">        </span><span class="n">vpn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">        </span><span class="n">vpn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">[</span><span class="n">vpn2</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">            </span><span class="c1">// kpgtbl[vpn2] is not a valid PTE, allocate the level 1 pagetable.</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="w">            </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">newpg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allockernelpage</span><span class="p">();</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="w">            </span><span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">newpg</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="w">            </span><span class="n">pgtbl_level1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">newpg</span><span class="p">;</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="w">            </span><span class="n">kpgtbl</span><span class="p">[</span><span class="n">vpn2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">KVA_TO_PA</span><span class="p">(</span><span class="n">newpg</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="w">            </span><span class="n">pte_t</span><span class="w"> </span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kpgtbl</span><span class="p">[</span><span class="n">vpn2</span><span class="p">];</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="w">            </span><span class="c1">// check validity: pte must points to next level page table.</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_R</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">))</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="w">                </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kvmmap: vaddr %p already mapped at level 2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="w">            </span><span class="n">pgtbl_level1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">PA_TO_KVA</span><span class="p">(</span><span class="n">PTE2PA</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">[</span><span class="n">vpn2</span><span class="p">]));</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="w">            </span><span class="c1">// pgtbl_level1[vpn1] is not a valid PTE.</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="w">            </span><span class="c1">//   try to allocate 2M page</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="w">            </span><span class="c1">//   , or allocate the level 1 pagetable.</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sz</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a><span class="w">                </span><span class="c1">// it&#39;s ok for a huge page.</span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="w">                </span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="w">                </span><span class="n">vaddr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">;</span>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="w">                </span><span class="n">paddr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">;</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="w">                </span><span class="n">sz</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">;</span>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a><span class="w">            </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">newpg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allockernelpage</span><span class="p">();</span>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="w">            </span><span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">newpg</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a><span class="w">            </span><span class="n">pgtbl_level0</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">newpg</span><span class="p">;</span>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a><span class="w">            </span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">KVA_TO_PA</span><span class="p">(</span><span class="n">newpg</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a><span class="w">            </span><span class="n">pte_t</span><span class="w"> </span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">];</span>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a><span class="w">            </span><span class="c1">// check validity: pte must points to next level page table.</span>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_R</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">))</span>
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a><span class="w">                </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kvmmap: vaddr %p already mapped at level 1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a><span class="w">            </span><span class="n">pgtbl_level0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">PA_TO_KVA</span><span class="p">(</span><span class="n">PTE2PA</span><span class="p">(</span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]));</span>
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a><span class="w">        </span><span class="c1">// check validity: pte must points to next level page table.</span>
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgtbl_level0</span><span class="p">[</span><span class="n">vpn0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a><span class="w">            </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kvmmap: vaddr %p already mapped at level 0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a><span class="w">        </span><span class="n">pgtbl_level0</span><span class="p">[</span><span class="n">vpn0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a><span class="w">        </span><span class="n">vaddr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a><span class="w">        </span><span class="n">paddr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a><span class="w">        </span><span class="n">sz</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">vaddr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">vaddr_end</span><span class="p">);</span>
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">sz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a><span class="p">}</span>
</code></pre></div>
<h2 id="_5">固定大小对象分配器<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>TODO</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-copyright">
    <div class="md-copyright__highlight">
        commit: 
        <a href="https://github.com/yuk1i/os-next-docs/commit/b2d5a4c6, 2025-03-19 19:12:02+08:00" target="_blank" rel="noopener">
            b2d5a4c6, 2025-03-19 19:12:02+08:00
        </a>
    </div>
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>