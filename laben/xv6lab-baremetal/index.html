
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../lab2/">
      
      
        <link rel="next" href="../../qrh/nav/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Week 3 - Bare Metal - 操作系统实验文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bare-metal-programming" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-header__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            操作系统实验文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Week 3 - Bare Metal
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../env/" class="md-tabs__link">
          
  
  实验环境搭建

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../lab/lab1/" class="md-tabs__link">
          
  
  每周实验

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab2/" class="md-tabs__link">
          
  
  Weekly Lab Material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qrh/nav/" class="md-tabs__link">
          
  
  快速参考手册

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-nav__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    操作系统实验文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    实验环境搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            实验环境搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux VM 搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Linux VM 搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/windows-vmware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + VMware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/wsl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + WSL (不推荐)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS + VMware
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    手动环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    验证环境
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    每周实验
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            每周实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 1 - Linux基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C 语言基础及Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - 裸机程序 Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - 上下文切换 Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - 内核页表 Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - 用户空间 Userspace
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Weekly Lab Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Weekly Lab Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C language basic & Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Week 3 - Bare Metal
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Week 3 - Bare Metal
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#privilege-levels" class="md-nav__link">
    <span class="md-ellipsis">
      Privilege Levels
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Privilege Levels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aarch64-x86" class="md-nav__link">
    <span class="md-ellipsis">
      AArch64 &amp; x86
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#csr-control-and-status-registers" class="md-nav__link">
    <span class="md-ellipsis">
      CSR (Control and Status Registers)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#runtime-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Runtime Environment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#boot-process-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Boot Process Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Boot Process Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stage-0-from-cpu-power-on" class="md-nav__link">
    <span class="md-ellipsis">
      Stage 0: From CPU Power-On
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-stage-opensbi" class="md-nav__link">
    <span class="md-ellipsis">
      Next Stage: OpenSBI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#following-stage-kernel-boot" class="md-nav__link">
    <span class="md-ellipsis">
      Following Stage: Kernel Boot
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Following Stage: Kernel Boot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compilation-process" class="md-nav__link">
    <span class="md-ellipsis">
      Compilation Process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linker-script" class="md-nav__link">
    <span class="md-ellipsis">
      Linker Script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sbi-call" class="md-nav__link">
    <span class="md-ellipsis">
      SBI Call
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    快速参考手册
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            快速参考手册
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/nav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/vf2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VisionFive2 板子教程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/ssh-vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH & VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#privilege-levels" class="md-nav__link">
    <span class="md-ellipsis">
      Privilege Levels
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Privilege Levels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aarch64-x86" class="md-nav__link">
    <span class="md-ellipsis">
      AArch64 &amp; x86
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#csr-control-and-status-registers" class="md-nav__link">
    <span class="md-ellipsis">
      CSR (Control and Status Registers)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#runtime-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Runtime Environment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#boot-process-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Boot Process Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Boot Process Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stage-0-from-cpu-power-on" class="md-nav__link">
    <span class="md-ellipsis">
      Stage 0: From CPU Power-On
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-stage-opensbi" class="md-nav__link">
    <span class="md-ellipsis">
      Next Stage: OpenSBI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#following-stage-kernel-boot" class="md-nav__link">
    <span class="md-ellipsis">
      Following Stage: Kernel Boot
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Following Stage: Kernel Boot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compilation-process" class="md-nav__link">
    <span class="md-ellipsis">
      Compilation Process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linker-script" class="md-nav__link">
    <span class="md-ellipsis">
      Linker Script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sbi-call" class="md-nav__link">
    <span class="md-ellipsis">
      SBI Call
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="bare-metal-programming">Bare Metal Programming<a class="headerlink" href="#bare-metal-programming" title="Permanent link">&para;</a></h1>
<p>When programming in a Linux environment, the <code>libc</code> functions and well-encapsulated system calls provided by the Linux environment allow us to focus primarily on the logic of our program to interact with the operating system. For instance, when we use <code>printf</code> and <code>scanf</code> to operate on standard input/output streams, the user-space runtime environment is provided by <code>libc</code>, while the kernel environment is supplied by the Linux Kernel.</p>
<p>However, when writing our own operating system, we lack the runtime environment provided by Linux or any other operating system. Instead, we interact directly with the CPU and hardware. Such programs, which directly interface with the CPU and hardware, are called <strong>bare-metal programs</strong>.</p>
<div class="admonition info">
<p class="admonition-title">What is a Bare-Metal Program</p>
<p>A <strong>bare-metal program</strong> is a type of software that runs directly on the hardware of a device without relying on an underlying operating system (OS). Essentially, it's code that interacts with the hardware at the most fundamental level, controlling the processor, memory, input/output (I/O) devices, and other components directly.</p>
</div>
<p>In our xv6 experiments, we will write operating system programs on the RISC-V architecture.</p>
<h3 style="color: orange;">Lab Step 1: Running the First Bare-Metal Program</h3>

<div class="admonition info">
<p class="admonition-title">xv6-lab1 Code Branch</p>
<p><a href="https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab1">https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab1</a></p>
<p>Use the command <code>git clone https://github.com/yuk1i/SUSTech-OS-2025 -b xv6-lab1 xv6lab1</code> to download the xv6-lab1 code.</p>
<p>It is recommended to download the code for each lab in a separate location.</p>
</div>
<p>After cloning the repository, you can run <code>make</code> locally to compile the xv6 kernel. Once the kernel is successfully compiled with <code>make</code>, you can use <code>make run</code> to invoke QEMU and run our first xv6 operating system.</p>
<p>The <code>make run</code> command executes the following:<br />
<code>qemu-system-riscv64 -nographic -machine virt -cpu rv64 -m 512 -kernel build/kernel</code>, which means:</p>
<ul>
<li>Use <code>qemu-system-riscv64</code> to emulate a RISC-V 64-bit CPU.</li>
<li><code>-nographic</code>: Disable graphical output.</li>
<li><code>-machine virt</code>: Use the <code>virt</code> machine model.</li>
<li><code>-cpu rv64</code>: Use a RISC-V 64-bit CPU.</li>
<li><code>-m 512</code>: Specify 512 MiB of memory.</li>
<li><code>-kernel build/kernel</code>: Load the kernel file from <code>build/kernel</code>.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">What is QEMU?</p>
<p>QEMU is an open-source virtual machine software that can emulate various hardware platforms, including x86, ARM, MIPS, SPARC, and more. It supports running multiple operating systems such as Linux, Windows, macOS, FreeBSD, etc. QEMU is widely used for virtualization, emulation, debugging, and testing in various scenarios. It supports full-system emulation and user-mode emulation, allowing users to run operating systems and programs designed for one architecture on a different architecture.</p>
<p>In our operating system course, we use a virtual machine running a Linux system on an existing OS. Within this Linux system, we use QEMU to emulate a RISC-V 64-bit architecture virtual machine, on which we run the operating system we develop.</p>
</div>
<p>The output of running the program is as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$ make run
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>qemu-system-riscv64 -nographic -machine virt -cpu rv64 -m 512 -kernel build/kernel 
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>OpenSBI v1.5
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>   ____                    _____ ____ _____
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>  / __ \                  / ____|  _ \_   _|
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a> | |  | |_ __   ___ _ __ | (___ | |_) || |
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a> | |  | | &#39;_ \ / _ \ &#39;_ \ \___ \|  _ &lt; | |
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a> | |__| | |_) |  __/ | | |____) | |_) || |_
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>  \____/| .__/ \___|_| |_|_____/|____/_____|
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        | |
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        |_|
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>Platform Name             : riscv-virtio,qemu
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>Platform Features         : medeleg
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>Platform HART Count       : 1
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>Platform IPI Device       : aclint-mswi
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>Platform Timer Device     : aclint-mtimer @ 10000000Hz
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>Platform Console Device   : uart8250
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>Platform HSM Device       : ---
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>Platform PMU Device       : ---
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>Platform Reboot Device    : syscon-reboot
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>Platform Shutdown Device  : syscon-poweroff
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>Platform Suspend Device   : ---
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>Platform CPPC Device      : ---
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>Firmware Base             : 0x80000000
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>Firmware Size             : 327 KB
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>Firmware RW Offset        : 0x40000
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>Firmware RW Size          : 71 KB
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>Firmware Heap Offset      : 0x49000
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>Firmware Heap Size        : 35 KB (total), 2 KB (reserved), 11 KB (used), 21 KB (free)
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>Firmware Scratch Size     : 4096 B (total), 416 B (used), 3680 B (free)
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>Runtime SBI Version       : 2.0
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>Domain0 Name              : root
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>Domain0 Boot HART         : 0
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>Domain0 HARTs             : 0*
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>Domain0 Region00          : 0x0000000000100000-0x0000000000100fff M: (I,R,W) S/U: (R,W)
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>Domain0 Region01          : 0x0000000010000000-0x0000000010000fff M: (I,R,W) S/U: (R,W)
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>Domain0 Region02          : 0x0000000002000000-0x000000000200ffff M: (I,R,W) S/U: ()
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>Domain0 Region03          : 0x0000000080040000-0x000000008005ffff M: (R,W) S/U: ()
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>Domain0 Region04          : 0x0000000080000000-0x000000008003ffff M: (R,X) S/U: ()
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>Domain0 Region05          : 0x000000000c400000-0x000000000c5fffff M: (I,R,W) S/U: (R,W)
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>Domain0 Region06          : 0x000000000c000000-0x000000000c3fffff M: (I,R,W) S/U: (R,W)
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>Domain0 Region07          : 0x0000000000000000-0xffffffffffffffff M: () S/U: (R,W,X)
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>Domain0 Next Address      : 0x0000000080200000
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>Domain0 Next Arg1         : 0x000000009fe00000
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>Domain0 Next Mode         : S-mode
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>Domain0 SysReset          : yes
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>Domain0 SysSuspend        : yes
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>Boot HART ID              : 0
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>Boot HART Domain          : root
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>Boot HART Priv Version    : v1.12
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>Boot HART Base ISA        : rv64imafdch
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>Boot HART ISA Extensions  : sstc,zicntr,zihpm,zicboz,zicbom,sdtrig
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>Boot HART PMP Count       : 16
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>Boot HART PMP Granularity : 2 bits
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>Boot HART PMP Address Bits: 54
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>Boot HART MHPM Info       : 16 (0x0007fff8)
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>Boot HART Debug Triggers  : 2 triggers
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>Boot HART MIDELEG         : 0x0000000000001666
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>Boot HART MEDELEG         : 0x0000000000f0b509
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>clean bss: 0x0000000080207000 - 0x0000000080207000
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>Kernel booted.
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>Hello World!
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>sysregs:
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>sstatus : 0x8000000200006000
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>scause  : 0x0000000000000000
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>sepc    : 0x0000000000000000
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>stval   : 0x0000000000000000
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>sip     : 0x0000000000000000
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>sie     : 0x0000000000000000
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>satp    : 0x0000000000000000
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>0x00000000deadbeef
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>kernel ends, parking...
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">How to Exit QEMU</p>
<p>Press <code>Ctrl</code> and <code>A</code> simultaneously, release them, then press <code>X</code>.</p>
<p>If this method doesn’t work due to prior key presses, you can directly close the terminal.</p>
</div>
<p style="color: orange;">Lab Step 1 Completed</p>

<p>The above lab process demonstrates the boot process of a minimal kernel. Next, we will explain how an operating system starts running from the perspective of <strong>privilege levels</strong>. First, let’s understand what privilege levels are.</p>
<h2 id="privilege-levels">Privilege Levels<a class="headerlink" href="#privilege-levels" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">Privilege Levels (riscv-privileged.pdf)</p>
<p>Privilege levels is a concept in computer systems used to define the access control and permissions that different processes or users have within the system.<br />
The existence of privilege levels aims to protect system resources, ensure security, and isolate processes based on trust and functionality.</p>
<p>At any time, a RISC-V hardware thread (hart) is running at some privilege level encoded as a mode in one or more CSRs (control and status registers). </p>
<p>Three RISC-V privilege levels are currently defined as shown in Table 1.1. </p>
<p>Privilege levels are used to provide protection between different components of the software stack, and attempts to perform operations not permitted by the current privilege mode will cause an exception to be raised. </p>
<p>These exceptions will normally cause traps into an underlying execution environment.</p>
</div>
<p>Privilege levels are a critical state of the CPU during execution, indicating the level of privilege the currently running code possesses. Code with the highest privilege level has unrestricted access to all resources, such as all physical memory and peripherals. Higher privilege levels can restrict the resources accessible to lower privilege levels. For example, a lower privilege level cannot access memory or CSR registers owned by a higher privilege level. However, when the CPU is running at a lower privilege level, the program can actively or passively switch to a higher privilege level and execute predefined code.</p>
<div class="admonition info">
<p class="admonition-title">Why Privilege Levels Are Needed</p>
<p>The primary purpose of introducing privilege levels in CPU design is to ensure system security and stability. In modern computer systems, the operating system needs to strictly manage and control hardware resources. Privilege levels help the operating system isolate the kernel from user programs, preventing untrusted code or applications from improperly manipulating critical system components.</p>
<p>For example, CPU time is an important "hardware resource." Modern operating systems achieve the illusion that multiple user programs are running simultaneously by scheduling them to execute in turns. The operating system (running at a high privilege level) manages CPU time by forcing an application to pause after executing for a certain period, switching to the next application.  </p>
<p>Without privilege levels to enforce this, relying on applications to voluntarily yield CPU time would allow a malicious program to monopolize the CPU, causing all other applications on the system to become unresponsive.</p>
</div>
<p>Privilege levels are <strong>implemented in the CPU hardware circuitry</strong>, not simulated through software. In RISC-V, privilege levels are distinguished using 2 bits, defining three modes: <strong>M mode</strong>, <strong>S mode</strong>, and <strong>U mode</strong>.</p>
<p><img alt="image" src="../../assets/xv6lab-baremetal/riscv-priviledge-levels.png" /></p>
<blockquote>
<p>The machine level has the highest privileges and is the only mandatory privilege level for a RISC-V hardware platform. Code run in machine-mode (M-mode) is usually inherently trusted, as it has low-level access to the machine implementation. M-mode can be used to manage secure execution environments on RISC-V. User-mode (U-mode) and supervisor-mode (S-mode) are intended for conventional application and operating system usage respectively.</p>
</blockquote>
<ul>
<li><strong>M mode</strong>: The highest privilege level in the RISC-V architecture, typically running firmware like OpenSBI, with direct access to physical memory.</li>
<li><strong>S mode</strong>: Designed for operating systems, capable of setting up virtual memory.</li>
<li><strong>U mode</strong>: Designed for user programs, with the least privileges, also supporting virtual memory.</li>
</ul>
<p>In bare-metal programming, we need to initialize the CPU state, including basic functionalities like page tables and interrupts. 
These CPU states are controlled via <strong>CSRs (Control and Status Registers)</strong>, which are generally only accessible and modifiable by higher privilege levels.</p>
<h3 id="aarch64-x86">AArch64 &amp; x86<a class="headerlink" href="#aarch64-x86" title="Permanent link">&para;</a></h3>
<p>Modern instruction set architectures all define different privilege levels.</p>
<p>The <strong>AArch64</strong> (ARM64) architecture, commonly used in mobile devices, defines four privilege levels (Exception Levels) from lowest to highest: <strong>EL0</strong>, <strong>EL1</strong>, <strong>EL2</strong>, and <strong>EL3</strong>. 
Similar to RISC-V, the highest privilege level, <strong>EL3</strong>, runs low-level firmware (Secure Monitor), <strong>EL1</strong> runs the operating system (OS), <strong>EL0</strong> runs user programs, and <strong>EL2</strong> runs virtual machine programs (Hypervisor).</p>
<p>The <strong>x86</strong> (IA32 &amp; AMD64) architecture defines privilege levels as four <strong>Rings</strong>: <strong>Ring 0</strong> is the highest privilege level, running the operating system, while <strong>Ring 3</strong> is the lowest, running user programs. Typically, x86 systems only use <strong>Ring 0</strong> and <strong>Ring 3</strong>.</p>
<p><img alt="alt text" src="../../assets/xv6lab-baremetal/x86-privilege-levels.png" /></p>
<!-- !!!info "Why Define Privilege Levels Needed"
    By comparing the privilege levels defined in the three architectures mentioned above, we can see that the execution environments of user programs and the operating system are strictly separated. This allows the operating system to effectively isolate access between user programs and the operating system, as well as between different user programs. -->
<!-- **Operating Systems: Three Easy Pieces** three fundamental components of an operating system：Virtualization、Concurrency、Persistence. -->

<h2 id="csr-control-and-status-registers">CSR (Control and Status Registers)<a class="headerlink" href="#csr-control-and-status-registers" title="Permanent link">&para;</a></h2>
<p>Unlike the 32 general-purpose registers, CSRs are special registers.</p>
<p><strong>CSR (Control and Status Registers)</strong> are critical register sets used to control CPU behavior, store system state, and manage exceptions and interrupts. CSRs require special instructions to access.</p>
<p>Each CSR has privilege-level restrictions. For example:The <code>time</code> and <code>cycle</code> registers can be read by <strong>U mode</strong> but cannot be modified.S-mode CSRs like <code>sstatus</code> can be read and written by <strong>S mode</strong> and <strong>M mode</strong>.M-mode CSRs like <code>mstatus</code> can only be read and written by <strong>M mode</strong>.  Attempting to access a higher-privilege CSR from a lower privilege level will trigger an exception.</p>
<p>Each CSR contains defined fields that occupy specific bits, representing particular meanings. We’ll explore CSRs further in subsequent lessons.</p>
<h2 id="runtime-environment">Runtime Environment<a class="headerlink" href="#runtime-environment" title="Permanent link">&para;</a></h2>
<p>Across the three privilege levels in RISC-V, the architecture defines three runtime states: <strong>Firmware (Machine mode)</strong>, <strong>Operating System (Supervisor mode)</strong>, and <strong>User Mode (User mode)</strong>.</p>
<p>In RISC-V, the runtime environment provided by the operating system (Supervisor) to applications is called the <strong>ABI (Application Binary Interface)</strong>, while the runtime environment provided by the firmware (Machine mode, SEE) to the operating system (Supervisor, OS) is called the <strong>SBI (Supervisor Binary Interface)</strong>.</p>
<p><img alt="image" src="../../assets/xv6lab-baremetal/riscv-priviledge-arch.png" /></p>
<p>OpenSBI provides access interfaces to basic hardware and offers services to <strong>S mode</strong> through a syscall-like mechanism known as <strong>SBI Calls</strong>. These include basic serial I/O functions like <code>sbi_console_putchar</code> and <code>sbi_console_getchar</code>.</p>
<h2 id="boot-process-overview">Boot Process Overview<a class="headerlink" href="#boot-process-overview" title="Permanent link">&para;</a></h2>
<p>The boot process of an operating system involves initializing each level of the runtime environment. Typically, we start initializing from the highest privilege level and progressively descend to lower privilege levels.</p>
<p>From the moment the CPU powers on and resets, it begins executing the first instruction. At this point, the CPU typically executes code from a small ROM area, either internal or external to the chip, known as the <strong>Bootloader</strong>. The bootloader can be considered "Stage 0" of the boot process, with its primary tasks being to locate the next stage’s image, copy it into memory, and jump to it.</p>
<p>On the RISC-V platform, the next stage is the initialization of the <strong>SBI (Supervisor Binary Interface)</strong>, which we implement using <strong>OpenSBI</strong>. Thus, in Stage 0, the OpenSBI image and our kernel image are loaded into memory. The bootloader then jumps the CPU to the OpenSBI load address, starting its execution and entering the next stage.</p>
<p><img alt="image" src="../../assets/xv6lab-baremetal/risc-v-boot-process.png" /></p>
<p>In this stage, OpenSBI initializes critical system devices. Once OpenSBI completes the <strong>M mode</strong> initialization, it downgrades the CPU privilege to <strong>S mode</strong> and jumps to the kernel’s entry point, officially starting kernel code execution.</p>
<p>Below, we’ll explain the tasks of each stage in detail:</p>
<h3 id="stage-0-from-cpu-power-on">Stage 0: From CPU Power-On<a class="headerlink" href="#stage-0-from-cpu-power-on" title="Permanent link">&para;</a></h3>
<p>Upon powering on, the CPU undergoes a hardware-level reset. Recall how, in digital logic courses, we reset a <code>reg</code> variable when <code>rst_n</code> is triggered.</p>
<p>The reset sets the <strong>Program Counter (PC)</strong> to a fixed value called the <strong>Reset Vector</strong>, the address of the first instruction executed after power-on.
This address typically points to a <strong>Block ROM</strong> on the RISC-V chip, a read-only code region. After executing the Reset Vector code, control flow jumps to the next stage.
In QEMU, this next stage is the <strong>M mode</strong> OpenSBI.</p>
<!-- The code of the Reset Vector will jump to the loading address of OpenSBI at `0x8000_0000` to continue execution. This is the firmware running in M mode. -->

<div class="admonition info">
<p class="admonition-title">What is Implementation-Defined Behavior?</p>
<p>The Reset Vector value for each RISC-V hardware is determined by its implementation. The RISC-V manual does not mandate a specific Reset Vector value, making it <strong>Implementation-Defined</strong>.</p>
</div>
<h3 style="color: orange;">Lab Step 2: GDB Debugging to Observe the Boot Process</h3>

<div class="admonition info">
<p class="admonition-title">GDB Debugging</p>
<p>GDB (GNU Debugger) is a powerful open-source debugging tool, primarily used for debugging programs written in languages like C and C++. It helps developers identify and fix errors by supporting features such as setting breakpoints, stepping through code, inspecting variable values, and checking memory states.</p>
<p>Using GDB, we can set breakpoints and observe the operating system’s execution process while running it in QEMU.</p>
</div>
<p>First, add the line <code>set auto-load safe-path /</code> to your <code>~/.gdbinit</code> file to allow GDB to automatically load the <code>.gdbinit</code> file in the current directory.</p>
<p>In one terminal, run <code>make debug</code>. This launches <code>qemu-system-riscv64</code> with the parameters <code>-S -gdb tcp::3333</code>, indicating that it will wait for a debugger to attach.<br />
Then, in another terminal (ensuring the working directory matches the first terminal), run <code>gdb-multiarch</code>. This starts the GDB debugger and automatically loads the <code>.gdbinit</code> file in the current directory.</p>
<p>If everything works correctly, GDB will pause at address <code>0x1000</code>, the Reset Vector address for the QEMU platform.</p>
<p><img alt="alt text" src="../../assets/xv6lab-baremetal/report1-instruction.png" /></p>
<p>Use the command <code>x/10i $pc</code> to print the next 10 instructions pointed to by the current PC.</p>
<div class="admonition question">
<p class="admonition-title">Lab Report 1</p>
<p>Find the instruction address that QEMU’s bootloader jumps to after completing execution.  </p>
<p>Use <code>si</code> to step to the next instruction. When you reach <code>jr t0</code>, use <code>print $t0</code> to print the value of the <code>t0</code> register.  </p>
<p>Record the value of the <code>t0</code> register in your lab report.</p>
</div>
<div class="admonition question">
<p class="admonition-title">Lab Report 2</p>
<p>Determine what content QEMU loads into memory during startup.  </p>
<p>Referring to Lab Report 1, open a GDB terminal and run the command <code>monitor info roms</code>. Fill the output information into the table in your lab report.  </p>
<p>In each output line, <code>addr</code> indicates the starting address of the loaded content, <code>size</code> indicates the length of the content, and <code>mem=rom/ram</code> indicates whether the segment is read-only ROM or writable RAM.</p>
</div>
<p style="color: orange;">Lab Step 2 Completed</p>

<h3 id="next-stage-opensbi">Next Stage: OpenSBI<a class="headerlink" href="#next-stage-opensbi" title="Permanent link">&para;</a></h3>
<p>In computing, <strong>firmware</strong> is a specific type of software that provides low-level control for a device’s hardware and can load additional software. For complex software (like an operating system), firmware provides a standardized operating environment.
For simpler devices, firmware may act as the complete operating system, handling all control, monitoring, and data manipulation functions.<br />
In x86-based systems, the firmware is <strong>BIOS</strong> or <strong>UEFI</strong>; in RISC-V-based systems, it is <strong>OpenSBI</strong>. OpenSBI runs in <strong>M mode</strong> because firmware requires direct hardware access.</p>
<p>At this stage, OpenSBI initializes critical system devices, referred to as <strong>platform-level devices</strong>. These are shared across the system, meaning multiple CPUs (or HARTs) see the same device.</p>
<p><img alt="alt text" src="../../assets/xv6lab-baremetal/xv6lab-baremetal-system-hierarchy.png" /></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Platform Name             : riscv-virtio,qemu
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>Platform Features         : medeleg
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>Platform HART Count       : 1
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>Platform IPI Device       : aclint-mswi
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>Platform Timer Device     : aclint-mtimer @ 10000000Hz
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>Platform Console Device   : uart8250
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>Platform HSM Device       : ---
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>Platform PMU Device       : ---
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>Platform Reboot Device    : syscon-reboot
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>Platform Shutdown Device  : syscon-poweroff
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>Platform Suspend Device   : ---
</code></pre></div>
<p>Next, OpenSBI designates the next stage as our kernel:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Domain0 Next Address      : 0x0000000080200000
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Domain0 Next Arg1         : 0x000000009fe00000
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>Domain0 Next Mode         : S-mode
</code></pre></div>
<p>It also initializes HART-related configurations:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Boot HART ID              : 0
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>Boot HART Domain          : root
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>Boot HART Priv Version    : v1.12
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>Boot HART Base ISA        : rv64imafdch
</code></pre></div>
<h3 id="following-stage-kernel-boot">Following Stage: Kernel Boot<a class="headerlink" href="#following-stage-kernel-boot" title="Permanent link">&para;</a></h3>
<p>After OpenSBI completes initialization, it downgrades to <strong>S mode</strong> and sets the PC to our kernel’s starting address, <code>0x80200000</code>. This address holds the first instruction of the kernel’s entry point, <code>_entry</code>, marking the point where CPU control is handed over to our xv6 kernel.</p>
<p>The <code>_entry</code> code is located in the <code>entry.S</code> file. But <strong>how does this code end up at the kernel’s starting address, <code>0x80200000</code>?</strong></p>
<h4 id="compilation-process">Compilation Process<a class="headerlink" href="#compilation-process" title="Permanent link">&para;</a></h4>
<p>Let’s examine the kernel compilation process:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w"> </span>/d/o/SUSTech-OS-2025<span class="w"> </span><span class="o">(</span>xv6-lab1<span class="o">)</span>&gt;<span class="w"> </span>make
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>riscv64-unknown-elf-gcc<span class="w"> </span>-fPIE<span class="w"> </span>-fno-pic<span class="w"> </span>-fno-plt<span class="w"> </span>-Wall<span class="w"> </span>-Wno-unused-variable<span class="w"> </span>-Werror<span class="w"> </span>-O<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>-ggdb<span class="w"> </span>-march<span class="o">=</span>rv64g<span class="w"> </span>-MD<span class="w"> </span>-mcmodel<span class="o">=</span>medany<span class="w"> </span>-ffreestanding<span class="w"> </span>-fno-common<span class="w"> </span>-nostdlib<span class="w"> </span>-mno-relax<span class="w"> </span>-Ios<span class="w"> </span>-std<span class="o">=</span>gnu17<span class="w"> </span>-fno-stack-protector<span class="w"> </span>-D<span class="w"> </span>LOG_LEVEL_ERROR<span class="w"> </span>-c<span class="w"> </span>os/console.c<span class="w"> </span>-o<span class="w"> </span>build/os/console.o
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>riscv64-unknown-elf-gcc<span class="w"> </span>-fPIE<span class="w"> </span>-fno-pic<span class="w"> </span>-fno-plt<span class="w"> </span>-Wall<span class="w"> </span>-Wno-unused-variable<span class="w"> </span>-Werror<span class="w"> </span>-O<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>-ggdb<span class="w"> </span>-march<span class="o">=</span>rv64g<span class="w"> </span>-MD<span class="w"> </span>-mcmodel<span class="o">=</span>medany<span class="w"> </span>-ffreestanding<span class="w"> </span>-fno-common<span class="w"> </span>-nostdlib<span class="w"> </span>-mno-relax<span class="w"> </span>-Ios<span class="w"> </span>-std<span class="o">=</span>gnu17<span class="w"> </span>-fno-stack-protector<span class="w"> </span>-D<span class="w"> </span>LOG_LEVEL_ERROR<span class="w"> </span>-c<span class="w"> </span>os/main.c<span class="w"> </span>-o<span class="w"> </span>build/os/main.o
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>riscv64-unknown-elf-gcc<span class="w"> </span>-fPIE<span class="w"> </span>-fno-pic<span class="w"> </span>-fno-plt<span class="w"> </span>-Wall<span class="w"> </span>-Wno-unused-variable<span class="w"> </span>-Werror<span class="w"> </span>-O<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>-ggdb<span class="w"> </span>-march<span class="o">=</span>rv64g<span class="w"> </span>-MD<span class="w"> </span>-mcmodel<span class="o">=</span>medany<span class="w"> </span>-ffreestanding<span class="w"> </span>-fno-common<span class="w"> </span>-nostdlib<span class="w"> </span>-mno-relax<span class="w"> </span>-Ios<span class="w"> </span>-std<span class="o">=</span>gnu17<span class="w"> </span>-fno-stack-protector<span class="w"> </span>-D<span class="w"> </span>LOG_LEVEL_ERROR<span class="w"> </span>-c<span class="w"> </span>os/printf.c<span class="w"> </span>-o<span class="w"> </span>build/os/printf.o
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>riscv64-unknown-elf-gcc<span class="w"> </span>-fPIE<span class="w"> </span>-fno-pic<span class="w"> </span>-fno-plt<span class="w"> </span>-Wall<span class="w"> </span>-Wno-unused-variable<span class="w"> </span>-Werror<span class="w"> </span>-O<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>-ggdb<span class="w"> </span>-march<span class="o">=</span>rv64g<span class="w"> </span>-MD<span class="w"> </span>-mcmodel<span class="o">=</span>medany<span class="w"> </span>-ffreestanding<span class="w"> </span>-fno-common<span class="w"> </span>-nostdlib<span class="w"> </span>-mno-relax<span class="w"> </span>-Ios<span class="w"> </span>-std<span class="o">=</span>gnu17<span class="w"> </span>-fno-stack-protector<span class="w"> </span>-D<span class="w"> </span>LOG_LEVEL_ERROR<span class="w"> </span>-c<span class="w"> </span>os/sbi.c<span class="w"> </span>-o<span class="w"> </span>build/os/sbi.o
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>riscv64-unknown-elf-gcc<span class="w"> </span>-fPIE<span class="w"> </span>-fno-pic<span class="w"> </span>-fno-plt<span class="w"> </span>-Wall<span class="w"> </span>-Wno-unused-variable<span class="w"> </span>-Werror<span class="w"> </span>-O<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>-ggdb<span class="w"> </span>-march<span class="o">=</span>rv64g<span class="w"> </span>-MD<span class="w"> </span>-mcmodel<span class="o">=</span>medany<span class="w"> </span>-ffreestanding<span class="w"> </span>-fno-common<span class="w"> </span>-nostdlib<span class="w"> </span>-mno-relax<span class="w"> </span>-Ios<span class="w"> </span>-std<span class="o">=</span>gnu17<span class="w"> </span>-fno-stack-protector<span class="w"> </span>-D<span class="w"> </span>LOG_LEVEL_ERROR<span class="w"> </span>-c<span class="w"> </span>os/string.c<span class="w"> </span>-o<span class="w"> </span>build/os/string.o
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>riscv64-unknown-elf-gcc<span class="w"> </span>-fPIE<span class="w"> </span>-fno-pic<span class="w"> </span>-fno-plt<span class="w"> </span>-Wall<span class="w"> </span>-Wno-unused-variable<span class="w"> </span>-Werror<span class="w"> </span>-O<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>-ggdb<span class="w"> </span>-march<span class="o">=</span>rv64g<span class="w"> </span>-MD<span class="w"> </span>-mcmodel<span class="o">=</span>medany<span class="w"> </span>-ffreestanding<span class="w"> </span>-fno-common<span class="w"> </span>-nostdlib<span class="w"> </span>-mno-relax<span class="w"> </span>-Ios<span class="w"> </span>-std<span class="o">=</span>gnu17<span class="w"> </span>-fno-stack-protector<span class="w"> </span>-D<span class="w"> </span>LOG_LEVEL_ERROR<span class="w"> </span>-c<span class="w"> </span>os/entry.S<span class="w"> </span>-o<span class="w"> </span>build/os/entry.o
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>riscv64-unknown-elf-ld<span class="w"> </span>-z<span class="w"> </span>max-page-size<span class="o">=</span><span class="m">4096</span><span class="w"> </span>-T<span class="w"> </span>os/kernel.ld<span class="w"> </span>-o<span class="w"> </span>build/kernel<span class="w"> </span>build/os/console.o<span class="w"> </span>build/os/main.o<span class="w"> </span>build/os/printf.o<span class="w"> </span>build/os/sbi.o<span class="w"> </span>build/os/string.o<span class="w"> </span>build/os/entry.o
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>riscv64-unknown-elf-objdump<span class="w"> </span>-S<span class="w"> </span>build/kernel<span class="w"> </span>&gt;<span class="w"> </span>build/kernel.asm
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>riscv64-unknown-elf-objdump<span class="w"> </span>-t<span class="w"> </span>build/kernel<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;1,/SYMBOL TABLE/d; s/ .* / /; /^$/d&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>build/kernel.sym
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>Build<span class="w"> </span>kernel<span class="w"> </span><span class="k">done</span>
</code></pre></div>
<p>Let’s break down the compilation parameters:</p>
<p><code>gcc</code> is the familiar C compiler, while <code>riscv64-unknown-elf-gcc</code> specifies a GCC suite for RISC-V 64-bit, targeting an unknown platform and producing ELF-format output.</p>
<p>Key compilation flags:</p>
<ul>
<li><code>-march=rv64g -mcmodel=medany -mno-relax</code>:  </li>
</ul>
<p>Targets the <code>rv64g</code> architecture, uses the <code>medany</code> addressing model, and disables linker relaxation.  </p>
<p>See: <a href="https://gcc.gnu.org/onlinedocs/gcc/RISC-V-Options.html">https://gcc.gnu.org/onlinedocs/gcc/RISC-V-Options.html</a></p>
<ul>
<li><code>-ffreestanding -fno-common -nostdlib</code>:  </li>
</ul>
<p>Indicates no reliance on standard library functions and avoids assuming standard definitions for common functions (e.g., <code>memset</code>).</p>
<ul>
<li>
<p><code>-fno-pie -no-pie -fno-plt -fno-omit-frame-pointer -fno-stack-protector</code>:  </p>
<p>This indicates that the generated ELF file should not use Position-Independent Executable (PIE) code, as it would result in the creation of the Global Offset Table (GOT) and Procedure Linkage Table (PLT) sections. Our kernel is currently unable to handle such complex structures.<br />
<code>-fno-omit-frame-pointer -fno-stack-protector</code> means retaining the frame-pointer and disabling stack protection.</p>
</li>
<li>
<p><code>-Wall -Wno-unused-variable -Werror -ggdb</code>: </p>
</li>
</ul>
<p>Enables all warnings except for unused variables, treats warnings as errors, and includes GDB debugging info.</p>
<ul>
<li><code>-Ios -std=gnu17 -O2 -c os/entry.S -o build/os/entry.o</code>:  </li>
</ul>
<p>Uses the <code>os</code> directory for includes, adheres to the GNU17 C standard, enables O2 optimization</p>
<p>compiles (<code>-c</code>) <code>os/entry.S</code> into <code>build/os/entry.o</code>.</p>
<p>The linker (<code>ld</code>) combines all <code>.o</code> files into the final kernel ELF file. </p>
<p><code>riscv64-unknown-elf-ld -z max-page-size=4096 -T os/kernel.ld -o build/kernel build/os/console.o build/os/main.o build/os/printf.o build/os/sbi.o build/os/string.o build/os/entry.o</code></p>
<p>following series of commands indicates:</p>
<ul>
<li><code>-T os/kernel.ld</code>: Specifies <code>os/kernel.ld</code> as the linker script.</li>
<li><code>-o build/kernel</code>: Outputs to <code>build/kernel</code>.</li>
<li>Inputs are all <code>.o</code> files.</li>
</ul>
<h4 id="linker-script">Linker Script<a class="headerlink" href="#linker-script" title="Permanent link">&para;</a></h4>
<p>The <code>kernel.ld</code> linker script dictates how the linker arranges sections from the <code>.o</code> files (Memory Layout) and how the resulting ELF file is loaded into memory (Program Headers).</p>
<div class="admonition info">
<p class="admonition-title">Memory Layout</p>
<p><strong>Memory Layout</strong> refers to the organization and structure of a program’s data and code in memory during execution.</p>
</div>
<p>Here’s the content of <code>kernel.ld</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>OUTPUT_ARCH(riscv)
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>ENTRY(_entry)
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>BASE_ADDRESS = 0x80200000;
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>SECTIONS
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>{
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    . = BASE_ADDRESS;
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    skernel = .;
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    s_text = .;
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    .text : {
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        *(.text.entry)
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        *(.text .text.*)
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        . = ALIGN(4K);
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        e_text = .;
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    }
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    . = ALIGN(4K);
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    s_rodata = .;
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>    .rodata : {
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        *(.rodata .rodata.*)
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    }
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>    . = ALIGN(4K);
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>    e_rodata = .;
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>    s_data = .;
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>    .data : {
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>        *(.data.apps)
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        *(.data .data.*)
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>    }
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>    . = ALIGN(4K);
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>    e_data = .;
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>    .bss : {
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        *(.bss.stack)
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>        s_bss = .;
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>        *(.bss .bss.*)
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>    }
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>    . = ALIGN(4K);
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>    e_bss = .;
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>    ekernel = .;
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>    /DISCARD/ : {
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>        *(.eh_frame)
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>    }
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>}
</code></pre></div>
<p>The <code>OUTPUT_ARCH</code> at the beginning specifies that the generated ELF file is compatible with the RISC-V architecture, and <code>ENTRY</code> indicates that the entry point of the ELF file is the symbol <code>_entry</code>. Then, we define a constant <code>BASE_ADDRESS</code> and set it equal to <code>0x80200000</code>, which is also the starting address of our kernel.</p>
<p>In the <code>SECTIONS</code> block, we first define the current address (represented by the <code>.</code> symbol) (imagine the linker is assigning locations to all sections starting from a certain address) as <code>0x80200000</code>, and export the values of the symbols <code>skernel</code> and <code>s_text</code> as the current address.</p>
<p>Subsequently, we define the <code>.text</code> section, which typically represents the code segment:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>.text : {
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    *(.text.entry)
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    *(.text .text.*)
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    . = ALIGN(4K);
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    e_text = .;
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>}
</code></pre></div>
<p>Places <code>.text.entry</code> first (defined in <code>entry.S</code>), followed by other <code>.text</code> sections.</p>
<p>The <code>.text.entry</code> section is defined in <code>entry.S</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>    .section .text.entry
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    .globl _entry
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>_entry:
</code></pre></div>
<p>By placing <code>_entry</code> in <code>.text.entry</code> and prioritizing it in the linker script, <strong>we ensure <code>_entry</code> is at the kernel’s starting address, <code>0x80200000</code>, where execution begins</strong>.</p>
<p>Verify this via disassembly:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>$ llvm-objdump-19 -d build/kernel | less
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>build/kernel:   file format elf64-littleriscv
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>Disassembly of section .text:
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>0000000080200000 &lt;skernel&gt;:
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>80200000: 00007117      auipc   sp, 0x7
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>80200004: 00010113      mv      sp, sp
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>80200008: 00000097      auipc   ra, 0x0
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>8020000c: 174080e7      jalr    0x174(ra) &lt;main&gt;
</code></pre></div>
<p>Then, we align the current address to a 4K boundary and export the <code>e_text</code> symbol.</p>
<p>Remaining sections:</p>
<ul>
<li><code>.rodata</code>: Read-only data.</li>
<li><code>.data</code>: Read-write data.</li>
<li><code>.bss</code>: Data initialized to zero at startup.</li>
</ul>
<p>All data sections are non-executable. </p>
<p>Here’s a diagram of the kernel image’s memory layout:</p>
<p><img alt="image" src="../../assets/xv6lab-baremetal/kernel-layout.png" /></p>
<p>Finally, inspect the ELF file with <code>readelf</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$<span class="w"> </span>/d/o/SUSTech-OS-2025<span class="w"> </span><span class="o">(</span>xv6-lab1<span class="o">)</span>&gt;<span class="w"> </span>llvm-readelf-19<span class="w"> </span>-a<span class="w"> </span>build/kernel
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>ELF<span class="w"> </span>Header:
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">  </span>Magic:<span class="w">   </span>7f<span class="w"> </span><span class="m">45</span><span class="w"> </span>4c<span class="w"> </span><span class="m">46</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span>Class:<span class="w">                             </span>ELF64
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">  </span>Data:<span class="w">                              </span><span class="m">2</span><span class="err">&#39;</span>s<span class="w"> </span>complement,<span class="w"> </span>little<span class="w"> </span>endian
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">  </span>Version:<span class="w">                           </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>current<span class="o">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">  </span>OS/ABI:<span class="w">                            </span>UNIX<span class="w"> </span>-<span class="w"> </span>System<span class="w"> </span>V
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">  </span>ABI<span class="w"> </span>Version:<span class="w">                       </span><span class="m">0</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">  </span>Type:<span class="w">                              </span>EXEC<span class="w"> </span><span class="o">(</span>Executable<span class="w"> </span>file<span class="o">)</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">  </span>Machine:<span class="w">                           </span>RISC-V
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">  </span>Version:<span class="w">                           </span>0x1
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">  </span>Entry<span class="w"> </span>point<span class="w"> </span>address:<span class="w">               </span>0x80200000
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">  </span>Start<span class="w"> </span>of<span class="w"> </span>program<span class="w"> </span>headers:<span class="w">          </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>bytes<span class="w"> </span>into<span class="w"> </span>file<span class="o">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">  </span>Start<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>headers:<span class="w">          </span><span class="m">29208</span><span class="w"> </span><span class="o">(</span>bytes<span class="w"> </span>into<span class="w"> </span>file<span class="o">)</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">  </span>Flags:<span class="w">                             </span>0x4,<span class="w"> </span>double-float<span class="w"> </span>ABI
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">  </span>Size<span class="w"> </span>of<span class="w"> </span>this<span class="w"> </span>header:<span class="w">               </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">  </span>Size<span class="w"> </span>of<span class="w"> </span>program<span class="w"> </span>headers:<span class="w">           </span><span class="m">56</span><span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">  </span>Number<span class="w"> </span>of<span class="w"> </span>program<span class="w"> </span>headers:<span class="w">         </span><span class="m">4</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">  </span>Size<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>headers:<span class="w">           </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">  </span>Number<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>headers:<span class="w">         </span><span class="m">19</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">  </span>Section<span class="w"> </span>header<span class="w"> </span>string<span class="w"> </span>table<span class="w"> </span>index:<span class="w"> </span><span class="m">18</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>There<span class="w"> </span>are<span class="w"> </span><span class="m">19</span><span class="w"> </span>section<span class="w"> </span>headers,<span class="w"> </span>starting<span class="w"> </span>at<span class="w"> </span>offset<span class="w"> </span>0x7218:
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>Section<span class="w"> </span>Headers:
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">  </span><span class="o">[</span>Nr<span class="o">]</span><span class="w"> </span>Name<span class="w">              </span>Type<span class="w">            </span>Address<span class="w">          </span>Off<span class="w">    </span>Size<span class="w">   </span>ES<span class="w"> </span>Flg<span class="w"> </span>Lk<span class="w"> </span>Inf<span class="w"> </span>Al
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">0</span><span class="o">]</span><span class="w">                   </span>NULL<span class="w">            </span><span class="m">0000000000000000</span><span class="w"> </span><span class="m">000000</span><span class="w"> </span><span class="m">000000</span><span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">0</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span>.text<span class="w">             </span>PROGBITS<span class="w">        </span><span class="m">0000000080200000</span><span class="w"> </span><span class="m">001000</span><span class="w"> </span><span class="m">001000</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>AX<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">4</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>.rodata<span class="w">           </span>PROGBITS<span class="w">        </span><span class="m">0000000080201000</span><span class="w"> </span><span class="m">002000</span><span class="w"> </span>0001f0<span class="w"> </span><span class="m">00</span><span class="w">   </span>A<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">8</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">3</span><span class="o">]</span><span class="w"> </span>.data<span class="w">             </span>PROGBITS<span class="w">        </span><span class="m">0000000080202000</span><span class="w"> </span><span class="m">003000</span><span class="w"> </span><span class="m">000008</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>WA<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">8</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">4</span><span class="o">]</span><span class="w"> </span>.bss<span class="w">              </span>NOBITS<span class="w">          </span><span class="m">0000000080203000</span><span class="w"> </span><span class="m">003008</span><span class="w"> </span><span class="m">004000</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>WA<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">5</span><span class="o">]</span><span class="w"> </span>.debug_info<span class="w">       </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span><span class="m">003008</span><span class="w"> </span>0010c0<span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">6</span><span class="o">]</span><span class="w"> </span>.debug_abbrev<span class="w">     </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span>0040c8<span class="w"> </span>0006e5<span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">7</span><span class="o">]</span><span class="w"> </span>.debug_loclists<span class="w">   </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span>0047ad<span class="w"> </span>0004b5<span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">8</span><span class="o">]</span><span class="w"> </span>.debug_aranges<span class="w">    </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span>004c70<span class="w"> </span><span class="m">000130</span><span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w"> </span><span class="m">16</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">9</span><span class="o">]</span><span class="w"> </span>.debug_line<span class="w">       </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span>004da0<span class="w"> </span>000fe7<span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">  </span><span class="o">[</span><span class="m">10</span><span class="o">]</span><span class="w"> </span>.debug_str<span class="w">        </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span>005d87<span class="w"> </span>0003bc<span class="w"> </span><span class="m">01</span><span class="w">  </span>MS<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">  </span><span class="o">[</span><span class="m">11</span><span class="o">]</span><span class="w"> </span>.debug_line_str<span class="w">   </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span><span class="m">006143</span><span class="w"> </span>0000d3<span class="w"> </span><span class="m">01</span><span class="w">  </span>MS<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="w">  </span><span class="o">[</span><span class="m">12</span><span class="o">]</span><span class="w"> </span>.comment<span class="w">          </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span><span class="m">006216</span><span class="w"> </span>00001a<span class="w"> </span><span class="m">01</span><span class="w">  </span>MS<span class="w">  </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="w">  </span><span class="o">[</span><span class="m">13</span><span class="o">]</span><span class="w"> </span>.riscv.attributes<span class="w"> </span>RISCV_ATTRIBUTES<span class="w"> </span><span class="m">0000000000000000</span><span class="w"> </span><span class="m">006230</span><span class="w"> </span><span class="m">000065</span><span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">  </span><span class="o">[</span><span class="m">14</span><span class="o">]</span><span class="w"> </span>.debug_frame<span class="w">      </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span><span class="m">006298</span><span class="w"> </span>0004c8<span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">8</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="w">  </span><span class="o">[</span><span class="m">15</span><span class="o">]</span><span class="w"> </span>.debug_rnglists<span class="w">   </span>PROGBITS<span class="w">        </span><span class="m">0000000000000000</span><span class="w"> </span><span class="m">006760</span><span class="w"> </span>00007f<span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a><span class="w">  </span><span class="o">[</span><span class="m">16</span><span class="o">]</span><span class="w"> </span>.symtab<span class="w">           </span>SYMTAB<span class="w">          </span><span class="m">0000000000000000</span><span class="w"> </span>0067e0<span class="w"> </span>0006f0<span class="w"> </span><span class="m">18</span><span class="w">     </span><span class="m">17</span><span class="w">  </span><span class="m">31</span><span class="w">  </span><span class="m">8</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="w">  </span><span class="o">[</span><span class="m">17</span><span class="o">]</span><span class="w"> </span>.strtab<span class="w">           </span>STRTAB<span class="w">          </span><span class="m">0000000000000000</span><span class="w"> </span>006ed0<span class="w"> </span><span class="m">000279</span><span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a><span class="w">  </span><span class="o">[</span><span class="m">18</span><span class="o">]</span><span class="w"> </span>.shstrtab<span class="w">         </span>STRTAB<span class="w">          </span><span class="m">0000000000000000</span><span class="w"> </span><span class="m">007149</span><span class="w"> </span>0000cc<span class="w"> </span><span class="m">00</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">  </span><span class="m">1</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>Key<span class="w"> </span>to<span class="w"> </span>Flags:
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a><span class="w">  </span>W<span class="w"> </span><span class="o">(</span>write<span class="o">)</span>,<span class="w"> </span>A<span class="w"> </span><span class="o">(</span>alloc<span class="o">)</span>,<span class="w"> </span>X<span class="w"> </span><span class="o">(</span>execute<span class="o">)</span>,<span class="w"> </span>M<span class="w"> </span><span class="o">(</span>merge<span class="o">)</span>,<span class="w"> </span>S<span class="w"> </span><span class="o">(</span>strings<span class="o">)</span>,<span class="w"> </span>I<span class="w"> </span><span class="o">(</span>info<span class="o">)</span>,
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a><span class="w">  </span>L<span class="w"> </span><span class="o">(</span>link<span class="w"> </span>order<span class="o">)</span>,<span class="w"> </span>O<span class="w"> </span><span class="o">(</span>extra<span class="w"> </span>OS<span class="w"> </span>processing<span class="w"> </span>required<span class="o">)</span>,<span class="w"> </span>G<span class="w"> </span><span class="o">(</span>group<span class="o">)</span>,<span class="w"> </span>T<span class="w"> </span><span class="o">(</span>TLS<span class="o">)</span>,
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a><span class="w">  </span>C<span class="w"> </span><span class="o">(</span>compressed<span class="o">)</span>,<span class="w"> </span>x<span class="w"> </span><span class="o">(</span>unknown<span class="o">)</span>,<span class="w"> </span>o<span class="w"> </span><span class="o">(</span>OS<span class="w"> </span>specific<span class="o">)</span>,<span class="w"> </span>E<span class="w"> </span><span class="o">(</span>exclude<span class="o">)</span>,
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a><span class="w">  </span>R<span class="w"> </span><span class="o">(</span>retain<span class="o">)</span>,<span class="w"> </span>p<span class="w"> </span><span class="o">(</span>processor<span class="w"> </span>specific<span class="o">)</span>
<a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>
<a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>Elf<span class="w"> </span>file<span class="w"> </span><span class="nb">type</span><span class="w"> </span>is<span class="w"> </span>EXEC<span class="w"> </span><span class="o">(</span>Executable<span class="w"> </span>file<span class="o">)</span>
<a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>Entry<span class="w"> </span>point<span class="w"> </span>0x80200000
<a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>There<span class="w"> </span>are<span class="w"> </span><span class="m">4</span><span class="w"> </span>program<span class="w"> </span>headers,<span class="w"> </span>starting<span class="w"> </span>at<span class="w"> </span>offset<span class="w"> </span><span class="m">64</span>
<a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>
<a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>Program<span class="w"> </span>Headers:
<a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a><span class="w">  </span>Type<span class="w">           </span>Offset<span class="w">   </span>VirtAddr<span class="w">           </span>PhysAddr<span class="w">           </span>FileSiz<span class="w">  </span>MemSiz<span class="w">   </span>Flg<span class="w"> </span>Align
<a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a><span class="w">  </span>ATTRIBUTES<span class="w">     </span>0x006230<span class="w"> </span>0x0000000000000000<span class="w"> </span>0x0000000000000000<span class="w"> </span>0x000065<span class="w"> </span>0x000000<span class="w"> </span>R<span class="w">   </span>0x1
<a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a><span class="w">  </span>LOAD<span class="w">           </span>0x001000<span class="w"> </span>0x0000000080200000<span class="w"> </span>0x0000000080200000<span class="w"> </span>0x0011f0<span class="w"> </span>0x0011f0<span class="w"> </span>R<span class="w"> </span>E<span class="w"> </span>0x1000
<a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a><span class="w">  </span>LOAD<span class="w">           </span>0x003000<span class="w"> </span>0x0000000080202000<span class="w"> </span>0x0000000080202000<span class="w"> </span>0x000008<span class="w"> </span>0x005000<span class="w"> </span>RW<span class="w">  </span>0x1000
<a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a><span class="w">  </span>GNU_STACK<span class="w">      </span>0x000000<span class="w"> </span>0x0000000000000000<span class="w"> </span>0x0000000000000000<span class="w"> </span>0x000000<span class="w"> </span>0x000000<span class="w"> </span>RW<span class="w">  </span>0x10
<a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>
<a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a><span class="w"> </span>Section<span class="w"> </span>to<span class="w"> </span>Segment<span class="w"> </span>mapping:
<a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a><span class="w">  </span>Segment<span class="w"> </span>Sections...
<a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a><span class="w">   </span><span class="m">00</span><span class="w">     </span>.riscv.attributes<span class="w"> </span>
<a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a><span class="w">   </span><span class="m">01</span><span class="w">     </span>.text<span class="w"> </span>.rodata<span class="w"> </span>
<a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a><span class="w">   </span><span class="m">02</span><span class="w">     </span>.data<span class="w"> </span>.bss<span class="w"> </span>
<a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a><span class="w">   </span><span class="m">03</span><span class="w">     </span>
<a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a><span class="w">   </span>None<span class="w">   </span>.debug_info<span class="w"> </span>.debug_abbrev<span class="w"> </span>.debug_loclists<span class="w"> </span>.debug_aranges<span class="w"> </span>.debug_line<span class="w"> </span>.debug_str<span class="w"> </span>.debug_line_str<span class="w"> </span>.comment<span class="w"> </span>.debug_frame<span class="w"> </span>.debug_rnglists<span class="w"> </span>.symtab<span class="w"> </span>.strtab<span class="w"> </span>.shstrtab
</code></pre></div>
<ul>
<li>The final file type is: <code>Type: EXEC (Executable file)</code>  </li>
<li>The entry point address is: <code>Entry point address: 0x80200000</code>  </li>
<li>There are a total of 19 Sections:  <ul>
<li>Each Section has its own Flags, where <code>A</code> indicates that this Section should be allocated memory space during loading, <code>W</code> indicates it is writable, and <code>X</code> indicates it is executable.  </li>
</ul>
</li>
<li>There are a total of 4 Program Headers, two of which are LOAD:  <ul>
<li>The first LOAD indicates:  <ul>
<li>At virtual address (VirtAddr) <code>0x80200000</code>, it maps to physical address (PhysAddr) <code>0x80200000</code>, allocating a memory space of <code>0x0011d0</code> bytes (MemSiz). This memory segment has the permission <code>RE</code> (Read &amp; Executable).  </li>
<li>It copies <code>0x0011d0</code> bytes (FileSiz) from the ELF file's offset <code>0x001000</code> to the above memory space.  </li>
</ul>
</li>
<li>The second LOAD indicates:  <ul>
<li>At virtual address <code>0x80202000</code>, it maps to physical address <code>0x80202000</code>, allocating a memory space of <code>0x005000</code> bytes. This memory segment has the permission <code>RW</code> (Read &amp; Write).  </li>
<li>It copies <code>0x0008</code> bytes from the ELF file's offset <code>0x3000</code> to this memory segment. However, the memory segment allocates <code>0x5000</code> bytes of space, <strong>indicating that the remaining unfilled space is entirely zero, which is the bss segment</strong>.  </li>
</ul>
</li>
</ul>
</li>
<li>In the <code>Section to Segment mapping:</code> section, we can see:  <ul>
<li>The first Program Header includes the <code>.text</code> and <code>.rodata</code> Sections.  </li>
<li>The second Program Header includes the <code>.data</code> and <code>.bss</code> segments.</li>
</ul>
</li>
</ul>
<p>Continue Kernel Execution</p>
<p>The first few instructions executed:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>80200000: 00007117      auipc   sp, 0x7
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>80200004: 00010113      mv      sp, sp
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>80200008: 00000097      auipc   ra, 0x0
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>8020000c: 174080e7      jalr    0x174(ra) &lt;main&gt;
</code></pre></div>
<p>Source code (<code>entry.S</code>):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="w">    </span><span class="na">.section</span><span class="w"> </span><span class="no">.text.entry</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">_entry</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="nl">_entry:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="nf">lla</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">boot_stack_top</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">main</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="na">.section</span><span class="w"> </span><span class="no">.bss.stack</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">boot_stack</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="nl">boot_stack:</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="na">.space</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="mi">4</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">boot_stack_top</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="nl">boot_stack_top:</span>
</code></pre></div>
<p>In this segment of code:</p>
<ul>
<li>We utilize the <code>auipc</code> and <code>addi</code> instructions to direct the stack pointer towards <code>boot_stack_top</code>, a stack we have pre-allocated for the initial kernel entry.</li>
<li>Through the <code>auipc</code> and <code>jalr</code> instructions, we execute a jump to the main function to continue the program's execution.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Why Use Assembly for Kernel Entry?</p>
<p>At the kernel entry, OpenSBI does not set the stack pointer (<code>sp</code>). Since C requires a stack for local variables and function calls, we use assembly to initialize <code>sp</code>.</p>
</div>
<p>The kernel then jumps to <code>main</code> in <code>main.c</code>:</p>
<p>observe main function in file main.c</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;clean bss: %p - %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s_bss</span><span class="p">,</span><span class="w"> </span><span class="n">e_bss</span><span class="p">);</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">s_bss</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">e_bss</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s_bss</span><span class="p">);</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel booted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello World!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;sysregs:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="n">print_sysregs</span><span class="p">();</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">global_variable</span><span class="p">);</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;kernel ends, parking...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="p">}</span>
</code></pre></div>
<ul>
<li>Clears the <code>.bss</code> section (normally done by the Linux kernel, but we’re the kernel now).</li>
<li>Prints messages and enters an infinite loop.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>clean bss: 0x0000000080207000 - 0x0000000080207000
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>Kernel booted.
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>Hello World!
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Lab Report 3</p>
<p>Attempt to read the <code>mvendorid</code> CSR.  </p>
<p>In <code>main.c</code>, add before the <code>while(1);</code> loop:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">uint64</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;csrr %0, mvendorid&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;csr: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
</code></pre></div>
<p>Compile and run with <code>make run</code>. Can your program read the <code>mvendorid</code> CSR value?  </p>
<p>Refer to the RISC-V Privileged Manual (riscv-privileged.pdf), Sections 2.1 (CSR Address Mapping Conventions) and 2.2 (CSR Listing), and explain why your program might restart infinitely.</p>
</div>
<h4 id="sbi-call">SBI Call<a class="headerlink" href="#sbi-call" title="Permanent link">&para;</a></h4>
<p>In this lab’s kernel, <code>printf</code> calls <code>consputc</code> to print characters to the console, which ultimately invokes <code>sbi_call(SBI_CONSOLE_PUTCHAR, c, 0, 0)</code>.</p>
<p>To access hardware functions (e.g., <code>sbi_console_putchar</code> and <code>sbi_console_getchar</code>), we set registers like <code>a0</code> and <code>a1</code>, then use the <code>ecall</code> instruction to request service from OpenSBI in <strong>M mode</strong>. OpenSBI processes the request and returns.</p>
<div class="admonition info">
<p class="admonition-title">Inline Assembly</p>
<p><strong>ecall</strong> (environment call): When we execute this instruction in S-mode, it triggers an <code>ecall-from-s-mode-exception</code>, entering the interrupt handling process in M-mode (e.g., setting a timer, etc.); when we execute this instruction in U-mode, it triggers an <code>ecall-from-u-mode-exception</code>, entering the interrupt handling process in S-mode (commonly used for system calls).</p>
<p>Note that C language cannot directly invoke <code>ecall</code>; it needs to be implemented using inline assembly.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Calling Convention</p>
<p>A <strong>Calling Convention</strong> defines the rules for function calls between the caller and callee.</p>
<p>including:  </p>
<ol>
<li>How parameters and return values are passed.  </li>
<li>Which registers the caller and callee must preserve.</li>
</ol>
</div>
<p>SBI’s calling convention (riscv-sbi.pdf):  </p>
<p>All SBI functions share a single binary encoding, which facilitates the mixing of SBI extensions. The SBI specification follows the below calling convention.</p>
<ul>
<li>An ECALL is used as the control transfer instruction between the supervisor and the SEE.</li>
<li>a7 encodes the SBI extension ID (EID),</li>
<li>a6 encodes the SBI function ID (FID) for a given extension ID encoded in a7 for any SBI extension defined in or after SBI v0.2.</li>
<li>All registers except a0 &amp; a1 must be preserved across an SBI call by the callee.</li>
<li>SBI functions must return a pair of values in a0 and a1, with a0 returning an error code. </li>
</ul>
<p>For legacy extensions (e.g., <code>putchar</code>/<code>getchar</code>):  </p>
<ul>
<li>Nothing is returned in a1 register.</li>
<li>All registers except a0 must be preserved across an SBI call by the callee.</li>
<li>The value returned in a0 register is SBI legacy extension specific.</li>
</ul>
<p>According to the RISC-V Calling Convention, parameters are passed through the <code>a</code> series of registers, starting from <code>a0</code>.  </p>
<p>In the <code>sbi_call_legacy</code> function, we first declare four variables and specify that they should be directly assigned to the corresponding registers (<code>register</code>, <code>asm("a0")</code>).  </p>
<p>Next, we assign the value of <code>a7</code> to indicate which SBI function we want to call, and assign the three parameters to <code>a0</code>, <code>a1</code>, and <code>a2</code> respectively.  </p>
<p>Then, we use <code>asm volatile</code> to perform the <code>ecall</code> instruction.  </p>
<p>Finally, we return the value of the <code>a0</code> register.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">const</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">SBI_CONSOLE_PUTCHAR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="k">const</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">SBI_CONSOLE_GETCHAR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">sbi_call_legacy</span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">which</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">arg0</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">arg2</span><span class="p">)</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="p">{</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="k">register</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;a0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg0</span><span class="p">;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="k">register</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;a1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg1</span><span class="p">;</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="k">register</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;a2&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg2</span><span class="p">;</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="k">register</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">a7</span><span class="w"> </span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;a7&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">which</span><span class="p">;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ecall&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a2</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a7</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">);</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a0</span><span class="p">;</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="p">}</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="kt">void</span><span class="w"> </span><span class="n">console_putchar</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="n">sbi_call_legacy</span><span class="p">(</span><span class="n">SBI_CONSOLE_PUTCHAR</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="p">}</span>
</code></pre></div>
<p><code>asm volatile</code> is used to directly insert assembly code (inline assembly) into C code. It consists of four parts:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>asm asm-qualifiers ( AssemblerTemplate 
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>                 : OutputOperands 
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>                 [ : InputOperands
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>                 [ : Clobbers ] ])
</code></pre></div>
<p>We use <code>volatile</code> as an asm-qualifier to indicate that the compiler should not perform any potential optimizations on this segment of code.  </p>
<p><code>AssemblerTemplate</code> represents the template of the assembly code.  <code>OutputOperands</code> specifies which C variables should be treated as the output of this assembly segment.  <code>InputOperands</code> specifies which C variables should be treated as the input of this assembly segment.  <code>Clobbers</code> indicates which registers or system states will be modified by this assembly code.</p>
<ul>
<li>See: <a href="https://gcc.gnu.org/onlinedocs/gcc-12.1.0/gcc/Extended-Asm.html">https://gcc.gnu.org/onlinedocs/gcc-12.1.0/gcc/Extended-Asm.html</a></li>
</ul>
<div class="admonition question">
<p class="admonition-title">Lab Report 4</p>
<p>Call the newer SBI function <code>sbi_get_spec_version()</code>.  </p>
<p>In <code>main.c</code>, add before the <code>while(1);</code> loop:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sbiret</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbi_call</span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;sbicall: err: %d, ret: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
</code></pre></div>
<p>Refer to the SBI manual (riscv-sbi.pdf) to fill in the <code>?</code> values. Compile and run with <code>make run</code>, then explain the output values.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-copyright">
    <div class="md-copyright__highlight">
        commit: 
        <a href="https://github.com/yuk1i/os-next-docs/commit/deb8ddac, 2025-03-04 13:14:52+08:00" target="_blank" rel="noopener">
            deb8ddac, 2025-03-04 13:14:52+08:00
        </a>
    </div>
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>