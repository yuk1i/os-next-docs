
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../xv6lab-contextswitch/">
      
      
        <link rel="next" href="../xv6lab-userspace/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Week 6 - Kernel Paging - 操作系统实验文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#risc-v-page-table-model-xv6-kernel-page-tables" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-header__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            操作系统实验文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Week 6 - Kernel Paging
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../env/" class="md-tabs__link">
          
  
  实验环境搭建

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../lab/lab1/" class="md-tabs__link">
          
  
  每周实验

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab2/" class="md-tabs__link">
          
  
  Weekly Lab Material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qrh/nav/" class="md-tabs__link">
          
  
  快速参考手册

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-nav__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    操作系统实验文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    实验环境搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            实验环境搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux VM 搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Linux VM 搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/windows-vmware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + VMware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/wsl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + WSL (不推荐)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS + VMware
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    手动环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    验证环境
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    每周实验
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            每周实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 1 - Linux基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C 语言基础及Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - 裸机程序 Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - 上下文切换 Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - 内核页表 Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - 用户空间 Userspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-userprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 8 - 进程 Process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-pagefault/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 9 - 缺页异常 Page Fault
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 10 - 互斥与同步 Mutual Exclusion & Synchronization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 11 - CPU调度 CPU Scheduling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-sync2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 12 - 同步 2 Synchronization 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-sync3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 13 - 同步 3 & VFS Synchronization 3 & VFS
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Weekly Lab Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Weekly Lab Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C language basic & Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - Trap & Interrupt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Week 6 - Kernel Paging
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Week 6 - Kernel Paging
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#experiment-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      Segmentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paging" class="md-nav__link">
    <span class="md-ellipsis">
      Paging
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#virtual-address-physical-address" class="md-nav__link">
    <span class="md-ellipsis">
      Virtual Address =&gt; Physical Address
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Virtual Address => Physical Address">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-level-page-table" class="md-nav__link">
    <span class="md-ellipsis">
      Single-Level Page Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-level-page-table" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Level Page Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#translation-lookaside-buffer-tlb" class="md-nav__link">
    <span class="md-ellipsis">
      Translation Lookaside Buffer (TLB)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v-sv39-paging-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V Sv39 Paging Mechanism
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RISC-V Sv39 Paging Mechanism">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#satp" class="md-nav__link">
    <span class="md-ellipsis">
      satp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sv39" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flags" class="md-nav__link">
    <span class="md-ellipsis">
      Flags
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flags">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-d" class="md-nav__link">
    <span class="md-ellipsis">
      A &amp; D
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#permission-checks" class="md-nav__link">
    <span class="md-ellipsis">
      Permission Checks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#huge-page-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      Huge Page Mapping
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-classroom-report" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Classroom Report
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experiment-scenario" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Scenario
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v-physical-address-layout" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V Physical Address Layout
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6-kernel-memory-layout" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 Kernel Memory Layout
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relocation" class="md-nav__link">
    <span class="md-ellipsis">
      Relocation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Relocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#relocation_start-code-explanation" class="md-nav__link">
    <span class="md-ellipsis">
      relocation_start Code Explanation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-page-table" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel Page Table
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kernel Page Table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kvmmap" class="md-nav__link">
    <span class="md-ellipsis">
      kvmmap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kalloc-module" class="md-nav__link">
    <span class="md-ellipsis">
      kalloc Module
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experiment-reflection-questions" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Reflection Questions
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - Userspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 8 - User Process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-pagefault/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 9 - Page Fault
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 10 - Mutual Exclusion & Synchronization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 11 - CPU Scheduling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-sync2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 12 - Synchronization 2
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    快速参考手册
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            快速参考手册
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/nav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/vf2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VisionFive2 板子教程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/ssh-vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH & VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#experiment-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      Segmentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paging" class="md-nav__link">
    <span class="md-ellipsis">
      Paging
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#virtual-address-physical-address" class="md-nav__link">
    <span class="md-ellipsis">
      Virtual Address =&gt; Physical Address
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Virtual Address => Physical Address">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-level-page-table" class="md-nav__link">
    <span class="md-ellipsis">
      Single-Level Page Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-level-page-table" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Level Page Table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#translation-lookaside-buffer-tlb" class="md-nav__link">
    <span class="md-ellipsis">
      Translation Lookaside Buffer (TLB)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v-sv39-paging-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V Sv39 Paging Mechanism
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RISC-V Sv39 Paging Mechanism">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#satp" class="md-nav__link">
    <span class="md-ellipsis">
      satp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sv39" class="md-nav__link">
    <span class="md-ellipsis">
      Sv39
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flags" class="md-nav__link">
    <span class="md-ellipsis">
      Flags
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flags">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-d" class="md-nav__link">
    <span class="md-ellipsis">
      A &amp; D
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#permission-checks" class="md-nav__link">
    <span class="md-ellipsis">
      Permission Checks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#huge-page-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      Huge Page Mapping
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-classroom-report" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Classroom Report
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experiment-scenario" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Scenario
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v-physical-address-layout" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V Physical Address Layout
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6-kernel-memory-layout" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 Kernel Memory Layout
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relocation" class="md-nav__link">
    <span class="md-ellipsis">
      Relocation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Relocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#relocation_start-code-explanation" class="md-nav__link">
    <span class="md-ellipsis">
      relocation_start Code Explanation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-page-table" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel Page Table
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kernel Page Table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kvmmap" class="md-nav__link">
    <span class="md-ellipsis">
      kvmmap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kalloc-module" class="md-nav__link">
    <span class="md-ellipsis">
      kalloc Module
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experiment-reflection-questions" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Reflection Questions
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="risc-v-page-table-model-xv6-kernel-page-tables">RISC-V Page Table Model &amp; xv6 Kernel Page Tables<a class="headerlink" href="#risc-v-page-table-model-xv6-kernel-page-tables" title="Permanent link">&para;</a></h1>
<h2 id="experiment-objectives">Experiment Objectives<a class="headerlink" href="#experiment-objectives" title="Permanent link">&para;</a></h2>
<ol>
<li>Understand the RISC-V SV39 page table model.</li>
<li>Master the mechanism of virtual address to physical address translation.</li>
<li>Understand how XV6 manages memory and creates page tables.</li>
</ol>
<h2 id="segmentation">Segmentation<a class="headerlink" href="#segmentation" title="Permanent link">&para;</a></h2>
<p>From the perspective of memory access protection, we desire memory access to be permission-protected. This involves two aspects:</p>
<ol>
<li>Whether the memory address is readable, writable, or executable.</li>
<li>Whether the memory address allows access from lower privilege levels.</li>
</ol>
<p>In other words, for each memory address, we want to verify that its operational permissions align with the original program design.</p>
<p>In CPU implementations, memory is addressed in byte units. Managing access permissions for every single byte would incur an unimaginable cost. 
However, we can group code and data with the same permissions together, dividing the program's memory space into several large segments. Each segment has its own base address (Base), size limit (Limit), and permission settings. This is the approach of using <em>Segmentation</em> for memory protection.</p>
<p>Segmentation has several disadvantages in memory space management, such as requiring contiguous physical memory, difficulty in dynamically resizing, and fragmentation issues. Therefore, modern CPUs and operating systems use the <em>Paging</em> mechanism for memory management.</p>
<h2 id="paging">Paging<a class="headerlink" href="#paging" title="Permanent link">&para;</a></h2>
<p>The paging mechanism divides the program space (virtual address space) into fixed-size pages and similarly splits physical memory into pages of the same size. This allows sufficient memory allocation for a process even when physical addresses are non-contiguous, while appearing contiguous from the virtual address perspective.</p>
<div class="admonition note">
<p class="admonition-title">Why do we need a virtual address space?</p>
<p>If we only had physical memory space, we could still write programs, but all programs—including the kernel and user programs—would operate in the same address space. The address <code>0x80200000</code> accessed by a user program would be the same as <code>0x80200000</code> accessed by the kernel. Is this a problem? If only one program is running, it’s fine. But when multiple programs share the same memory space, issues arise: how do we prevent programs from interfering with or even sabotaging each other?</p>
<p>A straightforward solution is to ensure that <code>0x80200000</code> accessed by a user program and <code>0x80200000</code> accessed by the kernel are not the same address. Since we only have one physical memory, we can introduce a "translation" mechanism to create distinct address spaces: the addresses used by programs (virtual addresses) must be "translated" into actual physical memory addresses. This "translation" process is implemented using a "dictionary" (page table)—given an address before translation, the corresponding translated address can be looked up in the dictionary.</p>
<p>Each program has its own unique "dictionary," and the memory it can use is limited to what’s defined in its dictionary.</p>
<p>Does the "dictionary" translate every usable byte? Imagine that storing the translation result for each byte requires at least one byte. For 1MB of memory, we’d need at least a 1MB "dictionary," which is highly inefficient. In practice, a program’s memory usage is typically orders of magnitude larger than bytes—often in KB units (hence the ancient saying, "640K ought to be enough for anybody," not "640B ought to be enough for anybody"). Thus, we can group many contiguous bytes together for translation, ensuring the difference between pre- and post-translation values is consistent. This is the concept of a "page."</p>
</div>
<h2 id="virtual-address-physical-address">Virtual Address =&gt; Physical Address<a class="headerlink" href="#virtual-address-physical-address" title="Permanent link">&para;</a></h2>
<p>A critical aspect of the paging mechanism is how to establish and resolve the mapping from virtual addresses to physical addresses. Below, we explain this from the perspective of "how to obtain the corresponding physical address from a virtual address":</p>
<h3 id="single-level-page-table">Single-Level Page Table<a class="headerlink" href="#single-level-page-table" title="Permanent link">&para;</a></h3>
<p>The figure below illustrates a single-level page table paging mechanism (single-level refers to requiring only one layer of page table lookup to obtain the physical address, hereafter called a "single-level page table"):</p>
<p><img alt="1648542681894" src="../../assets/xv6lab-paging/1648542681894.png" /></p>
<p>Using the figure as an example, we start with a <strong>virtual address</strong> ( <strong>Virtual Address</strong> ), which is 6 bits long. Bits 5–4 (the top 2 bits) represent the <strong>page number (VPN, Virtual Page Number)</strong>, while bits 3–0 (the bottom 4 bits) represent the <strong>offset (Offset)</strong>.</p>
<p>Using the virtual address, we can query the <strong>page table</strong> ( <strong>Page Table</strong> ), which resides in the memory space pointed to by the <strong>page table base address</strong> ( <strong>PageTablePtr, Page Table Pointer</strong> , a physical address). The page table consists of several consecutively stored <strong>page table entries (PTE, Page Table Entry)</strong>. In a single-level page table, each PTE contains the <strong>physical page number (Page Frame #) + some flag bits</strong>. Although the figure shows each PTE seemingly containing a <strong>page number (Page #)</strong>, in actual designs, <strong>the page number (VPN) is not stored in the PTE</strong>. Since PTEs are stored contiguously, knowing the PTE size (in bits) and the virtual page number (VPN, indicating which PTE to query) allows us to calculate the PTE address as <code>page table base address + page number × PTE size</code>. The content at this address yields the physical page number. The page table base address is stored in an architecture-specified register.</p>
<p>After obtaining the physical page number, the physical address of the page can be calculated as <code>physical page number × page size</code> (assuming the physical space starts at 0x0). A page can be large—how do we get the address of a specific byte within it? Using the offset, the specific physical address corresponding to the virtual address is <code>page physical address + offset</code>.</p>
<div class="admonition note">
<p class="admonition-title">An Example</p>
<p>Suppose the page size is 4KiB. To locate each byte within a page, the offset must represent 4096 distinct positions, requiring 12 bits (2<sup>12</sup> = 4096). Alternatively, if the offset is 12 bits, the page size can be deduced as 2<sup>12</sup> bytes.</p>
<p>In the single-level page table from the figure, the offset is 4 bits, indicating a page size of 2<sup>4</sup> = 16B. Given a virtual address <code>100100</code> (binary), the page number is <code>10</code> (binary, i.e., 2 in decimal). Using page number 2, we look up the PTE content, which is <code>5</code> (binary). The physical page number is 5, and the physical page address is: physical base address + physical page number × page size = 0 + 5 × 16 = 80 (decimal). The offset from the virtual address <code>100100</code> is <code>0100</code> (4 in decimal), querying the 5<sup>th</sup> byte of the page (address 0 counts as one byte). Thus, the physical address is 80 + 4 = 84 (decimal) (5 × 16 + 4 = 0101 shifted left 4 bits + 0100 = 0101 0100 in binary). Pay attention to whether calculations use binary, decimal, or hexadecimal (storage is always binary).</p>
</div>
<h3 id="multi-level-page-table">Multi-Level Page Table<a class="headerlink" href="#multi-level-page-table" title="Permanent link">&para;</a></h3>
<p>In systems, the page size is typically 4KiB. In a 32-bit system with a 32-bit virtual address space (2^32 = 4GiB), a single-level page table would require 1M PTEs to map all physical pages. Assuming each PTE is 4B, the page table size would be 4MiB. Since virtual addresses are contiguous (i.e., high-order VPNs are contiguous) and PTEs are stored consecutively like an array, even if a process uses minimal space, a complete, contiguous page table is needed for address translation (unused intermediate PTEs cannot be omitted). In an OS, beyond the kernel page table, each process gets its own page table, and with many processes, the overhead of storing all page tables becomes significant.</p>
<p>This necessitates multi-level page tables, as shown below in a two-level page table mechanism (Sv32):</p>
<p><img alt="1648548797416" src="../../assets/xv6lab-paging/1648548797416.png" /></p>
<p>Unlike a single-level page table, Sv32 splits the virtual address into three parts: <code>VPN[1], VPN[0], offset</code>. In Sv32, each page is 4KiB, each PTE is 4 bytes, and each page table contains <code>2^10 = 1024</code> PTEs.</p>
<p>The translation process for a 32-bit virtual address in the figure is as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>    1. Use `PageTablePtr + VPN1 * 4` to get the first-level PTE address (`PageTablePtr` is stored in a designated register).
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    2. Retrieve the PFN from the first-level PTE, representing the base address of the second-level page table. Compute the second-level page table base address as `PFN * 4Ki`.
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    3. Use `second-level page table base address + VPN0 * 4` to get the second-level PTE address.
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    4. Retrieve the PFN from the second-level PTE, representing the final physical page. Compute the final physical address as `PFN * 4Ki + offset`.
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Thinking</p>
<p>Why does a multi-level page table save space compared to a single-level page table?</p>
<p>Consider a 4GiB memory space with a 4KiB page size and 4-byte PTEs. If a process only needs one 4KiB page at the high virtual address (0xffff_f000) and one at the low virtual address (0x0000_0000), we can compare the page table space required under single-level and two-level mechanisms.</p>
<p><strong>Single-Level Page Table:</strong>
Despite needing only the 0<sup>th</sup> and last PTEs, a single-level page table requires 4GiB / 4KiB = 1M <strong>contiguous</strong> PTEs to map the entire virtual address space. Thus, the page table size is 1M * 4B = 4MiB.</p>
<p><strong>Multi-Level Page Table:</strong>
In a multi-level mechanism, the address space managed by each lower-level page table increases hierarchically. 
In Sv32, each PTE in the second-level page table manages <code>4KiB</code>, so the entire second-level table manages <code>1024 * 4KiB = 4MiB</code>. Each PTE in the first-level page table manages a second-level page table, meaning each first-level PTE effectively manages <code>4MiB</code>.</p>
<p>For large, contiguous unused regions, we can avoid allocating second-level page tables, which is why multi-level page tables save space.</p>
<p>In this case, we allocate two PTEs in the first-level page table to manage two second-level page tables. In the first second-level table, the 0<sup>th</sup> PTE maps virtual address <code>0x0000_0000</code>. In the second, the 1023<sup>rd</sup> PTE maps <code>0xffff_f000</code>.</p>
<p>Summary:
To manage these two virtual pages, the two-level page table requires 2 second-level tables and 1 first-level table (unused second-level PTEs can be marked invalid without allocation). Since both levels’ page tables are 4KB, the total space is 2 * 4KB + 4KB = 12KB.</p>
<p>This example shows that the hierarchical management of a two-level page table significantly reduces space overhead, especially when mapping sparse memory.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Note</p>
<p>The translation of virtual to physical addresses is performed by the CPU’s Memory Management Unit (MMU) and does not require us to write code for it.</p>
<p>Our task in the OS is to construct the "dictionary"—the page table—by allocating page table space and filling in PTEs.</p>
</div>
<h3 id="translation-lookaside-buffer-tlb">Translation Lookaside Buffer (TLB)<a class="headerlink" href="#translation-lookaside-buffer-tlb" title="Permanent link">&para;</a></h3>
<p>Physical memory access is much slower than CPU execution, often requiring hundreds of clock cycles per access (known as the "von Neumann bottleneck").</p>
<p>Page tables are stored in physical memory. Following the page table mechanism step-by-step, translating a virtual address to a physical one requires 3 physical memory accesses, followed by another to fetch the desired data, significantly reducing efficiency.</p>
<p>Fortunately, virtual address access exhibits <em>temporal locality</em> and <em>spatial locality</em>:</p>
<ul>
<li><em>Temporal locality</em>: An address accessed once is likely to be accessed again soon.</li>
<li><em>Spatial locality</em>: If an address is accessed, nearby addresses are likely to be accessed soon.</li>
</ul>
<p>Thus, CPUs use a <strong>Translation Lookaside Buffer (TLB)</strong> to cache recently completed virtual-to-physical page mappings. Due to locality, a mapping is likely to have been recently performed, so checking the TLB first can bypass multiple memory accesses if the mapping is found.</p>
<p>However, if we modify the root page table register (e.g., changing the PPN field), switching to a completely different page table, the TLB’s cached mappings become outdated and potentially incorrect. In this case, we must use a specific instruction to flush the TLB. In RISC-V, this is <code>sfence.vma</code>.</p>
<p>Similarly, manually modifying a PTE alters the mapping, but the TLB doesn’t automatically refresh. We must explicitly flush it.</p>
<p>In RISC-V, <code>sfence.vma</code> without parameters flushes the entire TLB. With a virtual address parameter, it flushes only that address’s mapping.</p>
<h2 id="risc-v-sv39-paging-mechanism">RISC-V Sv39 Paging Mechanism<a class="headerlink" href="#risc-v-sv39-paging-mechanism" title="Permanent link">&para;</a></h2>
<h3 id="satp">satp<a class="headerlink" href="#satp" title="Permanent link">&para;</a></h3>
<p>The <em>satp</em> (Supervisor Address Translation and Protection) register controls address translation in S-mode and U-mode, with three fields: <code>MODE</code>, <code>ASID</code>, and <code>PPN</code>.</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/satp.png" /></p>
<p><em>Mode</em> specifies the address translation mode. A value of 0 disables translation, treating all requested addresses as physical, while <code>PPN</code> denotes the <strong>root page table’s base address</strong>. In this course, we use <strong>Sv39</strong> as the page table mode.</p>
<p>We can ignore ASID for now.</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/satp-mode.png" /></p>
<h3 id="sv39">Sv39<a class="headerlink" href="#sv39" title="Permanent link">&para;</a></h3>
<p>RISC-V’s Sv39 mode supports a 39-bit virtual address space, with each page being 4KiB and each PTE 8 bytes, meaning each page table has <code>2^9 = 512</code> PTEs. Sv39 requires each page table to be a page-aligned, i.e., its base address aligns to 4KiB.</p>
<p>RISC-V CPUs use 64-bit virtual addresses. In Sv39, only 39 bits are effective, and bits 63–39 must match bit 38 (sign-extension). Otherwise, the virtual address is illegal. Thus, Sv39’s virtual address space totals <code>(1 &lt;&lt; 39) = 512 GiB</code>, split into 256 GiB of low addresses (<code>0x0000_0000_0000_0000</code> - <code>0x0000_003f_xxxx_xxxx</code>) and 256 GiB of high addresses (<code>0xffff_ffc0_0000_0000</code> - <code>0xffff_ffff_xxxx_xxxx</code>).</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/sv39-pgt-structure.png" /></p>
<p>The virtual address is divided into four parts: VPN[2-0] (Virtual Page Number) and page offset. The three-level VPNs serve as indices in the three-level page table, while the page offset indicates the address’s offset within the translated page.</p>
<p>An Sv39 PTE is 8 bytes, split into PPN (Physical Page Number) and Flags. The PPN, combined with the virtual address’s page offset, forms the final physical address, while Flags specify access permissions and other details.</p>
<h3 id="flags">Flags<a class="headerlink" href="#flags" title="Permanent link">&para;</a></h3>
<p>Flags are defined as follows:</p>
<ul>
<li><em>D, A</em>: Dirty, Accessed. Indicate if the page was recently accessed/written.</li>
<li><em>G</em>: Global. Indicates the mapping exists in all page tables.</li>
<li><em>U</em>: User. Allows access in user privilege mode.</li>
<li><em>V</em>: Valid. Marks the PTE as valid; otherwise, the entire PTE is invalid.</li>
<li><em>R, W, X</em>: Read, Write, Executable permissions.</li>
</ul>
<p>RWX is defined as shown below:
Note that <code>XWR == 3'b000</code> indicates the physical address [PPN: 12b0] is the base address of the next-level page table; otherwise, the PTE is a leaf PTE.</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/pte-rwx-encoding.png" /></p>
<h4 id="a-d">A &amp; D<a class="headerlink" href="#a-d" title="Permanent link">&para;</a></h4>
<p>Each page PTE includes Accessed (A) and Dirty (D) bits:</p>
<ul>
<li><em>A</em>: Set if the virtual page was read, written, or fetched (instruction fetch) since the last A-bit clear.</li>
<li><em>D</em>: Set if the virtual page was written since the last D-bit clear.</li>
</ul>
<p>When accessing a virtual page with A=0 or writing with D=0, RISC-V allows two update methods:</p>
<ol>
<li>Trigger a PageFault, requiring the Supervisor exception handler to manually set A/D bits.</li>
<li>Hardware automatically sets A/D bits.</li>
</ol>
<p>Supervisor software must handle both cases correctly.</p>
<h4 id="permission-checks">Permission Checks<a class="headerlink" href="#permission-checks" title="Permanent link">&para;</a></h4>
<p>Intuitively, a readable page needs the R bit, a writable page needs the W bit, and an executable page needs the X bit.</p>
<p>However, if a page has the U bit and the CPU is in S-mode, we must check the SUM (Supervisor User Memory access) bit in <code>sstatus</code>. If <code>sstatus.SUM == 1</code>, access is permitted; otherwise, it causes a Page Fault.</p>
<p>Typically, S-mode runs with <code>sstatus.SUM == 0</code>. To access user data via the page table, we set this flag to 1 and clear it afterward. This process is often called the <strong>uaccess</strong> primitive.</p>
<p>See also: <a href="https://github.com/torvalds/linux/blob/master/arch/riscv/include/asm/uaccess.h">https://github.com/torvalds/linux/blob/master/arch/riscv/include/asm/uaccess.h</a></p>
<!-- !!!questions "Virtual Memory Model under AArch64 Architecture"

    AArch64 distinctly divides virtual addresses into a low-address portion and a high-address portion. (Simply put, addresses starting with `0x0000_xxxx` and those starting with `0xffff_xxxx`.)

    For low addresses, the `TTBR0_EL1` (Translation Table Base Register 0 (EL1)) register is used as a base address register, similar to the `satp` register, for address translation.  
    For high addresses, `TTBR1_EL1` is used for address translation.

    Clearly, this model is inherently suited for isolating the kernel page table from the user page table. -->

<p>The Sv39 address translation process is shown below (L2, L1, L0 represent VPN2, VPN1, VPN0, with lower addresses at the bottom and higher at the top in the Page Directory):</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/riscv-address-translation.png" /></p>
<p>See also: riscv-privilege.pdf, 4.3.2 Virtual Address Translation Process</p>
<p>Text description: <code>{xx | yy}</code> denotes concatenating <code>yy</code> bits to the right of <code>xx</code> bits, similar to Verilog syntax.</p>
<ol>
<li>Decompose Virtual Address: <code>{ 25'signed_ext, 9'VPN2, 9'VPN1, 9'VPN0, 12'pgoff} = 64'VirtualAddress</code></li>
<li>Use the PPN from the satp register as the first-level page table’s base address.</li>
<li>Use VPN2 as the index to find pte2 in the first-level page table.</li>
</ol>
<p>Equivalent C code: <code>uint64 pte2 = *(uint64*)(satp.base + VPN2 * 8);</code></p>
<ol>
<li>If <code>pte2.WXR != 3'b000</code>, it’s a 1GiB huge page mapping.</li>
</ol>
<p>Check if PPN is 1GiB-aligned: <code>pte2.PPN1 == 9'b0 &amp;&amp; pte2.PPN0 == 9'b0</code>. If true, go to step 10; otherwise, Page Fault.</p>
<ol>
<li><code>{pte2.PPN, 12'b0}</code> is the second-level page table’s base address.</li>
<li>Use VPN1 as the index to find pte1 in the second-level page table.</li>
</ol>
<p>Equivalent C code: <code>uint64 pte1 = *(uint64*)((pte2.ppn &lt;&lt; 12) + VPN1 * 8);</code></p>
<ol>
<li>If <code>pte1.WXR != 3'b000</code>, it’s a 2MiB huge page mapping.</li>
</ol>
<p>Check if PPN is 2MiB-aligned: <code>pte2.PPN0 == 9'b0</code>. If true, go to step 10; otherwise, Page Fault.</p>
<ol>
<li>Otherwise, <code>{pte1.PPN | 12'b0}</code> is the third-level page table’s base address.</li>
<li>Use VPN0 as the index to find PTE in the third-level page table.</li>
</ol>
<p>Equivalent C code: <code>uint64 pte0 = *(uint64*)((pte1.ppn &lt;&lt; 12) + VPN0 * 8);</code></p>
<ol>
<li>
<p>Compute the final physical address: <code>PA = (leaf_pte.ppn &lt;&lt; 12) | final_page_offset</code>,</p>
<p>For 2MiB huge pages: <code>final_page_offset = {9'VPN0, 12'pgoff}</code>.</p>
<p>For 1GiB huge pages: <code>final_page_offset = {9'VPN1, 9'VPN0, 12'pgoff}</code>.</p>
<p>Otherwise: <code>final_page_offset = 12'pgoff</code>.</p>
</li>
<li>
<p>Permission check: Verify <code>leaf_pte.rwx</code> matches the memory access request.</p>
</li>
</ol>
<h3 id="huge-page-mapping">Huge Page Mapping<a class="headerlink" href="#huge-page-mapping" title="Permanent link">&para;</a></h3>
<p>When all XWR bits in Flags are 0, the PTE points to the next-level page table. If any XWR bit is non-zero, the PTE is a leaf node, meaning its PPN represents the <strong>physical page’s</strong> base address, not a <strong>page table’s</strong> base address.</p>
<p>For example, in Sv39, given a virtual address VA[38:0], we compute the first-level PTE address using <code>satp.PPN × 4096 + VPN2</code>. If the PTE’s XWR is 001, it’s a leaf PTE (huge page mapping). Since the first-level PTE is a leaf, the virtual address interpretation changes from:</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/vpn_origin.png" /></p>
<p>to:</p>
<p><img alt="alt text" src="../../assets/xv6lab-paging/vpn_gigapage.png" /></p>
<p>The physical address becomes <code>PTE.PPN × 4096 + VA[29:0]</code>. Here, the 30-bit offset represents a large space (2<sup>30</sup> bytes = 1GiB) starting from PTE.PPN × 4096, called a <strong>giga-page</strong>. (Note: In architectures supporting huge pages, the base address must align to its size, e.g., giga-page base addresses must align to 1GB, meaning the lower 30 bits of PTE.PPN * 4096 must be 0.)</p>
<p>Similarly, if a second-level PTE is a leaf, its <code>[20:0]</code> bits represent a combined offset for a smaller huge page, called a <strong>mega-page</strong>. Typically, third-level PTEs are leaves, pointing to a <strong>base page</strong> (4KB).</p>
<h2 id="lab-classroom-report">Lab Classroom Report<a class="headerlink" href="#lab-classroom-report" title="Permanent link">&para;</a></h2>
<ol>
<li>Referring to the Sv39 address translation mode, decode the following virtual addresses and write their VPN[2-0] and offset in binary. <strong>Note: Use binary representation!</strong></li>
</ol>
<table>
<thead>
<tr>
<th>vaddr</th>
<th>VPN2</th>
<th>VPN1</th>
<th>VPN0</th>
<th>offset</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0x0000_0000_8020_1234</code></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>0x0000_003f_ffff_f000</code></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>0xffff_ffd1_dead_beef</code></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Hint: Use the Windows Calculator in Programmer mode to convert between hex, decimal, and binary, or use Python3’s <code>bin(0x1122_3344)</code> to convert to binary.</p>
<ol>
<li>Referring to Sv39 mode, manually perform address translation and list all valid mappings in the page table.</li>
</ol>
<p><code>satp: 0x8000000000080400</code></p>
<p>Hexdump of partial memory is shown below. The left side of the colon is the address; the right side shows two <code>uint64_t</code> values in hex at that address and address + 0x8. Unspecified memory is all 0s. The hexdump is in little-endian order, so no endianness adjustment is needed.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>0x8040_0000:
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>0x0000000080400000:     0x0000000020100401
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>0x00000000804004a8:     0x0000000020101401
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>0x00000000804007f8:     0x0000000020100c01
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>0x8040_1000:
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>0x0000000080401000:     0x0000000020100801
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>0x8040_2000:
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>0x0000000080402008:     0x000000002000001f
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>0x0000000080402010:     0x000000002000041f
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>0x8040_3000:
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>0x0000000080403ff8:     0x0000000020101001
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>0x8040_4000:
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>0x0000000080404ff8:     0x000000003777400b
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>0x8040_5000:
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>0x00000000804056f0:     0x00000037ab400043
</code></pre></div>
<p><strong>Note: All numbers are in hexadecimal; follow the format of the first row in the table.</strong></p>
<table>
<thead>
<tr>
<th>Virtual Address</th>
<th>Size</th>
<th>PPN</th>
<th>Flags(DAGUXWRV)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0xdead_beef_aabb_ccdd</code></td>
<td><code>0x00aa_eeff</code></td>
<td><code>0x8899_0000</code></td>
<td><code>DA-UWXRV</code></td>
</tr>
</tbody>
</table>
<ol>
<li>On the RISC-V platform, the page size is <code>4KiB</code>. In 32-bit mode, we use Sv32; in 64-bit mode, we use Sv39. Given that Sv32 PTEs are 4 bytes and Sv39 PTEs are 8 bytes:</li>
</ol>
<blockquote>
<p>Sv32 page tables consist of 2^10 page-table entries (PTEs), each of four bytes. A page table is exactly the size of a page and must always be aligned to a page boundary. The physical page number of the root page table is stored in the satp register.</p>
<p>Sv39 page tables contain 2^9 page table entries (PTEs), eight bytes each. A page table is exactly the size of a page and must always be aligned to a page boundary. The physical page number of the root page table is stored in the satp register’s PPN field.</p>
</blockquote>
<p>Briefly explain why each VPN in Sv32 is 10 bits, while each VPN in Sv39 is 9 bits.</p>
<h2 id="experiment-scenario">Experiment Scenario<a class="headerlink" href="#experiment-scenario" title="Permanent link">&para;</a></h2>
<div class="admonition warning">
<p class="admonition-title">xv6-lab4 Code Branch</p>
<p><a href="https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab4">https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab4</a></p>
<p>Use <code>git clone https://github.com/yuk1i/SUSTech-OS-2025 -b xv6-lab4 xv6lab4</code> to download the xv6-lab4 code.</p>
<p>Run <code>make run</code> to start the kernel for this lab. The kernel will perform relocation and boot, eventually running with a high-address PC and SP.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Kernel Starts Relocating...
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>Kernel size: 0x000000000002e000, Rounded to 2MiB: 0x0000000000200000
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>[INFO  0,-1] bootcpu_start_relocation: Kernel phy_base: 0x0000000080200000, phy_end_4k:0x000000008022e000, phy_end_2M 0x0000000080400000
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>Mapping Identity: 0x0000000080200000 to 0x0000000080200000
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>Mapping kernel image: 0xffffffff80200000 to 0x0000000080200000
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>Mapping Direct Mapping: 0xffffffc080400000 to 0x0000000080400000
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>Enable SATP on temporary pagetable.
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>Boot HART Relocated. We are at high address now! PC: 0xffffffff80203d68
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>[INFO  0,-1] kvm_init: boot-stage page allocator: base 0xffffffc080400000, end 0xffffffc080600000
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>[INFO  0,-1] kvmmake: Memory after kernel image (phys) size = 0x0000000007c00000
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>[INFO  0,-1] kvm_init: enable pageing at 0x8000000000080400
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>[INFO  0,-1] kvm_init: boot-stage page allocator ends up: base 0xffffffc080400000, used: 0xffffffc080411000
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>Relocated. Boot halt sp at 0xffffffffff001fb0
</code></pre></div>
</div>
<p>In this lab’s code, we will construct a virtual address space for the kernel and transition the OS from running in physical address space to virtual address space.</p>
<p>The code execution flow is as follows:</p>
<ol>
<li>
<p><code>entry.S</code>’s <code>_entry</code>: OS entry point.</p>
</li>
<li>
<p><code>main.c</code>’s <code>bootcpu_entry</code>: C language entry point.</p>
</li>
<li>
<p><code>main.c</code>’s <code>bootcpu_start_relocation</code>: Relocate PC and satp, setting a temporary page table.</p>
</li>
<li>
<p><code>main.c</code>’s <code>bootcpu_relocating</code>: Call <code>kvm_init</code> to complete kernel page table setup and switch.</p>
</li>
<li>
<p><code>main.c</code>’s <code>bootcpu_init</code>: Kernel initialization, jumping to <code>scheduler</code>.</p>
</li>
</ol>
<p>To switch from running in physical address space to virtual address space, we first need to understand where the kernel resides in physical space:</p>
<h2 id="risc-v-physical-address-layout">RISC-V Physical Address Layout<a class="headerlink" href="#risc-v-physical-address-layout" title="Permanent link">&para;</a></h2>
<p>RISC-V maps physical memory (DDR/DRAM) starting at physical address <code>0x8000_0000</code>, not <code>0x0000_0000</code>.</p>
<p>For example, with 128 MiB (0x0800_0000) of DRAM, a RISC-V core maps it to <code>[0x8000_0000, 0x8800_0000)</code>.</p>
<p>For QEMU’s virt machine, we can examine the source code for its physical address mappings:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">MemMapEntry</span><span class="w"> </span><span class="n">virt_memmap</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_DEBUG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="p">{</span><span class="w">        </span><span class="mh">0x0</span><span class="p">,</span><span class="w">         </span><span class="mh">0x100</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_MROM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">         </span><span class="p">{</span><span class="w">     </span><span class="mh">0x1000</span><span class="p">,</span><span class="w">        </span><span class="mh">0xf000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_TEST</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">         </span><span class="p">{</span><span class="w">   </span><span class="mh">0x100000</span><span class="p">,</span><span class="w">        </span><span class="mh">0x1000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_RTC</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">          </span><span class="p">{</span><span class="w">   </span><span class="mh">0x101000</span><span class="p">,</span><span class="w">        </span><span class="mh">0x1000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_CLINT</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="p">{</span><span class="w">  </span><span class="mh">0x2000000</span><span class="p">,</span><span class="w">       </span><span class="mh">0x10000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_ACLINT_SSWI</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">{</span><span class="w">  </span><span class="mh">0x2F00000</span><span class="p">,</span><span class="w">        </span><span class="mh">0x4000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PCIE_PIO</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="p">{</span><span class="w">  </span><span class="mh">0x3000000</span><span class="p">,</span><span class="w">       </span><span class="mh">0x10000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PLATFORM_BUS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="mh">0x4000000</span><span class="p">,</span><span class="w">     </span><span class="mh">0x2000000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PLIC</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">         </span><span class="p">{</span><span class="w">  </span><span class="mh">0xc000000</span><span class="p">,</span><span class="w"> </span><span class="n">VIRT_PLIC_SIZE</span><span class="p">(</span><span class="n">VIRT_CPUS_MAX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_APLIC_M</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="p">{</span><span class="w">  </span><span class="mh">0xc000000</span><span class="p">,</span><span class="w"> </span><span class="n">APLIC_SIZE</span><span class="p">(</span><span class="n">VIRT_CPUS_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_APLIC_S</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="p">{</span><span class="w">  </span><span class="mh">0xd000000</span><span class="p">,</span><span class="w"> </span><span class="n">APLIC_SIZE</span><span class="p">(</span><span class="n">VIRT_CPUS_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_UART0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mh">0x10000000</span><span class="p">,</span><span class="w">         </span><span class="mh">0x100</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_VIRTIO</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="mh">0x10001000</span><span class="p">,</span><span class="w">        </span><span class="mh">0x1000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_FW_CFG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="mh">0x10100000</span><span class="p">,</span><span class="w">          </span><span class="mh">0x18</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_FLASH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mh">0x20000000</span><span class="p">,</span><span class="w">     </span><span class="mh">0x4000000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_IMSIC_M</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x24000000</span><span class="p">,</span><span class="w"> </span><span class="n">VIRT_IMSIC_MAX_SIZE</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_IMSIC_S</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x28000000</span><span class="p">,</span><span class="w"> </span><span class="n">VIRT_IMSIC_MAX_SIZE</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PCIE_ECAM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mh">0x30000000</span><span class="p">,</span><span class="w">    </span><span class="mh">0x10000000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_PCIE_MMIO</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mh">0x40000000</span><span class="p">,</span><span class="w">    </span><span class="mh">0x40000000</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">    </span><span class="p">[</span><span class="n">VIRT_DRAM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">         </span><span class="p">{</span><span class="w"> </span><span class="mh">0x80000000</span><span class="p">,</span><span class="w">           </span><span class="mh">0x0</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="p">};</span>
</code></pre></div>
<p>For our OS experiments, we only need to focus on DRAM and some peripherals (PLIC, UART):</p>
<table>
<thead>
<tr>
<th style="text-align: left;"><code>Base</code></th>
<th style="text-align: left;">Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>0x0000_1000</code></td>
<td style="text-align: left;"><code>0x0000_f000</code></td>
<td>BootROM</td>
</tr>
<tr>
<td style="text-align: left;"><code>0x0c00_0000</code></td>
<td style="text-align: left;"><code>0x0060_0000</code></td>
<td>PLIC</td>
</tr>
<tr>
<td style="text-align: left;"><code>0x1000_0000</code></td>
<td style="text-align: left;"><code>0x0000_0100</code></td>
<td>Serial UART</td>
</tr>
<tr>
<td style="text-align: left;"><code>0x8000_0000</code></td>
<td style="text-align: left;">DRAM Size</td>
<td>DRAM</td>
</tr>
</tbody>
</table>
<p><img alt="alt text" src="../../assets/xv6lab-paging/xv6lab-paging-phymemlayout.png" /></p>
<p>Next, we need to design a memory layout determining how we establish address mappings for the kernel.</p>
<h2 id="xv6-kernel-memory-layout">xv6 Kernel Memory Layout<a class="headerlink" href="#xv6-kernel-memory-layout" title="Permanent link">&para;</a></h2>
<p>Sv39 virtual addresses use sign-extension for high bits, creating a large gap between <code>&lt; 256 GiB</code> and <code>256 GiB ~ 512 GiB</code>. We leverage this to distinguish user addresses (low, starting with <code>0x0000</code>) from kernel addresses (high, starting with <code>0xffff</code>).</p>
<table>
<thead>
<tr>
<th style="text-align: right;"><code>Base Address</code></th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;"><code>0x0000_0000_xxxx_xxxx</code></td>
<td>Userspace</td>
</tr>
<tr>
<td style="text-align: right;"><code>0x0000_003f_ffff_e000</code></td>
<td>Trapframe</td>
</tr>
<tr>
<td style="text-align: right;"><code>0x0000_003f_ffff_f000</code></td>
<td>Trampoline</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffc0_0000_0000</code></td>
<td>Kernel Direct Mapping of all available physical pages</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_fffd_0000_0000</code></td>
<td>Kernel Heap (fixed-size object)</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffff_8020_0000</code></td>
<td>Kernel Image (.text, .data, .bss)</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffff_a000_0000</code></td>
<td>Device Memory-Mapped IO</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffff_d000_0000</code></td>
<td>Kernel stack for processes</td>
</tr>
<tr>
<td style="text-align: right;"><code>0xffff_ffff_ff00_0000</code></td>
<td>Kernel stack for per-cpu scheduler</td>
</tr>
</tbody>
</table>
<ul>
<li><em>Trampoline</em> serves as a bridge between user and kernel space, placed at the top of the lower 128 GiB.</li>
<li>The kernel image (<code>build/kernel</code> ELF file) is mapped to virtual address <code>0xffff_ffff_8020_0000</code>, offset from its physical address <code>0x8020_0000</code> by a constant <code>0xffff_ffff_0000_0000</code>.</li>
<li>Additional pages needed by the kernel, such as per-CPU scheduler stacks and MMIO for peripherals, are mapped.</li>
<li>All remaining available physical pages are direct-mapped to <code>0xffff_ffc0_80xx_xxxx</code> and managed by <code>kalloc</code>.</li>
</ul>
<p><img alt="alt text" src="../../assets/xv6lab-paging/xv6lab-paging-kmemlayout.png" /></p>
<div class="admonition note">
<p class="admonition-title">Direct Mapping</p>
<p>For available physical memory, we use Direct Mapping: <code>virtual address = physical address + constant offset</code>.</p>
<p>Direct Mapping allows the kernel to directly manipulate all available physical memory, except the kernel image itself.</p>
<p>Without Direct Mapping, we’d need to map newly allocated pages into the kernel’s virtual address space to access them. With it, adding a constant offset to a physical address yields a kernel-accessible virtual address:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="cp">#define KERNEL_DIRECT_MAPPING_BASE  0xffffffc000000000ull</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="cp">#define KVA_TO_PA(x) (((uint64)(x)) - KERNEL_DIRECT_MAPPING_BASE)</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="cp">#define PA_TO_KVA(x) (((uint64)(x)) + KERNEL_DIRECT_MAPPING_BASE)</span>
</code></pre></div>
</div>
<p>After designing the kernel memory layout, we need to transition the kernel from physical to virtual address space, starting with relocation:</p>
<h2 id="relocation">Relocation<a class="headerlink" href="#relocation" title="Permanent link">&para;</a></h2>
<p>The kernel image (<code>build/kernel</code> ELF file) is initially placed at physical address <code>0x8020_0000</code>. Now, we need to map it to a high address using a fixed offset.</p>
<p>Symbols (variables, functions) defined in the kernel are loaded by OpenSBI to physical addresses like <code>0x0000_0000_8020_abcd</code>, and we map them to virtual addresses like <code>0xffff_ffff_8020_abcd</code>. The difference between these addresses is always a fixed value, defined as the <em>kernel offset</em>.</p>
<p>We define this as the macro <code>KERNEL_OFFSET</code> and provide macros <code>KIVA_TO_PA</code> and <code>PA_TO_KIVA</code> for conversion (KIVA: Kernel Image Virtual Address):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="cp">#define KERNEL_VIRT_BASE 0xffffffff80200000ull</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="cp">#define KERNEL_PHYS_BASE 0x80200000ull</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="cp">#define KERNEL_OFFSET    ((uint64)(KERNEL_VIRT_BASE - KERNEL_PHYS_BASE))</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="c1">// (Kernel Image Virtual Address) TO (Physical Address)</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="cp">#define KIVA_TO_PA(x) (((uint64)(x)) - KERNEL_OFFSET)</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="cp">#define PA_TO_KIVA(x) (((uint64)(x)) + KERNEL_OFFSET)</span>
</code></pre></div>
<p>Shifting the base address of the entire image doesn’t alter the distance between symbols:</p>
<ol>
<li>Symbol <em>a</em> loads to PA_a <code>0x0000_0000_8020_dead</code>, symbol <em>b</em> to PA_b <code>0x0000_0000_8020_beef</code>.</li>
<li>Symbol <em>a</em> maps to VA_a <code>0xffff_ffff_8020_dead</code>, symbol <em>b</em> to VA_b <code>0xffff_ffff_8020_beef</code>.</li>
<li><code>PA_a - PA_b = VA_a - VA_b</code>.</li>
</ol>
<p>This property allows relocation of the kernel image using <em>PC-relative</em> addressing. With PC-relative addressing, we calculate a target symbol’s address using the current PC plus an offset (<code>target = pc + offset</code>, via <code>auipc</code> and <code>addi</code> in assembly), rather than absolute addressing (<code>target = immediate</code>). 
Thus, we can relocate the entire kernel image to any base address, as long as symbol offsets remain fixed during compilation and loading. This is also the principle behind Linux’s KASLR (Kernel Address Space Layout Randomization, see: <a href="https://lwn.net/Articles/569635/">https://lwn.net/Articles/569635/</a>).</p>
<p>To relocate the kernel image, we:</p>
<ol>
<li>Map the kernel image to virtual address <code>0xffff_ffff_8020_0000</code>.</li>
<li>Jump the PC to a high address like <code>0xffff_ffff_8020_xxxx</code>.</li>
</ol>
<p>We expect the kernel to run at <code>0xffff_ffff_8020_0000</code>, so we modify <code>kernel.ld</code> to ensure the linker aligns it correctly:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>OUTPUT_ARCH(riscv)
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>ENTRY(_entry)
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>BASE_ADDRESS = 0xffffffff80200000;
</code></pre></div>
<p>However, OpenSBI cannot load the kernel ELF to a physical address if the Program Header’s expected physical address (PhysAddr) is the high address <code>0xffff_ffff_8020_0000</code>, which is invalid during loading. </p>
<p>Thus, we specify <code>AT(0x80200000)</code> after the <code>.text</code> section to indicate it should load to physical address <code>0x8020_0000</code>. This ensures the ELF’s Program Headers have <code>VirtAddr = 0xffff_ffff_8020_0000</code> and <code>PhysAddr = 0x8020_0000</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>BASE_ADDRESS = 0xffffffff80200000;
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>SECTIONS
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>{
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    . = BASE_ADDRESS;
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    skernel = .;
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    s_text = .;
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    .text : AT(0x80200000) {
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>        *(.text.entry)
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        // ...
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    }
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    // ...
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>}
</code></pre></div>
<p>Running <code>make run</code> now shows OpenSBI correctly locating the kernel’s entry point:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Domain0 Next Address      : 0x0000000080200000
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>Domain0 Next Arg1         : 0x000000009fe00000
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>Domain0 Next Mode         : S-mode
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>...
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>clean bss: 0x00000000802ac000 - 0x00000000802b3000
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>Kernel is Relocating...
</code></pre></div>
<p>Next, we build page tables to enable the MMU to translate virtual addresses per our layout.</p>
<p>If we directly build the kernel memory layout’s page table, switching would require instructions like:</p>
<ol>
<li><code>csrw satp</code>: Set the satp register to enable Sv39 translation.</li>
<li><code>...</code></li>
</ol>
<p>After executing the first instruction, the PC is at a physical address <code>0x8020_xxxx</code>.
However, after we execute the first instruction to set the <code>satp</code> register, the second instruction will immediately begin to execute. At this point, our PC still points to the physical address of the second instruction, and this physical address is invalid in the current page table.<br />
As a result, our second instruction will trigger an <strong>Instruction Page Fault</strong> exception.</p>
<p>In other words, after setting up the kernel page table, we cannot directly switch to a page table containing only high addresses because, at that moment, our PC pointer still points to a low address. We cannot simultaneously perform both the PC switch and the <code>satp</code> switch.<br />
Therefore, we need a temporary page table that includes two parts of mappings:</p>
<ol>
<li>VA <code>0x0000_0000_8020_0000</code> -&gt; PA <code>0x8020_0000</code></li>
<li>VA <code>0xffff_ffff_8020_0000</code> -&gt; PA <code>0x8020_0000</code></li>
</ol>
<p>After enabling Sv39 with the first instruction, the PC (next instruction’s physical address) remains a valid virtual address. We load an immediate value into a register and use <code>jr</code> to jump to the high address.</p>
<p>This process is called <em>Relocation</em>.</p>
<p>See also: <a href="https://0xax.gitbooks.io/linux-insides/content/Booting/linux-bootstrap-6.html">https://0xax.gitbooks.io/linux-insides/content/Booting/linux-bootstrap-6.html</a></p>
<h3 id="relocation_start-code-explanation"><code>relocation_start</code> Code Explanation<a class="headerlink" href="#relocation_start-code-explanation" title="Permanent link">&para;</a></h3>
<p>In the temporary page table for <code>relocation_start</code>, we use 2 MiB huge page mappings. We allocate four aligned physical pages:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">relocate_pagetable</span><span class="p">[</span><span class="n">PGSIZE</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PGSIZE</span><span class="p">)));</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">relocate_pagetable_level1_ident</span><span class="p">[</span><span class="n">PGSIZE</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PGSIZE</span><span class="p">)));</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">relocate_pagetable_level1_direct_mapping</span><span class="p">[</span><span class="n">PGSIZE</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PGSIZE</span><span class="p">)));</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">relocate_pagetable_level1_high</span><span class="p">[</span><span class="n">PGSIZE</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PGSIZE</span><span class="p">)));</span>
</code></pre></div>
<p>We compute the kernel image’s end (<code>ekernel</code>) and round it up to 2MiB, as 2 MiB huge pages require both virtual and physical addresses to be 2MiB-aligned:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1">// Kernel Start Point must be aligned to 2MiB</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">assert</span><span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">KERNEL_PHYS_BASE</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">));</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="c1">// Calculate Kernel image size, and round up to 2MiB.</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">ekernel</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">skernel</span><span class="p">;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_size_4K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDUP_2N</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDUP_2N</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">);</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="n">kernel_image_end_4k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_PHYS_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_size_4K</span><span class="p">;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="n">kernel_image_end_2M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_PHYS_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="p">;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Kernel size: %p, Rounded to 2MiB: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_size</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="p">);</span>
</code></pre></div>
<p>After <code>kernel_image_end_2M</code>, we allocate another 2MiB page as the first memory pool for Kernel Direct Mapping (explained later):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">// Calculate Kernel Mapping Base &amp; End</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_phys_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_PHYS_BASE</span><span class="p">;</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_phys_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_phys_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="p">;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_virt_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_VIRT_BASE</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_virt_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_virt_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_size_2M</span><span class="p">;</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="c1">// Calculate the first Direct Mapping Base &amp; End</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_la_phy_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_image_end_2M</span><span class="p">;</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_la_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_DIRECT_MAPPING_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kernel_la_phy_base</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="n">uint64</span><span class="w"> </span><span class="n">kernel_la_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_la_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">;</span>
</code></pre></div>
<p>We then map: VA <code>0x0000_0000_8020_0000</code> -&gt; PA <code>0x8020_0000</code>:</p>
<ol>
<li>Add a PTE to <code>pgt_root</code> pointing to the first-level page table <code>pgt_ident</code>.</li>
<li>From <code>kernel_phys_base</code> to <code>kernel_phys_end</code>, add a PTE every 2 MiB.</li>
<li>Compute the virtual address (here, <code>va = pa</code>).</li>
<li>Compute <code>VPN1</code> and add the mapping to <code>pgt_ident</code>.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">// We will still have some instructions executed on pc 0x8020xxxx before jumping to KIVA.</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="c1">// Step 2. Setup Identity Mapping for 0x80200000 -&gt; 0x80200000, using 2MiB huge page.</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="p">{</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">VPN2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_phys_base</span><span class="p">);</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">pgt_root</span><span class="p">[</span><span class="n">VPN2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">((</span><span class="n">uint64</span><span class="p">)</span><span class="n">pgt_ident</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_phys_base</span><span class="p">;</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kernel_phys_end</span><span class="p">;</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">        </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pa</span><span class="p">;</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">        </span><span class="n">uint64</span><span class="w"> </span><span class="n">vpn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">);</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">        </span><span class="n">pgt_ident</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="p">);</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Mapping Identity: %p to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">pa</span><span class="p">);</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="p">}</span>
</code></pre></div>
<p>Next, map the kernel ELF’s virtual address: VA <code>0xffff_ffff_8020_0000</code> -&gt; PA <code>0x8020_0000</code>
Now <code>va = pa + KERNEL_OFFSET</code>.</p>
<p>Finally, map the first Direct Mapping block: VA <code>0xffff_ffc0_80xx_0000</code> -&gt; the first free 2 MiB physical page <code>0x80xx_0000</code>.</p>
<h2 id="kernel-page-table">Kernel Page Table<a class="headerlink" href="#kernel-page-table" title="Permanent link">&para;</a></h2>
<blockquote>
<p>code: <code>os/kvm.c</code></p>
</blockquote>
<p>After relocation, the PC is at a high address, and the SP is at a high address in <code>boot_stack</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>Mapping Identity: 0x0000000080200000 to 0x0000000080200000
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>Mapping kernel image: 0xffffffff80200000 to 0x0000000080200000
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>Mapping Direct Mapping: 0xffffffc080400000 to 0x0000000080400000
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>Enable SATP on temporary pagetable.
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>Boot HART Relocated. We are at high address now! PC: 0xffffffff80203d68, SP: 0xffffffff80223ff0
</code></pre></div>
<p>In <code>bootcpu_relocating</code>, we call <code>kvm_init()</code> to construct the final kernel page table and switch to it.</p>
<p>Building the kernel page table requires allocating physical pages for the tables, called the <em>boot-stage page allocator</em>. These pages are persistent and never freed.
Since we’ll need to access them later, we place their physical addresses in the Direct Mapping range, accessible via Direct Mapping virtual addresses.
During relocation, we borrow a 2MiB region in the Direct Mapping range: <code>[0x8040_0000, 0x8060_0000)</code> after aligning <code>e_kernel</code> (0x802x_0000) to 2MiB (0x8040_0000).
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>[INFO  0,-1] kvm_init: boot-stage page allocator: base 0xffffffc080400000, end 0xffffffc080600000
</code></pre></div></p>
<p>The <code>kvmmake</code> function calls <code>kvmmap</code> to map each region sequentially:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">static</span><span class="w"> </span><span class="n">pagetable_t</span><span class="w"> </span><span class="nf">kvmmake</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">kpgtbl</span><span class="p">;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="n">kpgtbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">allocsetuppage</span><span class="p">();</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="c1">// Step.1 : Kernel Image</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="c1">// Step.2 : Kernel Trampoline</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="c1">// Step.3 : Kernel Device MMIO :</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="c1">// Step.4 : Kernel Scheduler stack:</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="c1">// Step.5 : Kernel Direct Mapping</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="p">}</span>
</code></pre></div>
<p><code>kvmmap</code>’s prototype is <code>void kvmmap(pagetable_t kpgtbl, uint64 va, uint64 pa, uint64 sz, int perm)</code>, mapping <code>[va, va+sz)</code> to <code>[pa, pa+sz)</code>.</p>
<ol>
<li>For the Kernel Image, we map three sections: <code>.text</code> (RX), <code>.rodata</code> (RO), <code>.data (.bss)</code> (RW). We use symbols like <code>e_text</code> from <code>kernel.ld</code> to determine start and end addresses. Referencing <code>s_text</code> directly yields its virtual address via <code>auipc</code>, convertible to physical via <code>KIVA_TO_PA</code>.</li>
</ol>
<p>A special page in <code>.text</code>, the <em>trampoline</em>, is mapped to <code>0x3f_ffff_f000</code> (covered in the next lesson):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="w">    </span><span class="c1">// map kernel text executable and read-only.</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="c1">// 0xffff_ffff_8020_0000 -&gt; 0x8020_0000</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_text</span><span class="p">,</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">s_text</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">e_text</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_text</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">);</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="c1">// map kernel ro_data: s_rodata to e_rodata</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_rodata</span><span class="p">,</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">s_rodata</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">e_rodata</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_rodata</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="p">);</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="c1">// map kernel .s_data to .e_bss,</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">kimage_data_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">e_bss</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">s_data</span><span class="p">);</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">s_data</span><span class="p">,</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">s_data</span><span class="p">),</span><span class="w"> </span><span class="n">kimage_data_size</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="c1">// map trampoline</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">TRAMPOLINE</span><span class="p">,</span><span class="w"> </span><span class="n">KIVA_TO_PA</span><span class="p">(</span><span class="n">trampoline</span><span class="p">),</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">);</span>
</code></pre></div>
<p>The <code>kernel_pagetable</code> structure looks like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>=== PageTable at 0xffffffc080400000 ===
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>[ff], pte[0xffffffc0804007f8]: 0x0000003fc0000000 -&gt; 0x0000000080403000 -------V
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>  [1ff], pte[0xffffffc080403ff8]: 0x0000003fffe00000 -&gt; 0x0000000080404000 -------V
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    [1ff], pte[0xffffffc080404ff8]: 0x0000003ffffff000 -&gt; 0x000000008020a000 -A--X-RV
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>[1fe], pte[0xffffffc080400ff0]: 0xffffffff80000000 -&gt; 0x0000000080401000 -------V
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>  [1], pte[0xffffffc080401008]: 0xffffffff80200000 -&gt; 0x0000000080402000 -------V
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    [0], pte[0xffffffc080402000]: 0xffffffff80200000 -&gt; 0x0000000080200000 -A--X-RV
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    ...
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    [9], pte[0xffffffc080402048]: 0xffffffff80209000 -&gt; 0x0000000080209000 -A--X-RV
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    [b], pte[0xffffffc080402058]: 0xffffffff8020b000 -&gt; 0x000000008020b000 -A----RV
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    ...
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    [20], pte[0xffffffc080402100]: 0xffffffff80220000 -&gt; 0x0000000080220000 -A----RV
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    [21], pte[0xffffffc080402108]: 0xffffffff80221000 -&gt; 0x0000000080221000 DA---WRV
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    ...
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    [2c], pte[0xffffffc080402160]: 0xffffffff8022c000 -&gt; 0x000000008022c000 DA---WRV
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>=== END ===
</code></pre></div>
<ol>
<li>Map MMIO regions for peripherals (PLIC and UART0):</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="w">    </span><span class="c1">// Step.3 : Kernel Device MMIO :</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_PLIC_BASE</span><span class="p">,</span><span class="w"> </span><span class="n">PLIC_PHYS</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_PLIC_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_UART0_BASE</span><span class="p">,</span><span class="w"> </span><span class="n">UART0_PHYS</span><span class="p">,</span><span class="w"> </span><span class="n">KERNEL_UART0_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
</code></pre></div>
<ol>
<li>Map each CPU’s scheduler stack, with each stack spanning two <code>PGSIZE</code> pages and separated by a <em>guard page</em> (unmapped address). Stack overflow triggers a Page Fault rather than silent errors:</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="w">    </span><span class="c1">// Step.4 : Kernel Scheduler stack:</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">sched_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNEL_STACK_SCHED</span><span class="p">;</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NCPU</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpu</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getcpu</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">        </span><span class="c1">// allocate #KERNEL_STACK_SIZE / PGSIZE pages</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_stack</span><span class="p">;</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sched_stack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">            </span><span class="n">uint64</span><span class="w"> </span><span class="n">__pa</span><span class="w"> </span><span class="n">newpg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KVA_TO_PA</span><span class="p">(</span><span class="n">allockernelpage</span><span class="p">());</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">            </span><span class="n">debugf</span><span class="p">(</span><span class="s">&quot;map halt %d, va:%p, pa:%p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">newpg</span><span class="p">);</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">            </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">newpg</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">        </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sched_kstack_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_stack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="p">;</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">        </span><span class="c1">// double the sched_stack to make a significant gap between different cpus.</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">        </span><span class="c1">//  if any kernel stack overflows, it will page fault.</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">        </span><span class="n">sched_stack</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">KERNEL_STACK_SIZE</span><span class="p">;</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>The scheduler stack structure is:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>[1ff], pte[0xffffffc080400ff8]: 0xffffffffc0000000 -&gt; 0x0000000080405000 -------V
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>  [1f8], pte[0xffffffc080405fc0]: 0xffffffffff000000 -&gt; 0x0000000080408000 -------V
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>    [0], pte[0xffffffc080408000]: 0xffffffffff000000 -&gt; 0x0000000080407000 DA---WRV
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    [1], pte[0xffffffc080408008]: 0xffffffffff001000 -&gt; 0x0000000080409000 DA---WRV
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>    [4], pte[0xffffffc080408020]: 0xffffffffff004000 -&gt; 0x000000008040a000 DA---WRV
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>    [5], pte[0xffffffc080408028]: 0xffffffffff005000 -&gt; 0x000000008040b000 DA---WRV
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>    [8], pte[0xffffffc080408040]: 0xffffffffff008000 -&gt; 0x000000008040c000 DA---WRV
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    [9], pte[0xffffffc080408048]: 0xffffffffff009000 -&gt; 0x000000008040d000 DA---WRV
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    [c], pte[0xffffffc080408060]: 0xffffffffff00c000 -&gt; 0x000000008040e000 DA---WRV
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    [d], pte[0xffffffc080408068]: 0xffffffffff00d000 -&gt; 0x000000008040f000 DA---WRV
</code></pre></div>
<ol>
<li>Map all Direct Mapping-managed pages from <code>kernel_image_end_2M</code> to the end of physical memory, starting at <code>0xffffffc0_80400000 -&gt; 0x00000000_80400000</code>. The <code>boot-stage page allocator</code> region (<code>[0x8040_0000, 0x8060_0000)</code>) is included. </li>
</ol>
<p>Remaining space is managed by <code>kalloc.c</code>'s <code>kpgmgr</code>, excluding the boot-stage allocator region:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="w">    </span><span class="c1">// So page allocator should starts after these used pages.</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="n">kpage_allocator_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init_page_allocator</span><span class="p">;</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">    </span><span class="n">kpage_allocator_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available_mems</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">init_page_allocator</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">init_page_allocator_base</span><span class="p">);</span>
</code></pre></div>
<h3 id="kvmmap">kvmmap<a class="headerlink" href="#kvmmap" title="Permanent link">&para;</a></h3>
<p><code>kvmmap</code> constructs Sv39’s three-level page tables for <code>vaddr</code>, allocating physical pages and filling PTEs. For unallocated lower-level tables, it allocates a page from <code>allockernelpage</code> and sets the parent PTE (<code>RWX=000</code>). At the final level, it sets <code>pgtbl_level0[vpn0] = MAKE_PTE(paddr, perm)</code>.</p>
<p>For 2MiB-aligned regions, it uses a 2MiB huge page if <code>IS_ALIGNED(vaddr, PGSIZE_2M) &amp;&amp; IS_ALIGNED(paddr, PGSIZE_2M) &amp;&amp; sz &gt;= PGSIZE_2M</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kvmmap</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">PGALIGNED</span><span class="p">(</span><span class="n">va</span><span class="p">));</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">PGALIGNED</span><span class="p">(</span><span class="n">pa</span><span class="p">));</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">PGALIGNED</span><span class="p">(</span><span class="n">sz</span><span class="p">));</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">    </span><span class="n">debugf</span><span class="p">(</span><span class="s">&quot;va:%p, pa:%p, sz:%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">);</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">    </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">pgtbl_level1</span><span class="p">,</span><span class="w"> </span><span class="n">pgtbl_level0</span><span class="p">;</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">vpn2</span><span class="p">,</span><span class="w"> </span><span class="n">vpn1</span><span class="p">,</span><span class="w"> </span><span class="n">vpn0</span><span class="p">;</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">vaddr</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">va</span><span class="p">;</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">paddr</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">pa</span><span class="p">;</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">vaddr_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vaddr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sz</span><span class="p">;</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">vaddr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vaddr_end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">        </span><span class="c1">// try to add mapping: vaddr -&gt; pa</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">        </span><span class="n">vpn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">        </span><span class="n">vpn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">        </span><span class="n">vpn0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">[</span><span class="n">vpn2</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">            </span><span class="c1">// kpgtbl[vpn2] is not a valid PTE, allocate the level 1 pagetable.</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">            </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">newpg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allockernelpage</span><span class="p">();</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">            </span><span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">newpg</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">            </span><span class="n">pgtbl_level1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">newpg</span><span class="p">;</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">            </span><span class="n">kpgtbl</span><span class="p">[</span><span class="n">vpn2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">KVA_TO_PA</span><span class="p">(</span><span class="n">newpg</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">            </span><span class="n">pte_t</span><span class="w"> </span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kpgtbl</span><span class="p">[</span><span class="n">vpn2</span><span class="p">];</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="w">            </span><span class="c1">// check validity: pte must points to next level page table.</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_R</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">))</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="w">                </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kvmmap: vaddr %p already mapped at level 2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="w">            </span><span class="n">pgtbl_level1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">PA_TO_KVA</span><span class="p">(</span><span class="n">PTE2PA</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">[</span><span class="n">vpn2</span><span class="p">]));</span>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="w">            </span><span class="c1">// pgtbl_level1[vpn1] is not a valid PTE.</span>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="w">            </span><span class="c1">//   try to allocate 2M page</span>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="w">            </span><span class="c1">//   , or allocate the level 1 pagetable.</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sz</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="w">                </span><span class="c1">// it&#39;s ok for a huge page.</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="w">                </span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a><span class="w">                </span><span class="n">vaddr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">;</span>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a><span class="w">                </span><span class="n">paddr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">;</span>
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a><span class="w">                </span><span class="n">sz</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">PGSIZE_2M</span><span class="p">;</span>
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a><span class="w">            </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">newpg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allockernelpage</span><span class="p">();</span>
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a><span class="w">            </span><span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">newpg</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a><span class="w">            </span><span class="n">pgtbl_level0</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">newpg</span><span class="p">;</span>
<a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a><span class="w">            </span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">KVA_TO_PA</span><span class="p">(</span><span class="n">newpg</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a><span class="w">            </span><span class="n">pte_t</span><span class="w"> </span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">];</span>
<a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a><span class="w">            </span><span class="c1">// check validity: pte must points to next level page table.</span>
<a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_R</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">))</span>
<a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a><span class="w">                </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kvmmap: vaddr %p already mapped at level 1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a><span class="w">            </span><span class="n">pgtbl_level0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">PA_TO_KVA</span><span class="p">(</span><span class="n">PTE2PA</span><span class="p">(</span><span class="n">pgtbl_level1</span><span class="p">[</span><span class="n">vpn1</span><span class="p">]));</span>
<a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a><span class="w">        </span><span class="c1">// check validity: pte must points to next level page table.</span>
<a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgtbl_level0</span><span class="p">[</span><span class="n">vpn0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span>
<a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a><span class="w">            </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kvmmap: vaddr %p already mapped at level 0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vaddr</span><span class="p">);</span>
<a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a><span class="w">        </span><span class="n">pgtbl_level0</span><span class="p">[</span><span class="n">vpn0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_PTE</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
<a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a><span class="w">        </span><span class="n">vaddr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a><span class="w">        </span><span class="n">paddr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<a id="__codelineno-22-63" name="__codelineno-22-63" href="#__codelineno-22-63"></a><span class="w">        </span><span class="n">sz</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<a id="__codelineno-22-64" name="__codelineno-22-64" href="#__codelineno-22-64"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-65" name="__codelineno-22-65" href="#__codelineno-22-65"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">vaddr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">vaddr_end</span><span class="p">);</span>
<a id="__codelineno-22-66" name="__codelineno-22-66" href="#__codelineno-22-66"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">sz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-22-67" name="__codelineno-22-67" href="#__codelineno-22-67"></a><span class="p">}</span>
</code></pre></div>
<h2 id="kalloc-module">kalloc Module<a class="headerlink" href="#kalloc-module" title="Permanent link">&para;</a></h2>
<p><code>kalloc.c</code> manages Direct Mapping region physical pages after boot, with two functions:</p>
<ol>
<li>Physical page allocation: <code>void *__pa kallocpage()</code>, <code>void kfreepage(void *__pa pa)</code>.</li>
<li>Dynamic allocation/recycling of fixed-type objects: <code>allocator_init</code>, <code>kalloc</code>, <code>kfree</code>.</li>
</ol>
<p>After taking over remaining physical memory (purple section in the diagram), <code>kalloc</code> allocates:</p>
<ol>
<li>Memory pools for each object allocator.</li>
<li>Kernel stacks for each process.</li>
<li>Kernel stacks for each CPU scheduler.</li>
</ol>
<p>Subsequently, user-space pages and page table configuration pages are managed by <code>kalloc</code>.</p>
<h2 id="experiment-reflection-questions">Experiment Reflection Questions<a class="headerlink" href="#experiment-reflection-questions" title="Permanent link">&para;</a></h2>
<p>Note: These are not required for the classroom report.</p>
<div class="admonition warning">
<p class="admonition-title">Question</p>
<p>In <code>kernel.ld</code>, the virtual address for <code>_entry</code> is <code>0xffff_ffff_8020_0000</code>. <code>entry.S</code> uses this code to jump:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>────────────────────────────────────────────────────────────────────────── code:riscv:RISCV ────
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>●→  0x80200000 &lt;skernel+0000&gt;   auipc  sp, 0xac
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>    0x80200004 &lt;skernel+0004&gt;   mv     sp, sp
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>    0x80200008 &lt;skernel+0008&gt;   auipc  ra, 0x2
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>    0x8020000c &lt;skernel+000c&gt;   jalr   488(ra)
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>─────────────────────────────────────────────────────────────────────── source:os/entry.S+4 ────
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>    3  _entry:
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>→   4      lla sp, boot_stack_top
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    5      call bootcpu_entry
</code></pre></div>
<p>Why, when running at <code>0x0000_0000_8020_0000</code>, can <code>lla</code> load <code>boot_stack_top</code> and <code>call bootcpu_entry</code> find the correct physical address <code>0x8020_416c</code>, instead of the invalid virtual address <code>0xffff_ffff_8020_416c</code>?</p>
<p>Hint: How do we address? Recall addressing modes from computer architecture.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Page Tables and Memory Protection</p>
<p>In <code>main.c</code>’s <code>bootcpu_init</code>, before <code>infof("start scheduler!");</code>, insert:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">static</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xdeadbeefaabbccdd</span><span class="p">;</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;addr  of number: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">number</span><span class="p">);</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;value of number: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="p">);</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="o">*</span><span class="p">(</span><span class="n">uint64</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xdeadbeef00100073</span><span class="p">;</span><span class="w"> </span><span class="c1">// 00100073 is an ebreak instruction.</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;changed value of number: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="p">);</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="p">((</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="o">&amp;</span><span class="n">number</span><span class="p">)();</span><span class="w"> </span><span class="c1">// execute a function, which address is &amp;number</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="n">panic</span><span class="p">(</span><span class="s">&quot;qwq&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Run <code>make run</code>. You should encounter a Kernel Panic with Code = 12. Consult the manual to understand why.</p>
<p>Return to the <code>xv6lab3</code> directory, run <code>git reset --hard da5eb84e</code>, make the same changes, and run <code>make clean &amp;&amp; make run</code>. You’ll get a Kernel Panic with Code = 3, indicating the <code>ebreak</code> instruction executed.</p>
<p>This demonstrates memory protection via page tables at the same privilege level: it prevents unintended behavior.</p>
<p>If you change <code>number</code> to <code>const static volatile</code>, you’ll get a Code = 15 panic, as <code>const</code> places it in <code>.rodata</code> (mapped <code>R--</code>).</p>
<p>Similarly, try modifying <code>scheduler</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="o">*</span><span class="p">(</span><span class="n">uint32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00100073</span><span class="p">;</span><span class="w"> </span><span class="c1">// 00100073: ebreak</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="n">infof</span><span class="p">(</span><span class="s">&quot;start scheduler!&quot;</span><span class="p">);</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="n">scheduler</span><span class="p">();</span>
</code></pre></div>
<p>Compare the behavior across both lab repositories.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-copyright">
    <div class="md-copyright__highlight">
        commit: 
        <a href="https://github.com/yuk1i/os-next-docs/commit/d05d86f4, 2025-05-12 20:17:41+08:00" target="_blank" rel="noopener">
            d05d86f4, 2025-05-12 20:17:41+08:00
        </a>
    </div>
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>