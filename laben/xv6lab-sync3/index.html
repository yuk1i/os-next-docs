
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../xv6lab-sync2/">
      
      
        <link rel="next" href="../xv6lab-fs1/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Week 13 - Synchronization 3 - 操作系统实验文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#experiment-objectives" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-header__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            操作系统实验文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Week 13 - Synchronization 3
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../env/" class="md-tabs__link">
          
  
  实验环境搭建

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../lab/lab1/" class="md-tabs__link">
          
  
  每周实验

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab2/" class="md-tabs__link">
          
  
  Weekly Lab Material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qrh/nav/" class="md-tabs__link">
          
  
  快速参考手册

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-nav__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    操作系统实验文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    实验环境搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            实验环境搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux VM 搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Linux VM 搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/windows-vmware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + VMware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/wsl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + WSL (不推荐)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS + VMware
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    手动环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    验证环境
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    每周实验
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            每周实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 1 - Linux基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C 语言基础及Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - 裸机程序 Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - 上下文切换 Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - 内核页表 Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - 用户空间 Userspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-userprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 8 - 进程 Process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-pagefault/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 9 - 缺页异常 Page Fault
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 10 - 互斥与同步 Mutual Exclusion & Synchronization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 11 - CPU调度 CPU Scheduling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-sync2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 12 - 同步 2 Synchronization 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-sync3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 13 - 同步 3 Synchronization 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-fs1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 14 - 文件系统 1 File System 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-fs2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 15 - 文件系统 2 File System 2
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Weekly Lab Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Weekly Lab Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C language basic & Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - Trap & Interrupt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - Userspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 8 - User Process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-pagefault/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 9 - Page Fault
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 10 - Mutual Exclusion & Synchronization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 11 - CPU Scheduling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-sync2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 12 - Synchronization 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Week 13 - Synchronization 3
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Week 13 - Synchronization 3
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#experiment-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concurrent-bugs" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrent Bugs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Concurrent Bugs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deadlock" class="md-nav__link">
    <span class="md-ellipsis">
      Deadlock
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deadlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aa-deadlock" class="md-nav__link">
    <span class="md-ellipsis">
      AA-deadlock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abba-deadlock" class="md-nav__link">
    <span class="md-ellipsis">
      ABBA-deadlock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-race" class="md-nav__link">
    <span class="md-ellipsis">
      Data Race
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-mode-locks" class="md-nav__link">
    <span class="md-ellipsis">
      User-Mode Locks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="User-Mode Locks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-lost-wake-up-problem" class="md-nav__link">
    <span class="md-ellipsis">
      The Lost Wake-Up Problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#futex" class="md-nav__link">
    <span class="md-ellipsis">
      futex
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pthread_mutex_t" class="md-nav__link">
    <span class="md-ellipsis">
      pthread_mutex_t
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sync-1-2-lab-exercise-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Sync 1 &amp; 2 Lab Exercise Analysis
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-fs1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 14 - File System 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-fs2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 15 - File System 2
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    快速参考手册
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            快速参考手册
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/nav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/vf2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VisionFive2 板子教程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/ssh-vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH & VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#experiment-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concurrent-bugs" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrent Bugs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Concurrent Bugs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deadlock" class="md-nav__link">
    <span class="md-ellipsis">
      Deadlock
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deadlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aa-deadlock" class="md-nav__link">
    <span class="md-ellipsis">
      AA-deadlock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abba-deadlock" class="md-nav__link">
    <span class="md-ellipsis">
      ABBA-deadlock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-race" class="md-nav__link">
    <span class="md-ellipsis">
      Data Race
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-mode-locks" class="md-nav__link">
    <span class="md-ellipsis">
      User-Mode Locks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="User-Mode Locks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-lost-wake-up-problem" class="md-nav__link">
    <span class="md-ellipsis">
      The Lost Wake-Up Problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#futex" class="md-nav__link">
    <span class="md-ellipsis">
      futex
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pthread_mutex_t" class="md-nav__link">
    <span class="md-ellipsis">
      pthread_mutex_t
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sync-1-2-lab-exercise-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Sync 1 &amp; 2 Lab Exercise Analysis
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Week 13 - Synchronization 3</h1>

<h2 id="experiment-objectives">Experiment Objectives<a class="headerlink" href="#experiment-objectives" title="Permanent link">&para;</a></h2>
<ol>
<li>Master the causes and solutions for concurrent bugs.</li>
<li>Master the necessary conditions for deadlock.</li>
<li>Master user-mode locking mechanisms.</li>
</ol>
<h2 id="concurrent-bugs">Concurrent Bugs<a class="headerlink" href="#concurrent-bugs" title="Permanent link">&para;</a></h2>
<p>To protect resources, we need to implement locking. However, locking is a very complex and delicate operation. Therefore, we may encounter <strong>deadlock</strong> if the locking order is incorrect, or <strong>data race</strong> might still exist if the locking method is flawed. We refer to these as concurrent bugs.</p>
<h3 id="deadlock">Deadlock<a class="headerlink" href="#deadlock" title="Permanent link">&para;</a></h3>
<p>Deadlock problems are usually divided into two types: AA-deadlock and ABBA-deadlock.</p>
<h4 id="aa-deadlock">AA-deadlock<a class="headerlink" href="#aa-deadlock" title="Permanent link">&para;</a></h4>
<p>AA-deadlock means you are trying to acquire a lock that you have already acquired:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">assert</span><span class="p">(</span><span class="n">holding</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">));</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1">// ...</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="c1">// maybe in interrupt handler or other methods</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="c1">// &lt;-- deadlock here.</span>
</code></pre></div>
<p>Although it seems like we wouldn't make this mistake, real systems are often complex, and the control flow of functions may not be so obvious.</p>
<p>Imagine you are writing function <code>C()</code>, and functions <code>B</code> and <code>A</code> already exist. When <code>B</code> calls <code>A</code>, <code>A</code> acquires and releases a lock.
<code>C</code> might also need to use the same lock, so you also acquire and release the lock in <code>C</code>. Then you find that you need to reuse the functionality of <code>A</code>, so you call <code>A</code> while holding the lock.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">A</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="p">}</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kt">void</span><span class="w"> </span><span class="nf">B</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="n">A</span><span class="p">();</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="p">}</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="kt">void</span><span class="w"> </span><span class="nf">C</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="n">A</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">    </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="p">}</span>
</code></pre></div>
<p>When control flow goes from <code>B</code> to <code>A</code>, it will not deadlock. However, when it goes from <code>C</code> to <code>A</code>, it will deadlock.</p>
<p>Also, imagine another scenario where you debugged and found a concurrent bug; to solve it, you added acquire and release code in <code>A</code>; you might think only <code>B</code> will call <code>A</code>, but in reality, there exists a call chain <code>C -&gt; A</code>, and in this call chain, you already acquired the lock in <code>C</code>.</p>
<p><strong>How to solve?</strong></p>
<p>In xv6, we use defensive programming to avoid this problem:</p>
<ol>
<li>
<p>When acquiring a lock with <code>acquire</code>, check if the current CPU is already holding this lock. If so, it's an AA-deadlock, and use <code>panic("already acquired by")</code> to halt kernel execution.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// Acquire the lock.</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1">// Loops (spins) until the lock is acquired.</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">acquire</span><span class="p">(</span><span class="n">spinlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">)</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="p">{</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_ra</span><span class="p">();</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="n">push_off</span><span class="p">();</span><span class="w"> </span><span class="c1">// disable interrupts to avoid deadlock.</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">holding</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;already acquired by %p, now %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">where</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span><span class="p">);</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>For some frequently used functions, we use <code>assert(holding(&amp;lk))</code> at the entry to assert that we hold this lock upon entering the function.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1">// vm.c</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="nf">walk</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">alloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">holding</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="p">}</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="kt">int</span><span class="w"> </span><span class="nf">mm_mappages</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">holding</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="p">}</span>
</code></pre></div>
</li>
</ol>
<h4 id="abba-deadlock">ABBA-deadlock<a class="headerlink" href="#abba-deadlock" title="Permanent link">&para;</a></h4>
<p>ABBA deadlock is when thread 1 acquires locks in the order <code>A -&gt; B</code>, and thread 2 acquires locks in the order <code>B -&gt; A</code>. 
In a worst-case scenario, threads 1 and 2 each acquire A and B respectively, but then they are each waiting for B and A, and these two locks happen to be held by the other thread.</p>
<p>There are also more complex situations, such as:</p>
<ul>
<li>Thread 1 lock order: <code>A -&gt; B</code></li>
<li>Thread 2: <code>B -&gt; C</code></li>
<li>Thread 3: <code>C -&gt; A</code></li>
</ul>
<p>We can summarize the <strong>necessary conditions</strong> for deadlock, treating locks (which can be generalized to "shared resources") as a ball:</p>
<ol>
<li>Mutual Exclusion: A person gets a complete ball; it's impossible for two people to simultaneously get part of a ball.</li>
<li>Hold and wait: Holding the ball while waiting for additional balls.</li>
<li>No-Preemption: Cannot forcibly take the ball from someone else.</li>
<li>Circular wait: Forming a circular waiting relationship.</li>
</ol>
<p>(Recommended reading: <a href="https://dl.acm.org/doi/10.1145/356586.356588">https://dl.acm.org/doi/10.1145/356586.356588</a>)</p>
<blockquote>
<p>Paper original text:
This deadlock situation has arisen only
because all of the following general conditions were operative:
1) Tasks claim exclusive control of the resources they require ("mutual exclusion" condition).
2) Tasks hold resources already allocated
to them while waiting for additional resources ("wait for" condition).
3) Resources cannot be forcibly removed
from the tasks holding them until the
resources are used to completion ("no
preemption" condition).
4) A circular chain of tasks exists, such
that each task holds one or more resources that are being requested by the
next task in the chain ("circular wait"
condition).</p>
</blockquote>
<p>Since these are <strong>necessary conditions</strong>, we only need to break any one of them to avoid the deadlock problem. In large systems, the last one is clearly the easiest to break.</p>
<p>Locking order can be seen as a directed edge, and the global locking order forms a graph (dependency graph). If there is a cycle in this graph, it indicates a deadlock problem.</p>
<p>How to avoid cycles: We can number the locks (Lock Ordering) and enforce acquiring them in increasing order.</p>
<p>Additionally, we can dynamically detect deadlocks.</p>
<h3 id="data-race">Data Race<a class="headerlink" href="#data-race" title="Permanent link">&para;</a></h3>
<p>Concurrent bugs related to data races are mainly of the following two types:</p>
<ol>
<li>Acquiring the wrong lock</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">T_1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="p">);</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">T_2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">B</span><span class="p">);</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">B</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<ol>
<li>Forgetting to acquire a lock</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">T_1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="p">);</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">T_2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<h2 id="user-mode-locks">User-Mode Locks<a class="headerlink" href="#user-mode-locks" title="Permanent link">&para;</a></h2>
<h3 id="the-lost-wake-up-problem">The Lost Wake-Up Problem<a class="headerlink" href="#the-lost-wake-up-problem" title="Permanent link">&para;</a></h3>
<p>In previous lessons, we discussed concurrency and synchronization code in kernel mode. So, how are mutual exclusion and synchronization implemented in user mode?</p>
<div class="admonition info">
<p class="admonition-title">Shared Memory</p>
<p>The descriptions in this sub-section are based on the shared memory model. In Linux, these can be created using <code>mmap(2)</code> and <code>shm(2)</code>.</p>
<p>In xv6, our process model does not yet support shared memory, but the core idea is the same.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Differences between User Mode and Kernel</p>
<p>When we discuss concurrency, the most significant difference between user mode (usermode) and kernel mode (kernel) is that the kernel can mask interrupts, while user programs cannot.</p>
</div>
<p>In user mode, we can still use atomic instructions to implement <code>spinlock</code>. However, for <code>sleeplock</code>, things become more complex.</p>
<p><code>sleeplock</code> requires the process to sleep when it cannot acquire the lock and be woken up when the lock is released. This means we need system calls to perform the "sleep" and "wakeup" actions, because only the kernel can change a process's state.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sleeplock_acquire</span><span class="p">(</span><span class="n">sleeplock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nl">retry</span><span class="p">:</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__sync_lock_test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">        </span><span class="c1">// we succeed in 0-to-1 transition, aka, we get the lock.</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">        </span><span class="c1">// we fail to get the lock, sleep myself.</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">mypid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getpid</span><span class="p">();</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">        </span><span class="c1">// append myself to the waiter queue.</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">        </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">waiters_lock</span><span class="p">);</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">        </span><span class="n">append_waiter</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span><span class="w"> </span><span class="n">mypid</span><span class="p">);</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">        </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">waiters_lock</span><span class="p">);</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">        </span><span class="c1">// &lt;-- this process may be wakeup here.</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">        </span><span class="n">syscall_sleep</span><span class="p">();</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">        </span><span class="c1">// &lt;-- then we will never be woken-up.</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="p">}</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sleeplock_release</span><span class="p">(</span><span class="n">sleeplock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="w">    </span><span class="c1">// A.</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="w">    </span><span class="n">__sync_lock_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">);</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w">    </span><span class="c1">// B.</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w">    </span><span class="c1">// find the next one to wakeup.</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w">    </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">waiters_lock</span><span class="p">);</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nextone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pop_waiter</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">    </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">waiters_lock</span><span class="p">);</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="w">    </span><span class="c1">// C.</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="w">    </span><span class="n">syscall_wakeup</span><span class="p">(</span><span class="n">nextone</span><span class="p">);</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="p">}</span>
</code></pre></div>
<p>Then, we will encounter the same "The Lost Wake-Up Problem" discussed in the Sync 1 lecture, where <code>syscall_sleep</code> might cause the wakeup signal to be lost.</p>
<p>The simplest correct approach is to place all locking and unlocking operations in the kernel. However, system calls are quite time-consuming, so we expect to keep the fast-path in user space. For <code>sleeplock</code>, the fast-path is when there is no contention for the lock, requiring only one atomic instruction to mark the lock as held.</p>
<h3 id="futex">futex<a class="headerlink" href="#futex" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please execute man 7 futex and man 2 futex in a Linux environment to view the relevant documentation.</p>
</div>
<p>futex is a syscall provided by the Linux kernel, used to implement fast user-space mutexes. Its definition is as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kt">long</span><span class="w"> </span><span class="nf">syscall</span><span class="p">(</span><span class="n">SYS_futex</span><span class="p">,</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">uaddr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">futex_op</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">val</span><span class="p">,</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">timeout</span><span class="p">,</span><span class="w">   </span><span class="cm">/* or: uint32_t val2 */</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">uaddr2</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">val3</span><span class="p">);</span>
</code></pre></div>
<p>It accepts a virtual address <code>uaddr</code>, the user's expected value <code>val</code>, and the futex operation <code>futex_op</code>.
futex distinguishes different futex objects based on the physical address behind the virtual address. Therefore, for <code>shm</code> across processes, as long as their respective virtual addresses map to the same physical address, they can achieve synchronization through futex.</p>
<p>The two most important ops are:</p>
<ol>
<li>
<p><code>FUTEX_WAIT</code>: If the value at <code>uaddr</code> matches <code>val</code>, the thread sleeps, waiting for a <code>FUTEX_WAKE</code> operation on the futex word. If the kernel detects that the value at <code>uaddr</code> does not match the user's expected <code>val</code> (indicating a change in the context since the user called the <code>futex</code> syscall), it immediately returns <code>EAGAIN</code> from the system call without sleeping. (This avoids the lost-wakeup problem.)</p>
<p>The kernel also uses atomic instructions to access the physical address behind the virtual address, ensuring atomicity.</p>
<p>This operation tests that the value at the futex word pointed to by the address <code>uaddr</code> still contains the expected value <code>val</code>, and if so, then sleeps waiting for a <code>FUTEX_WAKE</code> operation on the futex word.</p>
<p>If the thread starts to sleep, it is considered a waiter on this futex word.
<strong>If the futex value does not match val, then the call fails immediately with the error EAGAIN.</strong></p>
<p>The purpose of the comparison with the expected value is to prevent lost wake-ups.
If another thread changed the value of the futex word after the calling thread decided to block based on the prior value, and if the other thread executed a <code>FUTEX_WAKE</code> operation after the value change and before this <code>FUTEX_WAIT</code> operation, then the calling thread will observe the value change and will not start to sleep.</p>
</li>
<li>
<p><code>FUTEX_WAKE</code>: Wake up all waiters waiting on <code>uaddr</code> .</p>
<p>This operation wakes at most <code>val</code> of the waiters that are waiting (e.g., inside <code>FUTEX_WAIT</code>) on the futex word at the addresslevellock 的。
 <code>uaddr</code>.  Most commonly, val is specified as either 1 (wake up a single waiter) or <code>INT_MAX</code> (wake up all waiters).</p>
</li>
</ol>
<h3 id="pthread_mutex_t">pthread_mutex_t<a class="headerlink" href="#pthread_mutex_t" title="Permanent link">&para;</a></h3>
<p><code>pthread_mutex_t</code> is provided by the pthread library in libc, and it uses the futex syscall to implement <strong>mutex</strong> functionality.</p>
<p>We can explore how <code>pthread_mutex_t</code> is implemented:</p>
<div class="admonition info">
<p class="admonition-title">glibc Source Code</p>
<p>glibc source code is very complex and highly optimized for performance.</p>
<p>This part of the code is located in <code>nptl/lowlevellock.c</code> and <code>sysdeps/nptl/lowlevellock.h</code>.</p>
<p>The basic functionality of <code>pthread_mutex_t</code> relies on <code>lll</code> lowlevellock.</p>
</div>
<p><code>pthread_mutex_t</code> has a <code>uint32_t</code> which represents the lock state: 0 means unlocked, 1 means locked but no waiters, and <code>&gt;1</code> means locked but potentially with waiters.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">lll_lock</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="w"> </span><span class="n">futex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="c1">// try to make futex transit from 0 (UNLOCKED) to 1 (LOCKED).</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomic_compare_and_exchange_bool_acq</span><span class="p">(</span><span class="n">futex</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">        </span><span class="c1">// if cmpxhg fails:</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">        </span><span class="c1">// try to exchange 2 into `*futex`, return the original value.</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomic_exchange_acquire</span><span class="w"> </span><span class="p">(</span><span class="n">futex</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">            </span><span class="c1">// if old value is not `UNLOCKED`</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">            </span><span class="n">syscall_futex</span><span class="p">(</span><span class="n">futex</span><span class="p">,</span><span class="w"> </span><span class="n">FUTEX_WAIT</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Wait if *futex == 2.  */</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">            </span><span class="c1">// if syscall returns, *futex is not 2 or someone wakes me up.</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">        </span><span class="c1">// when we get there, old *futex is 0, now 2 (LOCKED).</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span><span class="c1">// succeed, LOCKED (*futex is 1 or 2)</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="p">}</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="kt">void</span><span class="w"> </span><span class="nf">lll_unlock</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="w"> </span><span class="n">futex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">    </span><span class="c1">// exchange 0 UNLOCKED into futex</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">__oldval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_exchange_release</span><span class="w"> </span><span class="p">(</span><span class="n">futex</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__oldval</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">        </span><span class="c1">// wake up one waiter</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">        </span><span class="n">syscall_futex</span><span class="p">(</span><span class="n">futex</span><span class="p">,</span><span class="w"> </span><span class="n">FUTEX_WAKE</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="p">}</span>
</code></pre></div>
<p>Locking steps:</p>
<ol>
<li>First, try to transition futex from <code>0-&gt;1</code>. If this fails, it means another thread holds the lock.</li>
<li>Then, continuously loop attempting to transition futex from <code>0-&gt;2</code>. If successful, the lock is acquired.</li>
<li>Otherwise, wait on <code>futex</code> using the <code>futex_wait</code> system call. When returning from the syscall, retry step 2.</li>
</ol>
<p>Unlocking steps:</p>
<ol>
<li>Write 0 to futex. If the old value was greater than 1, use the <code>futex</code> syscall to wake up one waiter.</li>
</ol>
<p>You can try to prove that this lock will never have a lost wakeup. Note that in user mode, every execution step can be interrupted and interleaved with steps from other functions.</p>
<p>For example, the following diagrams illustrate the process of T1 and T2 contending for the lock:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>        T1          T2
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>        |            |
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    lock (0-&gt;1, ok)          |
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>      (acquired)             |
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        |       lock (0-&gt;1, fail)
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>unlock(store 0, see 1)       |
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        |       lock (0-&gt;2, ok)
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        |            |
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    (released)      (acquired)
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>        T1          T2
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>        |            |
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    lock (0-&gt;1, ok)          |
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>      (acquired)        lock (0-&gt;1, fail)
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        |       lock (0-&gt;2, fail)
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>        |         futex_wait()
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>unlock(store 0, see 2)       |
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>    futex_wake()        (woken-up)
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>        |       lock (0-&gt;2, ok)
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>    (released)           |
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>                  (acquired)
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>        T1          T2
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        |            |
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>    lock (0-&gt;1, ok)          |
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>      (acquired)             |
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>        |       lock (0-&gt;1, fail)
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>        |       lock (0-&gt;2, fail)
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>unlock(store 0, see 2)       |
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>        |         futex_wait()
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>    futex_wake()     (EAGAIN, kernel sees 0)
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>        |            |
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>    (released)      lock (0-&gt;2, ok)
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>                     |
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>                  (acquired)
</code></pre></div>
<p>You can try to complete the following diagram:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>        T1          T2          T3
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>        |            |           |
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    lock (0-&gt;1, ok)          |       lock (0-&gt;1, fail)
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>      (acquired)             |       lock (0-&gt;2, fail)
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        |            |         futex_wait()
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        |       lock (0-&gt;1, fail)        |
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        |       lock (0-&gt;2, fail)        |
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>        |            |           |
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>unlock(store 0, see 2)       |           |
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        |         futex_wait()           |
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    futex_wake()     (EAGAIN, kernel sees 0)         |
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        |                       (woken-up)
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    (released)
</code></pre></div>
<h2 id="sync-1-2-lab-exercise-analysis">Sync 1 &amp; 2 Lab Exercise Analysis<a class="headerlink" href="#sync-1-2-lab-exercise-analysis" title="Permanent link">&para;</a></h2>
<p>Will be discussed in class.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-copyright">
    <div class="md-copyright__highlight">
        commit: 
        <a href="https://github.com/yuk1i/os-next-docs/commit/085f1381, 2025-05-27 14:23:57+08:00" target="_blank" rel="noopener">
            085f1381, 2025-05-27 14:23:57+08:00
        </a>
    </div>
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>