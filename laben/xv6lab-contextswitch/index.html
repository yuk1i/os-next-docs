
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../xv6lab-interrupts/">
      
      
        <link rel="next" href="../xv6lab-paging/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Week 5 - Context Switch - 操作系统实验文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#context-switch" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-header__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            操作系统实验文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Week 5 - Context Switch
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../env/" class="md-tabs__link">
          
  
  实验环境搭建

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../lab/lab1/" class="md-tabs__link">
          
  
  每周实验

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab2/" class="md-tabs__link">
          
  
  Weekly Lab Material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qrh/nav/" class="md-tabs__link">
          
  
  快速参考手册

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://teecertlabs.com/" title="操作系统实验文档" class="md-nav__button md-logo" aria-label="操作系统实验文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    操作系统实验文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/yuk1i/os-next-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    os-next-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    实验环境搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            实验环境搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux VM 搭建
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Linux VM 搭建
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/windows-vmware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + VMware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/wsl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows + WSL (不推荐)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vm/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS + VMware
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    手动环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    验证环境
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    每周实验
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            每周实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 1 - Linux基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C 语言基础及Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - 裸机程序 Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - 陷入与中断 Trap & Interrupts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-contextswitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 5 - 上下文切换 Context Switch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - 内核页表 Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lab/xv6lab-userspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - 用户空间 Userspace
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Weekly Lab Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Weekly Lab Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 - C language basic & Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-baremetal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 3 - Bare Metal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-interrupts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 4 - Trap & Interrupt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Week 5 - Context Switch
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Week 5 - Context Switch
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#experiment-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experimental-scenario" class="md-nav__link">
    <span class="md-ellipsis">
      Experimental Scenario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Experimental Scenario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init" class="md-nav__link">
    <span class="md-ellipsis">
      init()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-context" class="md-nav__link">
    <span class="md-ellipsis">
      What is Context?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is Context?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-context-switching" class="md-nav__link">
    <span class="md-ellipsis">
      Why Context Switching?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-does-context-switching-occur" class="md-nav__link">
    <span class="md-ellipsis">
      When Does Context Switching Occur?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6-process" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 Process
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6 Process">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-cpu" class="md-nav__link">
    <span class="md-ellipsis">
      struct cpu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Process Initialization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6-context-switch" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 Context Switch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6 Context Switch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lab-exercise-1" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Exercise 1
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 Scheduler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6 Scheduler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sched-function" class="md-nav__link">
    <span class="md-ellipsis">
      sched Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-first-process-init" class="md-nav__link">
    <span class="md-ellipsis">
      The First Process - init
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The First Process - init">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      First Scheduling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-flowchart-for-first-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      Execution Flowchart for First Scheduling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lab-exercise-2" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Exercise 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker" class="md-nav__link">
    <span class="md-ellipsis">
      worker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reading" class="md-nav__link">
    <span class="md-ellipsis">
      Reading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disabling-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Disabling Interrupts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-save-cpu-interrupt_on" class="md-nav__link">
    <span class="md-ellipsis">
      Why Save cpu-&gt;interrupt_on?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 6 - Kernel Paging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xv6lab-userspace.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 7 - Userspace
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    快速参考手册
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            快速参考手册
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/nav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/vf2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VisionFive2 板子教程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../qrh/ssh-vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSH & VSCode 远程配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#experiment-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Experiment Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experimental-scenario" class="md-nav__link">
    <span class="md-ellipsis">
      Experimental Scenario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Experimental Scenario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init" class="md-nav__link">
    <span class="md-ellipsis">
      init()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-context" class="md-nav__link">
    <span class="md-ellipsis">
      What is Context?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is Context?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-context-switching" class="md-nav__link">
    <span class="md-ellipsis">
      Why Context Switching?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-does-context-switching-occur" class="md-nav__link">
    <span class="md-ellipsis">
      When Does Context Switching Occur?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6-process" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 Process
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6 Process">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#struct-cpu" class="md-nav__link">
    <span class="md-ellipsis">
      struct cpu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Process Initialization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6-context-switch" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 Context Switch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6 Context Switch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lab-exercise-1" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Exercise 1
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xv6-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      xv6 Scheduler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6 Scheduler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sched-function" class="md-nav__link">
    <span class="md-ellipsis">
      sched Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-first-process-init" class="md-nav__link">
    <span class="md-ellipsis">
      The First Process - init
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The First Process - init">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      First Scheduling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-flowchart-for-first-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      Execution Flowchart for First Scheduling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lab-exercise-2" class="md-nav__link">
    <span class="md-ellipsis">
      Lab Exercise 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker" class="md-nav__link">
    <span class="md-ellipsis">
      worker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reading" class="md-nav__link">
    <span class="md-ellipsis">
      Reading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disabling-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Disabling Interrupts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-save-cpu-interrupt_on" class="md-nav__link">
    <span class="md-ellipsis">
      Why Save cpu-&gt;interrupt_on?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="context-switch">Context Switch<a class="headerlink" href="#context-switch" title="Permanent link">&para;</a></h1>
<h2 id="experiment-objectives">Experiment Objectives<a class="headerlink" href="#experiment-objectives" title="Permanent link">&para;</a></h2>
<ol>
<li>Understand process management.</li>
<li>Understand context switching.</li>
<li>Master the process of multi-core process switching in xv6.</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">xv6-lab3 Code Branch</p>
<p><a href="https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab3">https://github.com/yuk1i/SUSTech-OS-2025/tree/xv6-lab3</a></p>
<p>Use the command <code>git clone https://github.com/yuk1i/SUSTech-OS-2025 -b xv6-lab3 xv6lab3</code> to download the xv6-lab3 code.</p>
<p>Run the kernel for this lab with <code>make runsmp</code> <strong>using multiple cores (4)</strong>. You should see the following output:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Boot another cpus.
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>...
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>System has 4 cpus online
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>...
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>kthread: all threads exited, count 6288388
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>[INFO  1,1] init: kthread: init ends!
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>[PANIC 1,1] os/proc.c:225: init process exited
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>[PANIC 0,-1] os/trap.c:41: other CPU has panicked
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>[PANIC 2,-1] os/trap.c:41: other CPU has panicked
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>[PANIC 3,-1] os/trap.c:41: other CPU has panicked
</code></pre></div>
</div>
<p>Context switching is a fundamental concept in operating systems. This chapter focuses on the technical implementation of context switching and the design of the scheduler in xv6.</p>
<h2 id="experimental-scenario">Experimental Scenario<a class="headerlink" href="#experimental-scenario" title="Permanent link">&para;</a></h2>
<p>In this experiment, we will run the xv6 operating system on a RISC-V CPU with 4 cores.</p>
<p>Upon system startup, we create and execute the <code>init</code> process. The <code>init</code> process spawns 8 kernel threads called <code>worker</code> and places them into the scheduling queue. Subsequently, the 4 cores take turns running these 8 <code>worker</code> threads until they exit. The parent <code>init</code> process waits for all 8 child threads to complete before terminating.</p>
<p>The experimental scenario revolves around the scheduling and switching of these 9 threads. Below are the execution details of <code>init</code> and <code>worker</code>. In later sections, we will step through the knowledge points and specific workflows involved in process switching.</p>
<h3 id="init">init()<a class="headerlink" href="#init" title="Permanent link">&para;</a></h3>
<blockquote>
<p>code: nommu_init.c</p>
</blockquote>
<p>The <code>init</code> process executes the <code>init</code> function, which creates 8 kernel threads, all running the <code>worker</code> function. These 8 kernel threads increment a shared variable <code>count</code>, calling <code>yield</code> every 1000 increments.</p>
<p>The <code>init</code> function calls <code>wait</code> to wait for all created kernel threads to exit, then prints the final value of the shared variable <code>count</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="cp">#define NTHREAD 8</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="k">volatile</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kt">void</span><span class="w"> </span><span class="nf">worker</span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">        </span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">            </span><span class="n">infof</span><span class="p">(</span><span class="s">&quot;thread %d: count %d, yielding&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">            </span><span class="n">yield</span><span class="p">();</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">114514</span><span class="p">);</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="p">}</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">    </span><span class="n">infof</span><span class="p">(</span><span class="s">&quot;kthread: init starts!&quot;</span><span class="p">);</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pids</span><span class="p">[</span><span class="n">NTHREAD</span><span class="p">];</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NTHREAD</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">        </span><span class="n">pids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_kthread</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">retcode</span><span class="p">;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NTHREAD</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait</span><span class="p">(</span><span class="n">pids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">retcode</span><span class="p">);</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="w">        </span><span class="n">infof</span><span class="p">(</span><span class="s">&quot;thread %d exited with code %d, expected %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">retcode</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">114514</span><span class="p">);</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;kthread: all threads exited, count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">    </span><span class="n">infof</span><span class="p">(</span><span class="s">&quot;kthread: init ends!&quot;</span><span class="p">);</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="p">}</span>
</code></pre></div>
<h2 id="what-is-context">What is Context?<a class="headerlink" href="#what-is-context" title="Permanent link">&para;</a></h2>
<p>In operating systems, a <strong>context</strong> refers to the complete set of state information required for a program to run at a given moment. In xv6, we define each process as an independent schedulable entity, meaning every process has its own context.</p>
<p>Understanding context is crucial because when the operating system needs to switch between processes, it must save the current process’s context and load the context of the process to be executed next. This ensures that the process can resume execution from its previous state when it regains CPU control. The process of saving and restoring context is the core of <strong>context switching</strong>.</p>
<p>Imagine reading a book and needing to pause to do something else. You might use a bookmark to mark your place—this bookmark represents your "reading context." When you return, the bookmark tells you where to resume. Similarly, in an operating system, context serves this purpose, though the information it saves and restores is far more complex.</p>
<h3 id="why-context-switching">Why Context Switching?<a class="headerlink" href="#why-context-switching" title="Permanent link">&para;</a></h3>
<p>From a scheduling perspective, context switching is a key mechanism for enabling multitasking and resource multiplexing:</p>
<ol>
<li>
<p><strong>Time-Division Multiplexing of CPU Resources</strong></p>
<p>When multiple ready processes need to run, the operating system must allow them to take turns using the CPU. Even with a single CPU, time-sharing multiplexing enables processes to appear to run concurrently by executing them in turns. The scheduler decides which process to run at any given moment based on policies like Round Robin or Priority Scheduling. Context switching is required to transition to the scheduled process.</p>
</li>
<li>
<p><strong>Improving System Throughput</strong></p>
<p>When a process blocks due to an I/O operation, the CPU becomes idle. Context switching allows the scheduler to switch to another ready process, enabling the CPU to perform other tasks while waiting for I/O, thus improving resource utilization and system throughput.</p>
</li>
<li>
<p><strong>Responsiveness for Interactive Tasks</strong></p>
<p>Interactive programs require timely responses. Context switching allows the scheduler to pause a running batch job and quickly switch to an interactive task needing immediate attention, enhancing user experience.</p>
</li>
</ol>
<h3 id="when-does-context-switching-occur">When Does Context Switching Occur?<a class="headerlink" href="#when-does-context-switching-occur" title="Permanent link">&para;</a></h3>
<p>Context switching typically occurs in the following situations:</p>
<ol>
<li>
<p><strong>Time Slice Expiration</strong></p>
<p>In time-slice-based round-robin scheduling, when a process exhausts its allocated time slice, a clock interrupt triggers, and the operating system forcibly performs a context switch to another ready process.</p>
</li>
<li>
<p><strong>Process Blocking</strong></p>
<p>A process may initiate a system call to wait for I/O, wait for an event (e.g., a semaphore), or request a resource that isn’t immediately available. </p>
<p>In such cases, the process voluntarily relinquishes the CPU, and the scheduler selects another ready process to run.</p>
</li>
<li>
<p><strong>Voluntary Yield</strong></p>
<p>A process calls the <code>yield</code> system call to voluntarily give up its remaining time slice, typically when it senses it has no immediate work to do.</p>
</li>
</ol>
<h2 id="xv6-process">xv6 Process<a class="headerlink" href="#xv6-process" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">Process, Thread, and Kernel Thread</p>
<p>A <strong>process</strong> is an instance of a program, with its own independent address space, memory, file descriptors, and other resources.
 A <strong>thread</strong> is an execution unit within a process and the basic unit of CPU scheduling. Threads have their own stack and register state, while threads within the same process share the process’s address space and most resources. Typically, a process can contain multiple threads.</p>
<p>In this course, xv6 simplifies its implementation with the following rules:</p>
<ol>
<li>Each process has exactly one thread. Thus, in xv6, a process is the basic unit of CPU scheduling.</li>
<li>Each user process has two execution environments: a user-mode (U-mode) environment and a kernel-mode (S-mode) environment, the latter called a <strong>kernel thread</strong>.</li>
</ol>
<p>In this lab, we have not yet introduced user mode, so each process consists solely of a kernel thread. User space will be covered in labs a few weeks from now.</p>
</div>
<blockquote>
<p>Related code: <code>os/proc.h</code>, <code>os/sched.c</code>, <code>os/smp.c</code></p>
</blockquote>
<p>In xv6, the <strong>Process Control Block (PCB)</strong> is defined as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">enum</span><span class="w"> </span><span class="n">procstate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">UNUSED</span><span class="p">,</span><span class="w"> </span><span class="n">USED</span><span class="p">,</span><span class="w"> </span><span class="n">SLEEPING</span><span class="p">,</span><span class="w"> </span><span class="n">RUNNABLE</span><span class="p">,</span><span class="w"> </span><span class="n">RUNNING</span><span class="p">,</span><span class="w"> </span><span class="n">ZOMBIE</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="c1">// p-&gt;lock must be held when accessing these fields:</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">procstate</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">  </span><span class="c1">// Process state</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w">               </span><span class="c1">// Process ID</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">exit_code</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sleep_chan</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">killed</span><span class="p">;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">    </span><span class="c1">// Parent process</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">__kva</span><span class="w"> </span><span class="n">kstack</span><span class="p">;</span><span class="w">    </span><span class="c1">// Virtual address of kernel stack</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="n">context</span><span class="p">;</span><span class="w"> </span><span class="c1">// swtch() here to run process</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="c1">// Userspace: User Memory Management, not covered in today&#39;s lab</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma</span><span class="w"> </span><span class="o">*</span><span class="n">vma_brk</span><span class="p">;</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">__kva</span><span class="w"> </span><span class="n">trapframe</span><span class="p">;</span><span class="w">  </span><span class="c1">// data page for trampoline.S</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="p">};</span>
</code></pre></div>
<p>Each process has its own PID, process state, parent pointer, kernel stack, and kernel context.</p>
<p>For processes with user mode (not yet implemented in this lab’s code), the PCB includes a <code>struct mm</code> for memory management and a <code>trapframe</code> to store data when a trap occurs in user mode.</p>
<p>Additionally, each process has a <code>spinlock_t</code> spinlock. Although we haven’t covered locks and concurrency in theory yet, xv6 mandates that all accesses to <code>struct proc</code> members occur while holding <code>p-&gt;lock</code>.</p>
<div class="admonition info">
<p class="admonition-title">What is a Lock?</p>
<p>A <strong>lock</strong> is a basic tool for controlling concurrent access.</p>
<p>We stipulate that when holding a spinlock: 1. The CPU cannot be interrupted, and 2. Other CPUs cannot hold the same lock simultaneously.</p>
<p>We use the <code>acquire</code> and <code>release</code> primitives to denote locking and unlocking actions.</p>
<p>If a lock cannot be acquired with <code>acquire</code>, the CPU spins in place until the lock becomes available.</p>
</div>
<h3 id="struct-cpu"><code>struct cpu</code><a class="headerlink" href="#struct-cpu" title="Permanent link">&para;</a></h3>
<p>In xv6, we use <code>struct cpu</code> to describe the state of each CPU, and the <code>mycpu()</code> function retrieves the current CPU object.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">cpu</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mhart_id</span><span class="p">;</span><span class="w">                  </span><span class="c1">// mhartid for this cpu, passed by OpenSBI</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">;</span><span class="w">             </span><span class="c1">// current process</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="n">sched_context</span><span class="p">;</span><span class="w">  </span><span class="c1">// scheduler context, swtch() here to run scheduler</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inkernel_trap</span><span class="p">;</span><span class="w">             </span><span class="c1">// whether we are in a kernel trap context</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">noff</span><span class="p">;</span><span class="w">                      </span><span class="c1">// how many push-off</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">interrupt_on</span><span class="p">;</span><span class="w">              </span><span class="c1">// Is the interrupt enabled before the first push-off?</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">sched_kstack_top</span><span class="p">;</span><span class="w">       </span><span class="c1">// top of per-CPU scheduler kernel stack</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cpuid</span><span class="p">;</span><span class="w">                     </span><span class="c1">// for debug purposes</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="p">};</span>
</code></pre></div>
<h3 id="process-initialization">Process Initialization<a class="headerlink" href="#process-initialization" title="Permanent link">&para;</a></h3>
<p>To simplify implementation, xv6 limits the maximum number of processes to a fixed value of 512 and uses a pointer array to index all processes.</p>
<p>At system boot, xv6 calls <code>proc_init</code> to initialize process-related resources. This function first initializes the spinlocks required by the process module and the <code>proc_allocator</code> pool for <code>struct proc</code>. It then initializes 512 processes, each allocated a <code>struct proc*</code> PCB from <code>proc_allocator</code>, zeroed out with <code>memset</code>, and assigned a kernel stack <code>kstack</code>.</p>
<div class="admonition info">
<p class="admonition-title">kalloc</p>
<p>The <code>kalloc.c</code> module handles the following:</p>
<ol>
<li>Allocate and free a 4KiB page: <code>kallocpage</code>, <code>kfreepage</code>.</li>
<li>Allocate and free fixed-size objects: <code>allocator_init</code>, <code>kalloc</code>, <code>kfree</code>.</li>
</ol>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">[</span><span class="n">NPROC</span><span class="p">];</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="c1">// Initialize the proc table at boot time.</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">proc_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="c1">// We only init once.</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">proc_inited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">proc_inited</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="n">proc_inited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span><span class="n">spinlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid_lock</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pid&quot;</span><span class="p">);</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="n">spinlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait_lock</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wait&quot;</span><span class="p">);</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">    </span><span class="n">allocator_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc_allocator</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;proc&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="p">),</span><span class="w"> </span><span class="n">NPROC</span><span class="p">);</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NPROC</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc_allocator</span><span class="p">);</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">        </span><span class="n">spinlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;proc&quot;</span><span class="p">);</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNUSED</span><span class="p">;</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">kallocpage</span><span class="p">();</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="p">);</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="w">        </span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">    </span><span class="n">sched_init</span><span class="p">();</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="p">}</span>
</code></pre></div>
<p>When a PCB is needed, <code>allocproc</code> searches the <code>pool</code> for an unallocated process, performs final initialization, and returns it. We’ll explain how xv6 initializes a process’s context later.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">// Look in the process table for an UNUSED proc.</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1">// If found, initialize state required to run in the kernel.</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="c1">// If there are no free procs, or a memory allocation fails, return 0.</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">allocproc</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="c1">// Find an UNUSED proc</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NPROC</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">        </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UNUSED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">found</span><span class="p">;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">        </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="nl">found</span><span class="p">:</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">    </span><span class="c1">// Initialize a proc</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">    </span><span class="n">tracef</span><span class="p">(</span><span class="s">&quot;init proc %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">allocpid</span><span class="p">();</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">USED</span><span class="p">;</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">killed</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sleep_chan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_code</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">    </span><span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">init_proc</span><span class="p">)</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w">        </span><span class="n">init_proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">holding</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a><span class="p">}</span>
</code></pre></div>
<h2 id="xv6-context-switch">xv6 Context Switch<a class="headerlink" href="#xv6-context-switch" title="Permanent link">&para;</a></h2>
<p>For a program, its visible and modifiable state consists of all its registers and memory space. In kernel space, all kernel threads share the same memory space (unlike user processes, which have distinct memory spaces). Thus, for kernel processes, we only need to save their register states. In xv6, we define a process’s <strong>kernel context</strong> as the following structure:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">// Saved registers for kernel context switches.</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">ra</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="c1">// Callee-saved</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s0</span><span class="p">;</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s2</span><span class="p">;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s3</span><span class="p">;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s4</span><span class="p">;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s5</span><span class="p">;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s6</span><span class="p">;</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s7</span><span class="p">;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s8</span><span class="p">;</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s9</span><span class="p">;</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s10</span><span class="p">;</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s11</span><span class="p">;</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="p">};</span>
</code></pre></div>
<p>In the <code>switch.S</code> file, we define the "function" <code>swtch</code> with the prototype <code>void swtch(struct context *old, struct context *new)</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Context switch</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1">#   void swtch(struct context *old, struct context *new);</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c1"># Save current registers in old. Load from new.</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="na">.globl</span><span class="w"> </span><span class="no">swtch</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="nl">swtch:</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">ra</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s1</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s4</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s6</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="mi">72</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s8</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="mi">88</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s10</span><span class="p">,</span><span class="w"> </span><span class="mi">96</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="mi">104</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">ra</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s1</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s4</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s6</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="mi">72</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s8</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="mi">88</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s10</span><span class="p">,</span><span class="w"> </span><span class="mi">96</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="mi">104</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a><span class="w">    </span><span class="nf">ret</span>
</code></pre></div>
<p>When performing a context switch, we call the <code>swtch</code> function with two <code>struct context*</code> pointers: one indicating where the current context should be saved (<code>old</code>) and another indicating where execution should resume from (<code>new</code>).</p>
<p>Since we’re calling <code>swtch</code> from C, the compiler adheres to the RISC-V Calling Convention, setting up the environment accordingly. For example, the return address is written to the <code>ra</code> register, and some registers are saved on the stack.</p>
<p>Per the RISC-V Calling Convention, registers are divided into <strong>caller-saved</strong> and <strong>callee-saved</strong>. For caller-saved registers, the caller must save them if their values need to persist across the call; the callee can modify them freely. For callee-saved registers, the caller assumes they remain unchanged, and the callee must save and restore them if used. These registers are typically saved on the stack frame (handled automatically by the compiler).</p>
<p>Thus, <code>swtch</code> only needs to save <code>sp</code>, <code>ra</code>, and all callee-saved registers (<code>s0-s11</code>) into the <code>old</code> structure to preserve the caller’s execution state. Conversely, restoring from <code>new</code> involves loading these registers.</p>
<p><img alt="alt text" src="../../assets/xv6lab-contextswitch/riscv-cc.png" /></p>
<p>The diagram below illustrates the switch from P1 to P2, where P1 and P2 each have their own stack and context structure.</p>
<p><img alt="alt text" src="../../assets/xv6lab-contextswitch/xv6lab-context-swtchfunc.png" /></p>
<p>When P1 executes its function, the prologue saves the caller’s return address and allocates stack space for local variables. Before calling <code>swtch</code>, the compiler saves all caller-saved registers onto the stack and generates a <code>jal swtch</code> instruction, which sets <code>ra</code> to the next instruction in P1 (commonly <code>pc+4</code>).</p>
<p>During the <code>swtch</code> call, <code>a0</code> points to P1’s <code>struct context</code>. The <code>swtch</code> function uses <code>sd</code> instructions to save <code>ra</code>, <code>sp</code>, and <code>s0-s11</code> into this structure.</p>
<p>Next, <code>swtch</code> loads P2’s context from <code>a1</code> using <code>ld</code> instructions, restoring <code>ra</code>, <code>sp</code>, and <code>s0-s11</code> from P2’s <code>struct context</code>.</p>
<p>When the CPU executes <code>ret</code>, the program counter (<code>pc</code>) is set to the value of <code>ra</code>, resuming execution at the address saved from P2’s last <code>swtch</code> call.</p>
<p>This completes the switch from P1 to P2. (Note: P1 and P2 here represent arbitrary programs, not necessarily OS processes.)</p>
<p>Additionally, <code>swtch</code> operates in pairs: if a process exits via <code>swtch</code>, its next return must result from another process calling <code>swtch</code> to switch back.</p>
<h3 id="lab-exercise-1">Lab Exercise 1<a class="headerlink" href="#lab-exercise-1" title="Permanent link">&para;</a></h3>
<p>Understand the <code>swtch</code> function at the assembly level.</p>
<p>Assume you have two <code>struct context</code> structures, <code>ctx_a</code> and <code>ctx_b</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="n">ctx_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="p">.</span><span class="n">ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="p">.</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="p">};</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="n">ctx_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="p">.</span><span class="n">ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x802dead0</span><span class="p">,</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="p">.</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7fffB000</span><span class="p">,</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="p">};</span>
</code></pre></div>
<p>Suppose you are executing <code>swtch(&amp;ctx_a, &amp;ctx_b)</code>. The corresponding assembly code and surrounding instructions are as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">// a0: address of ctx_a, a1: address of ctx_b</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="err">80205720:</span><span class="w">   </span><span class="err">05848593</span><span class="w">            </span><span class="nf">addi</span><span class="w">    </span><span class="no">a1</span><span class="p">,</span><span class="no">s1</span><span class="p">,</span><span class="mi">88</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="err">80205724:</span><span class="w">   </span><span class="err">00002097</span><span class="w">            </span><span class="nf">auipc</span><span class="w">   </span><span class="no">ra</span><span class="p">,</span><span class="mi">0x2</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="err">80205728:</span><span class="w">   </span><span class="err">1</span><span class="nf">b4080e7</span><span class="w">            </span><span class="no">jalr</span><span class="w">    </span><span class="mi">436</span><span class="p">(</span><span class="no">ra</span><span class="p">)</span><span class="w"> </span><span class="c1"># 802078d8 &lt;swtch&gt;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="err">8020572</span><span class="nl">c:</span><span class="w">   </span><span class="err">008</span><span class="nf">ab503</span><span class="w">            </span><span class="no">ld</span><span class="w">  </span><span class="no">a0</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">s5</span><span class="p">)</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="err">80205730:</span><span class="w">   </span><span class="err">24951263</span><span class="w">            </span><span class="nf">bne</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="no">s1</span><span class="p">,</span><span class="mh">80205974</span> <span class="p">&lt;</span><span class="no">scheduler</span><span class="p">+</span><span class="mi">0x304</span><span class="p">&gt;</span>
</code></pre></div>
<p>The <code>swtch</code> function is located at address <code>802078d8</code>, with the following assembly:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nl">swtch:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="err">802078</span><span class="nl">d8:</span><span class="w">   </span><span class="err">00153023</span><span class="w">            </span><span class="nf">sd</span><span class="w">  </span><span class="no">ra</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="err">802078</span><span class="nl">dc:</span><span class="w">   </span><span class="err">00253423</span><span class="w">            </span><span class="nf">sd</span><span class="w">  </span><span class="no">sp</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="c1">// store s0 - s11, ignored.</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="err">80207910:</span><span class="w">   </span><span class="err">0005</span><span class="nf">b083</span><span class="w">            </span><span class="no">ld</span><span class="w">  </span><span class="no">ra</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="err">80207914:</span><span class="w">   </span><span class="err">0085</span><span class="nf">b103</span><span class="w">            </span><span class="no">ld</span><span class="w">  </span><span class="no">sp</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="c1">// restore s0 - s11, ignored.</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="err">80207948:</span><span class="w">   </span><span class="err">00008067</span><span class="w">            </span><span class="nf">ret</span>
</code></pre></div>
<p>At this point, the PC register points to <code>0x80205728</code>. Fill in the table below with the register or memory state changes for each subsequent instruction.</p>
<h2 id="xv6-scheduler">xv6 Scheduler<a class="headerlink" href="#xv6-scheduler" title="Permanent link">&para;</a></h2>
<p>In xv6, each CPU has its own scheduler. The <code>scheduler</code> function never returns; it runs in an infinite <code>while(1)</code> loop. Each iteration attempts to fetch a task from the queue and, if successful, switches to that process using <code>swtch</code>.</p>
<p>If no task is available, it checks if all processes have exited. If so, the system should terminate; if not, some processes may be sleeping (waiting for resources) or running on other CPUs. In this case, the <code>wfi</code> (Wait For Interrupt) instruction is used to idle the CPU until the next clock interrupt, equivalent to a <code>while(1);</code> spin loop.</p>
<p>If a process is successfully fetched, it is locked with <code>acquire(&amp;p-&gt;lock)</code>, its state is set to <code>RUNNING</code>, and the current CPU’s running process is updated (<code>c-&gt;proc = p</code>).</p>
<div class="admonition info">
<p class="admonition-title">mycpu and curr_proc</p>
<p>In a single-processor system, only one process runs on the CPU at a time, and we define a global <code>struct proc* curr_proc</code> to represent the current process. In a multi-processor system, each CPU has its own <code>curr_proc</code>, tracked via the <code>struct cpu</code> structure. A global array <code>struct cpu cpus[4]</code> represents the 4 CPUs, and the <code>tp</code> register indicates the current CPU ID via <code>cpuid()</code>, which directly reads and returns <code>tp</code>.</p>
</div>
<p>Next, the <code>swtch</code> function jumps to the saved context of the process, storing the current context in <code>cpu-&gt;sched_context</code>.</p>
<p>For the scheduler, we enforce the following rules:</p>
<ol>
<li>Process switching must go through the scheduler; Process A switches to the scheduler, then to Process B, never directly from A to B.</li>
<li>When switching to a process <code>p</code>, the CPU holds <code>p-&gt;lock</code> before leaving the scheduler, implying interrupts are disabled.</li>
<li>When switching back from process <code>p</code> to the scheduler, the CPU holds <code>p-&gt;lock</code>.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">// Scheduler never returns.  It loops, doing:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="c1">//  - choose a process to run.</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c1">//  - swtch to start running that process.</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1">//  - eventually that process transfers control</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="c1">//    via swtch back to the scheduler.</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="kt">void</span><span class="w"> </span><span class="nf">scheduler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpu</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mycpu</span><span class="p">();</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="c1">// We only get here once.</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">    </span><span class="c1">// After each cpu boots, it calls scheduler().</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">    </span><span class="c1">// If this scheduler finds any possible process to run, it will switch to it.</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">    </span><span class="c1">//  And the scheduler context is saved on &quot;mycpu()-&gt;sched_context&quot;</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span><span class="c1">// intr may be on here.</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_task</span><span class="p">();</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">            </span><span class="c1">// if we cannot find a process in the task_queue</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">            </span><span class="c1">//  maybe some processes are SLEEPING and some are RUNNABLE</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">all_dead</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">                </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;[cpu %d] scheduler dead.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cpuid</span><span class="p">);</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">                </span><span class="c1">// nothing to run; stop running on this core until an interrupt.</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="w">                </span><span class="n">intr_on</span><span class="p">();</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="w">                </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;wfi&quot;</span><span class="p">);</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="w">                </span><span class="n">intr_off</span><span class="p">();</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a><span class="w">        </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RUNNABLE</span><span class="p">);</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a><span class="w">        </span><span class="n">infof</span><span class="p">(</span><span class="s">&quot;switch to proc %d(%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a><span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RUNNING</span><span class="p">;</span>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="w">        </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">proc</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="w">        </span><span class="n">swtch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sched_context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a><span class="w">        </span><span class="c1">// When we get back here, someone must have called swtch(..., &amp;c-&gt;sched_context);</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">proc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">intr_get</span><span class="p">());</span><span class="w">        </span><span class="c1">// scheduler should never have intr_on()</span>
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">holding</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span><span class="w">  </span><span class="c1">// whoever switch to us must acquire p-&gt;lock</span>
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a><span class="w">        </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RUNNABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a><span class="w">            </span><span class="n">add_task</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a><span class="w">        </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a><span class="p">}</span>
</code></pre></div>
<p>When returning from <code>swtch(&amp;c-&gt;sched_context, &amp;p-&gt;context)</code>, we can deduce:</p>
<ol>
<li>Since <code>swtch</code> operates in pairs, our last exit via <code>swtch</code> means someone called <code>swtch(..., &amp;c-&gt;sched_context)</code> to return here.</li>
<li>This is a per-CPU scheduler, and we handed control to process <code>p</code> upon leaving, so the return must come from <code>p</code> switching back.</li>
</ol>
<p>Thus, we include three assertions to ensure the scheduler operates correctly:</p>
<ol>
<li>Interrupts must be off when <code>swtch</code> returns.</li>
<li>We must hold <code>p-&gt;lock</code>.</li>
<li>The current CPU’s running process must be <code>p</code>.</li>
</ol>
<p>Finally, we clear <code>c-&gt;proc</code>. If <code>p</code> remains <code>RUNNABLE</code>, it is requeued. After releasing <code>p-&gt;lock</code>, the scheduler proceeds to the next iteration.</p>
<h3 id="sched-function">sched Function<a class="headerlink" href="#sched-function" title="Permanent link">&para;</a></h3>
<p>The <code>sched</code> function relinquishes CPU control from the current kernel process back to the scheduler.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">// Switch to scheduler.  Must hold only p-&gt;lock</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="c1">// and have changed proc-&gt;state. Saves and restores</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="c1">// interrupt_on because interrupt_on is a property of this</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1">// kernel thread, not this CPU. It should</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="c1">// be proc-&gt;interrupt_on and proc-&gt;noff, but that would</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="c1">// break in the few places where a lock is held but</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1">// there&#39;s no process.</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sched</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">interrupt_on</span><span class="p">;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_proc</span><span class="p">();</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">holding</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;not holding p-&gt;lock&quot;</span><span class="p">);</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">noff</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;holding another locks&quot;</span><span class="p">);</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RUNNING</span><span class="p">)</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;sched running process&quot;</span><span class="p">);</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">inkernel_trap</span><span class="p">)</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;sched should never be called in kernel trap context.&quot;</span><span class="p">);</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">intr_get</span><span class="p">());</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">    </span><span class="n">interrupt_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">interrupt_on</span><span class="p">;</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="w">    </span><span class="n">infof</span><span class="p">(</span><span class="s">&quot;switch to scheduler %d(%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="w">    </span><span class="n">swtch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sched_context</span><span class="p">);</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">    </span><span class="n">infof</span><span class="p">(</span><span class="s">&quot;switch back from scheduler %d(%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="w">    </span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">interrupt_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interrupt_on</span><span class="p">;</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w">    </span><span class="c1">// if scheduler returns here: p-&gt;lock must be holding.</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">holding</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;not holding p-&gt;lock after sched.swtch returns&quot;</span><span class="p">);</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="p">}</span>
</code></pre></div>
<p>We mandate the following conditions for <code>sched</code>:</p>
<ol>
<li>The CPU must hold <code>curr_proc()-&gt;lock</code> since we’re manipulating the <code>struct proc</code>.</li>
<li>
<p>No other locks are held besides <code>curr_proc()-&gt;lock</code> to prevent kernel deadlocks.</p>
<p>This is enforced by checking <code>mycpu()-&gt;noff</code>, which increments with each <code>acquire</code> and decrements with each <code>release</code>.</p>
</li>
<li>
<p><code>p-&gt;state</code> must have been changed to a non-<code>RUNNING</code> state.</p>
</li>
<li><code>sched</code> must not be called from a kernel trap context.</li>
</ol>
<p>If these checks pass, <code>swtch</code> saves the current process state to <code>p-&gt;context</code> and jumps to the scheduler’s context (<code>&amp;mycpu()-&gt;sched_context</code>).</p>
<p>Similarly, if the scheduler switches back, it must hold <code>p-&gt;lock</code> when relinquishing CPU control.</p>
<h2 id="the-first-process-init">The First Process - init<a class="headerlink" href="#the-first-process-init" title="Permanent link">&para;</a></h2>
<p>So far, we’ve covered the Process Control Block (<code>struct proc</code>), the principles of context switching, and the scheduler’s design in xv6. Now, we’ll explore how the first process (a kernel thread) is launched in xv6.</p>
<p>In <code>main.c</code>, the <code>bootcpu_init</code> function creates the first kernel thread <code>init</code> with <code>create_kthread(init, 0x1919810);</code>, indicating that the first process will execute the <code>init()</code> function with a parameter.</p>
<p><code>create_kthread</code> allocates a PCB via <code>allocproc()</code>, initializes its <code>struct context</code> (the execution environment for its first scheduling), marks it as runnable, and adds it to the scheduler’s queue.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">create_kthread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="n">uint64</span><span class="p">),</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocproc</span><span class="p">();</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="c1">// Initialize process state</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">first_sched_ret</span><span class="p">;</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">fn</span><span class="p">;</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RUNNABLE</span><span class="p">;</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init_proc</span><span class="p">;</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span><span class="n">add_task</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="p">}</span>
</code></pre></div>
<h3 id="first-scheduling">First Scheduling<a class="headerlink" href="#first-scheduling" title="Permanent link">&para;</a></h3>
<p>When the <code>init</code> kernel thread is first scheduled, the scheduler retrieves it from the task queue and executes <code>swtch(&amp;c-&gt;sched_context, &amp;p-&gt;context)</code> (where <code>p</code> is <code>init</code>). After <code>swtch</code> executes <code>ret</code>, the CPU switches to <code>init</code>’s kernel stack (<code>p-&gt;kstack + PGSIZE</code>) and runs <code>first_sched_ret</code>. This function reads the target function and argument from the <code>s1</code> and <code>s2</code> registers, releases <code>p-&gt;lock</code> per scheduler rules, enables interrupts, and jumps to the specified function.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">first_sched_ret</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="c1">// s0: frame pointer, s1: fn, s2: uint64 arg</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="n">uint64</span><span class="p">);</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mv %0, s1&quot;</span><span class="o">:</span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">fn</span><span class="p">));</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mv %0, s2&quot;</span><span class="o">:</span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">curr_proc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="n">intr_on</span><span class="p">();</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span><span class="n">fn</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;first_sched_ret should never return. You should use exit to terminate kthread&quot;</span><span class="p">);</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="p">}</span>
</code></pre></div>
<h3 id="execution-flowchart-for-first-scheduling">Execution Flowchart for First Scheduling<a class="headerlink" href="#execution-flowchart-for-first-scheduling" title="Permanent link">&para;</a></h3>
<p><img alt="alt text" src="../../assets/xv6lab-contextswitch/xv6lab3-scheduler.png" /></p>
<h3 id="lab-exercise-2">Lab Exercise 2<a class="headerlink" href="#lab-exercise-2" title="Permanent link">&para;</a></h3>
<p><img alt="alt text" src="../../assets/xv6lab-contextswitch/xv6lab3-sched-two-proc.png" /></p>
<p>Draw a flowchart for switching between two processes, modeled after the diagram above. Assume P1 and P2 have been scheduled at least once, having exited the <code>first_sched_ret</code> phase, with their context’s <code>ra</code> pointing to the line after <code>swtch</code> in the <code>sched</code> function.</p>
<p>The flow begins at the top-left corner, where the scheduler fetches P1 from <code>fetch_task</code> and uses <code>swtch</code> to switch to the address saved in P1’s context—specifically, the line after <code>swtch</code> in P1’s <code>sched()</code> call (<code>sched() ends</code>), where P1 last switched back to the scheduler.</p>
<p>The first arrow is provided. Draw the remaining arrows based on the following steps, indicating only where each <code>swtch</code> transfers control:</p>
<ol>
<li>After switching from the scheduler to P1, P1 enters its next work loop, then calls <code>yield</code>, <code>sched</code>, and reaches the <code>swtch</code> at the top-right. Indicate where this <code>swtch</code> transfers control.</li>
<li>Control returns to the scheduler, which enters its next loop, fetches P2 from <code>fetch_task()</code>, and reaches the <code>swtch</code> at the bottom-left. Indicate where this <code>swtch</code> transfers control.</li>
<li>After switching from the scheduler to P2, P2 enters its next work loop, then calls <code>yield</code>, <code>sched</code>, and reaches the <code>swtch</code> at the bottom-right. Indicate where this <code>swtch</code> transfers control.</li>
</ol>
<h3 id="worker">worker<a class="headerlink" href="#worker" title="Permanent link">&para;</a></h3>
<p>After the first scheduling, <code>init</code> creates 8 <code>worker</code> kernel threads and adds them to the ready queue. Idle CPU cores looping in the scheduler can then fetch and execute a <code>worker</code>. Meanwhile, <code>init</code> enters a waiting state via <code>wait()</code>, freeing a CPU core. From then on, 4 CPU cores execute the 8 <code>worker</code> threads.</p>
<p>These 8 <code>worker</code> threads increment the shared variable <code>count</code>, calling <code>yield</code> every 1000 increments. A <code>worker</code> calling <code>yield</code> relinquishes its CPU core, which then schedules the next ready process. A related assignment will later deepen our understanding of this process.</p>
<h2 id="reading">Reading<a class="headerlink" href="#reading" title="Permanent link">&para;</a></h2>
<h3 id="disabling-interrupts">Disabling Interrupts<a class="headerlink" href="#disabling-interrupts" title="Permanent link">&para;</a></h3>
<p>In kernel code, we sometimes want execution to proceed without interruption or preemption by other tasks. This can be achieved by disabling interrupts (though exceptions still jump to the trap handler).</p>
<p>We use <code>push_off()</code> and <code>pop_off()</code> as a pair to disable and enable interrupts. Since <code>push_off</code> calls may be nested, we treat disabling interrupts as a stack-like operation, restoring interrupts only when the stack is empty. Two variables are tracked in <code>struct cpu</code>:</p>
<ol>
<li>
<p><code>noff</code>: The current depth of <code>push_off</code>/<code>pop_off</code>.</p>
<p>For example, after <code>push_off()</code>, <code>push_off()</code>, <code>pop_off()</code>, <code>noff</code> should be 1.</p>
</li>
<li>
<p><code>interrupt_on</code>: Whether interrupts were enabled when <code>noff == 0</code>, i.e., before the first <code>push_off</code>.</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">push_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_ra</span><span class="p">();</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intr_get</span><span class="p">();</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="n">intr_off</span><span class="p">();</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">noff</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">        </span><span class="c1">// warnf(&quot;intr on saved: %p&quot;, ra);</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">        </span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">interrupt_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="n">mycpu</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">noff</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="p">}</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="kt">void</span><span class="w"> </span><span class="nf">pop_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_ra</span><span class="p">();</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpu</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mycpu</span><span class="p">();</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intr_get</span><span class="p">())</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;pop_off - interruptible&quot;</span><span class="p">);</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">noff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;pop_off - unpair&quot;</span><span class="p">);</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">    </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">noff</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">noff</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">interrupt_on</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inkernel_trap</span><span class="p">)</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="w">            </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;pop_off-&gt;intr_on happens in kernel trap&quot;</span><span class="p">);</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="w">        </span><span class="c1">// We only open the interrupt if:</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">        </span><span class="c1">//    1. the push-pop stack is cleared, and</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="w">        </span><span class="c1">//    2. the interrupt was on before the first push-off</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="w">        </span><span class="n">intr_on</span><span class="p">();</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="p">}</span>
</code></pre></div>
<h3 id="why-save-cpu-interrupt_on">Why Save <code>cpu-&gt;interrupt_on</code>?<a class="headerlink" href="#why-save-cpu-interrupt_on" title="Permanent link">&para;</a></h3>
<p>This attribute pertains to the current kernel thread, not the CPU itself. Since <code>push_off</code>/<code>pop_off</code> may be used without a process context, we store <code>interrupt_on</code> in <code>struct cpu</code> rather than <code>struct proc</code>. During <code>sched</code>-based kernel thread switches, this attribute is preserved on the kernel thread’s stack.</p>
<p>We don’t need to save <code>noff</code> because we enforce it to be 1.</p>
<p>If we omit saving <code>interrupt_on</code>, the diagram below shows how Kernel Process 1’s (red) interrupt state erroneously affects Kernel Process 2 (yellow) via <code>sched</code> and the scheduler (blue):</p>
<p>Kernel Process 2 runs with interrupts off, then calls <code>sched</code> and pauses (dashed line). Kernel Process 1 begins with interrupts on (solid line). When P1 calls <code>sched</code> to switch to the scheduler, <code>acquire-&gt;push_off</code> saves the interrupt state to <code>cpu-&gt;interrupt_on</code>. The scheduler then resumes P2, which calls <code>release-&gt;pop_off</code>, incorrectly restoring interrupts to on. For P2, this violates the context switching rule that the execution context remains unchanged, as it resumes with interrupts on despite having them off before the switch.</p>
<p><img alt="alt text" src="../../assets/xv6lab-contextswitch/kernel-intron.png" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-copyright">
    <div class="md-copyright__highlight">
        commit: 
        <a href="https://github.com/yuk1i/os-next-docs/commit/abe38553, 2025-03-31 03:00:41+08:00" target="_blank" rel="noopener">
            abe38553, 2025-03-31 03:00:41+08:00
        </a>
    </div>
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>